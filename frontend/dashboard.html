<div class="dashboard-grid">
    <div class="card">
        <div class="card-content">
            <h2>Team-Auswahl</h2>
            <p style="opacity: 0.8; font-size: 0.9em;">Wähle das Team aus, das du aktuell bearbeiten möchtest.</p>
            <div id="team-list" style="margin-top: 15px;">
                <p style="opacity: 0.6;">Lade Mannschaften...</p>
            </div>
            <p id="selected-team-info" style="margin-top: 15px; font-weight: bold; color: #ffcc00;"></p>
        </div>
    </div>
    
    <div class="card">
        <div class="card-content">
            <h2>Spielplan & Protokoll (Nächste 14 Tage)</h2>
            <h3><span id="gameplan-team-name" style="color: #ffcc00;">(Team wählen)</span></h3>
            <p style="opacity: 0.8; font-size: 0.9em;">Wähle ein Spiel aus, um das Live-Protokoll zu starten.</p>
            <div id="game-list-container" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
                <p style="opacity: 0.6;">Wählen Sie eine Mannschaft aus.</p>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Lokale Variablen ---
    var selectedTeamId = localStorage.getItem('selected_team_id');
    var selectedTeamName = localStorage.getItem('selected_team_name');

    // --- DOM-Elemente ---
    const teamListDiv = document.getElementById('team-list');
    const selectedTeamInfo = document.getElementById('selected-team-info');
    const gameplanTeamName = document.getElementById('gameplan-team-name');
    const gameListContainer = document.getElementById('game-list-container');
    
    // --- Dashboard Logik ---
    
    function selectTeam(teamId, teamName) {
        selectedTeamId = teamId;
        selectedTeamName = teamName;
        
        document.querySelectorAll('.team-list-item').forEach(item => {
            item.classList.remove('selected');
        });
        const selectedElement = document.getElementById(`team-${teamId}`);
        if (selectedElement) {
             selectedElement.classList.add('selected');
        }
       
        selectedTeamInfo.textContent = `Ausgewählt: ${teamName}`;
        gameplanTeamName.textContent = teamName;
        
        localStorage.setItem('selected_team_id', teamId);
        localStorage.setItem('selected_team_name', teamName);
        
        // WICHTIG: Übergibt 'dashboard', um die Liste zu filtern
        if (typeof loadGames === 'function') {
            loadGames(teamId, 'dashboard');
        } else {
             gameListContainer.innerHTML = `<p style="opacity: 0.6;">Lade Spielplan...</p>`;
        }
    }
    
    async function loadTeams() {
        try {
            const response = await fetch('/teams/list', {
                method: 'GET'
            });

            if (response.status === 401 || response.status === 403) { 
                if(typeof logout === 'function') {
                    logout(); 
                } else {
                    window.location.href = "/";
                }
                return; 
            }
            if (!response.ok) {
                 throw new Error(`FEHLER beim Laden der Teams. Status: ${response.status}`);
            }

            const teams = await response.json();
            teamListDiv.innerHTML = ''; 
            
            if (teams.length === 0) {
                teamListDiv.innerHTML = '<p style="opacity: 0.6;">Keine Teams vorhanden. Bitte im "Team Management" ein Team erstellen.</p>';
                gameplanTeamName.textContent = "(Kein Team erstellt)";
                gameListContainer.innerHTML = '<p style="opacity: 0.6;">Bitte zuerst ein Team erstellen.</p>';
                return;
            }
            
            let initialTeamToSelect = null;
            
            teams.forEach(team => {
                const teamItem = document.createElement('div');
                teamItem.className = 'team-list-item';
                teamItem.id = `team-${team.id}`;
                teamItem.innerHTML = `
                    <span><strong>${team.name}</strong> (${team.league})</span>
                `;
                teamItem.addEventListener('click', () => {
                    selectTeam(team.id, team.name);
                });
                teamListDiv.appendChild(teamItem);
                
                if (team.id === parseInt(selectedTeamId)) {
                    initialTeamToSelect = team;
                }
            });
            
            if (initialTeamToSelect) {
                selectTeam(initialTeamToSelect.id, initialTeamToSelect.name);
            } else if (teams.length > 0) {
                selectTeam(teams[0].id, teams[0].name);
            }

        } catch (error) {
            console.error('Kritischer Fehler beim Laden der Teams:', error);
            teamListDiv.innerHTML = `<p class="error">FEHLER beim Laden der Teams: ${error.message || 'Netzwerkfehler'}</p>`;
        }
    }

    // --- Initialisierung ---
    function initDashboard() {
        console.log("initDashboard() wird aufgerufen.");
        loadTeams();
    }
    
    document.addEventListener('DOMContentLoaded', initDashboard);
</script>

<script src="/static/game_planning.js"></script>