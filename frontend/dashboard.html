<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>{{ title }}</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: linear-gradient(120deg, #1e3c72, #2a5298);
      color: white;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      margin: 0;
      padding-top: 50px;
      flex-direction: column;
      text-align: center;
      width: 100%;
    }
    .header {
      background: rgba(255, 255, 255, 0.1);
      padding: 20px 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 1400px; 
      margin: 0 auto 30px auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    /* Layout obere Reihe */
    .dashboard-layout {
        width: 90%;
        max-width: 1400px; 
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr; /* 3 Spalten */
        gap: 20px;
    }
    /* Layout untere Reihe */
    .detail-area {
        width: 90%;
        max-width: 1400px; 
        margin: 30px auto 0 auto;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr; /* 4 Spalten */
        gap: 20px;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.15);
      padding: 20px;
      border-radius: 10px;
      text-align: left;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .card-content {
        flex-grow: 1;
    }
    
    h1 { color: #ffcc00; font-size: 2em; margin: 0; }
    .greeting { font-size: 1em; margin-top: 5px; }
    h2 { margin-top: 0; }
    h3 { color: #ffcc00; margin-top: 0; margin-bottom: 10px; }
    
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      font-size: 0.9em;
      cursor: pointer;
      transition: 0.2s;
    }
    .btn-logout { background: #ff6666; color: white; }
    .btn-primary { background: #38E838; color: #1e3c72; margin-top: 10px; }
    .btn-delete {
        background: transparent; color: #ff6666;
        padding: 5px 10px; font-weight: bold;
        margin: 0; margin-left: 10px;
    }
    .btn-protocol { 
        background: #00bcd4; color: white;
        padding: 5px 10px; margin-left: 10px;
    }
    
    /* Allgemeine Formular-Stile */
    input[type="text"], input[type="number"], input[type="datetime-local"], select {
      width: calc(100% - 16px); /* Anpassung f√ºr Padding */
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box; /* Wichtig */
    }
    label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    
    .team-list-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 10px; margin-bottom: 8px; border-radius: 4px;
        display: flex; justify-content: space-between; align-items: center;
        cursor: pointer; transition: background-color 0.2s;
    }
    .team-list-item:hover { background: rgba(255, 255, 255, 0.2); }
    .team-list-item.selected {
        background: #ffcc00; color: #1e3c72; font-weight: bold;
    }
    
    .player-list-item, .custom-action-list-item {
        background: rgba(255, 255, 255, 0.05);
        padding: 8px; margin-bottom: 4px; border-radius: 4px;
        display: flex; justify-content: space-between; align-items: center;
        font-size: 0.9em; width: 100%;
    }
    
    /* --- Spielplan-Liste --- */
    .game-list-header {
        color: #ffcc00;
        font-size: 1.1em;
        font-weight: bold;
        border-bottom: 1px solid #ffcc00;
        padding-bottom: 5px;
        margin-top: 15px;
        margin-bottom: 10px;
    }
    .game-list-item {
        background: rgba(255, 255, 255, 0.05);
        padding: 8px; margin-bottom: 4px; border-radius: 4px;
        display: flex;
        flex-direction: row;
        align-items: center;
        font-size: 0.9em;
    }
    .game-info {
        display: flex; flex-direction: column;
        align-items: flex-start; flex-grow: 1;
    }
    .game-info span { margin-bottom: 3px; }
    .game-actions { display: flex; gap: 5px; }
    
    /* --- NEU: Spiel anlegen Kachel --- */
    .game-category-tabs {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 2px;
        margin-bottom: 20px;
    }
    .tab-button {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 10px 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: bold;
        text-align: center;
    }
    .tab-button.active {
        background: #ffcc00;
        color: #1e3c72;
    }
    .tab-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .form-section {
        display: none; /* Alle Sektionen standardm√§√üig ausblenden */
    }
    .form-section.active {
        display: block; /* Nur die aktive Sektion anzeigen */
    }
    
    #new-tournament-group {
        display: none; /* Standardm√§√üig ausgeblendet */
        margin-top: 10px;
        border-top: 1px solid rgba(255,255,255,0.2);
        padding-top: 10px;
    }
    /* --- Ende: Spiel anlegen Kachel --- */

    .message { margin-top: 10px; font-weight: bold; }
    .success { color: #38E838; }
    .error { color: #FF6666; }
    
    .verification-warning {
        width: 90%; max-width: 800px;
        margin: 50px auto; padding: 30px;
        background: #ffcc00; color: #333;
        border-radius: 10px; font-size: 1.2em;
        text-align: center;
    }
    .btn-reload {
        background: #1e3c72; color: white;
        padding: 10px 20px; margin-top: 15px;
        font-weight: bold; border: none;
        border-radius: 5px; cursor: pointer;
    }
  </style>
</head>
<body>

  <div class="header">
    <div>
        <h1>Dashboard üìä</h1>
        <p class="greeting">Angemeldet als: **{{ trainer_name }}**</p>
    </div>
    <button onclick="logout()" class="btn-logout">Logout</button>
  </div>
  
  {% if not is_verified %}
  <div id="verification-notice" class="verification-warning">
    <p>‚ö†Ô∏è **Dein Account ist noch nicht verifiziert!**</p>
    <p>Um Mannschaften, Spieler oder Spiele anzulegen, musst du deine E-Mail-Adresse best√§tigen.</p>
    <p>Bitte √ºberpr√ºfe dein Postfach (oder klicke auf **Token abrufen**).</p>
    <button onclick="window.location.reload()" class="btn-reload">‚úÖ Jetzt neu laden / Status pr√ºfen</button>
  </div>
  {% endif %}


  <div id="app-features" {% if not is_verified %}style="display:none;"{% endif %}>

  <!-- OBERE REIHE -->
  <div class="dashboard-layout">
    
    <div class="card">
      <div class="card-content">
        <h2>Mannschaft hinzuf√ºgen</h2>
        <form id="add-team-form">
            <label for="team-name">Name der Mannschaft:</label>
            <input type="text" id="team-name" required><br>
            <label for="team-league">Spielklasse / Liga:</label>
            <select id="team-league" required>
                <option value="" disabled selected>W√§hlen Sie eine Klasse</option>
                {% for league in leagues %}
                    <option value="{{ league }}">{{ league }}</option>
                {% endfor %}
            </select><br>
            <button type="submit" class="btn-primary">Mannschaft erstellen</button>
        </form>
        <div id="team-message" class="message"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-content">
        <h2>Meine Mannschaften (Auswahl)</h2>
        <div id="team-list">
            <p style="opacity: 0.6;">Lade Mannschaften...</p>
        </div>
        <p id="selected-team-info" style="margin-top: 15px; font-weight: bold; color: #ffcc00;"></p>
      </div>
    </div>

    <div class="card">
      <div class="card-content">
        <h2>Spieler hinzuf√ºgen</h2>
        <form id="add-player-form">
            <label for="player-name">Name:</label>
            <input type="text" id="player-name" required><br>
            <label for="player-number">Trikotnummer (optional):</label>
            <input type="number" id="player-number" min="1" max="99"><br>
            <label for="player-position">Position (optional):</label>
            <select id="player-position">
                <option value="">(Keine Position)</option>
                {% for position in positions %}
                    <option value="{{ position }}">{{ position }}</option>
                {% endfor %}
            </select><br>
            <button type="submit" class="btn-primary" id="add-player-button" disabled>Spieler hinzuf√ºgen</button>
        </form>
        <div id="player-message" class="message"></div>
      </div>
    </div>
  </div>
  
  <!-- UNTERE REIHE -->
  <div class="detail-area">
    <div class="card" style="grid-column: span 1;">
      <div class="card-content">
        <h2>Kader √úbersicht</h2>
        <h3><span id="kader-team-name" style="color: #ffcc00;">(Team w√§hlen)</span></h3>
        <div id="player-list-container">
            <p style="opacity: 0.6;">W√§hlen Sie eine Mannschaft aus.</p>
        </div>
      </div>
    </div>
    
    <div class="card" style="grid-column: span 1;">
      <div class="card-content">
        <h2>Spiel anlegen</h2>
        
        <div class="game-category-tabs">
            <button class="tab-button" id="tab-btn-saison" onclick="switchGameCategory('Saison')" disabled>Saison</button>
            <button class="tab-button active" id="tab-btn-testspiel" onclick="switchGameCategory('Testspiel')" disabled>Testspiel</button>
            <button class="tab-button" id="tab-btn-turnier" onclick="switchGameCategory('Turnier')" disabled>Turnier</button>
        </div>
        
        <form id="add-game-form">
            <input type="hidden" id="active-game-category" value="Testspiel">
            
            <div class="form-section active" id="common-game-fields">
                <label for="game-opponent">Gegner:</label>
                <input type="text" id="game-opponent" required>
                <label for="game-date">Datum & Uhrzeit:</label>
                <input type="datetime-local" id="game-date" required>
            </div>

            <div class="form-section" id="tournament-game-fields">
                 <label for="tournament-select">Turnier ausw√§hlen:</label>
                 <select id="tournament-select">
                     <option value="" disabled selected>Lade Turniere...</option>
                 </select>
                 
                 <div id="new-tournament-group">
                     <label for="new-tournament-name">Neuer Turniername:</label>
                     <input type="text" id="new-tournament-name">
                 </div>
            </div>

            <button type="submit" class="btn-primary" id="add-game-button" disabled>Spiel erstellen</button>
        </form>
        <div id="game-message" class="message"></div>
        
      </div>
    </div>
    
    <div class="card" style="grid-column: span 1;">
      <div class="card-content">
        <h2>Spielplan</h2>
        <h3><span id="gameplan-team-name" style="color: #ffcc00;">(Team w√§hlen)</span></h3>
        <div id="game-list-container" style="max-height: 400px; overflow-y: auto;">
            <p style="opacity: 0.6;">W√§hlen Sie eine Mannschaft aus.</p>
        </div>
      </div>
    </div>
    
    <div class="card" style="grid-column: span 1;">
      <div class="card-content">
        <h2>Aktionen</h2>
        <h3><span id="custom-action-team-name" style="color: #ffcc00;">(Team w√§hlen)</span></h3>
        <form id="add-custom-action-form">
            <label for="custom-action-name">Name der Aktion:</label>
            <input type="text" id="custom-action-name" required><br>
            <label for="custom-action-category">Kategorie:</label>
            <select id="custom-action-category">
                {% for category in action_categories %}
                    <option value="{{ category }}">{{ category }}</option>
                {% endfor %}
            </select><br>
            <button type="submit" class="btn-primary" id="add-custom-action-button" disabled>Aktion erstellen</button>
        </form>
        <div id="custom-action-message" class="message"></div>
        <hr style="border-color: rgba(255,255,255,0.2); margin: 20px 0;">
        <div id="custom-action-list-container">
             <p style="opacity: 0.6;">W√§hlen Sie ein Team.</p>
        </div>
      </div>
    </div>
  </div>
  </div> 
  
  <script>
    // --- Globale Logout Funktion ---
    function logout() {
      localStorage.removeItem('access_token');
      window.location.href = "/"; 
    }
    
    // F√ºhre die Logik nur aus, wenn der Trainer verifiziert ist
    {% if is_verified %} 
    
    let selectedTeamId = null;
    let selectedTeamName = "";

    // DOM Elemente (aktualisiert)
    const teamListDiv = document.getElementById('team-list');
    const teamMessageDiv = document.getElementById('team-message');
    const playerMessageDiv = document.getElementById('player-message');
    const playerListContainer = document.getElementById('player-list-container');
    const gameListContainer = document.getElementById('game-list-container');
    const selectedTeamInfo = document.getElementById('selected-team-info');
    const kaderTeamName = document.getElementById('kader-team-name');
    const gameplanTeamName = document.getElementById('gameplan-team-name');
    const customActionTeamName = document.getElementById('custom-action-team-name');
    const addPlayerButton = document.getElementById('add-player-button');
    const addGameButton = document.getElementById('add-game-button');
    const addCustomActionButton = document.getElementById('add-custom-action-button');
    const gameMessageDiv = document.getElementById('game-message');
    const customActionMessageDiv = document.getElementById('custom-action-message');
    const customActionListContainer = document.getElementById('custom-action-list-container');
    const addCustomActionForm = document.getElementById('add-custom-action-form');
    
    // NEU: DOM Elemente f√ºr "Spiel anlegen"
    const tabBtnSaison = document.getElementById('tab-btn-saison');
    const tabBtnTestspiel = document.getElementById('tab-btn-testspiel');
    const tabBtnTurnier = document.getElementById('tab-btn-turnier');
    const activeGameCategoryInput = document.getElementById('active-game-category');
    const tournamentGameFields = document.getElementById('tournament-game-fields');
    const tournamentSelect = document.getElementById('tournament-select');
    const newTournamentGroup = document.getElementById('new-tournament-group');

    function getToken() {
        return localStorage.getItem('access_token');
    }
    
    // --- KORRIGIERTE Logik f√ºr "Spiel anlegen" Tabs ---
    function switchGameCategory(category) {
        activeGameCategoryInput.value = category;

        [tabBtnSaison, tabBtnTestspiel, tabBtnTurnier].forEach(btn => btn.classList.remove('active'));
        if (category === 'Saison') tabBtnSaison.classList.add('active');
        if (category === 'Testspiel') tabBtnTestspiel.classList.add('active');
        if (category === 'Turnier') tabBtnTurnier.classList.add('active');

        // --- KORREKTUR START ---
        // Die Logik hier wurde vereinfacht und korrigiert
        if (category === 'Turnier') {
            tournamentGameFields.style.display = 'block';
            // Pr√ºfe den *aktuellen* Dropdown-Status, anstatt ihn zur√ºckzusetzen
            if (tournamentSelect.value === 'NEW') {
                newTournamentGroup.style.display = 'block';
            } else {
                newTournamentGroup.style.display = 'none';
            }
        } else {
            tournamentGameFields.style.display = 'none';
            // Verstecke auch die Turnier-spezifischen Unter-Felder
            newTournamentGroup.style.display = 'none';
        }
        // --- KORREKTUR ENDE ---
    }
    
    // Event Listener f√ºr das Turnier-Dropdown
    tournamentSelect.addEventListener('change', function() {
        if (this.value === 'NEW') {
            newTournamentGroup.style.display = 'block';
        } else {
            newTournamentGroup.style.display = 'none';
        }
    });

    // --- Team-Logik (Angepasst) ---
    function selectTeam(teamId, teamName) {
        selectedTeamId = teamId;
        selectedTeamName = teamName;

        document.querySelectorAll('.team-list-item').forEach(item => {
            item.classList.remove('selected');
        });
        document.getElementById(`team-${teamId}`).classList.add('selected');
        
        selectedTeamInfo.textContent = `Ausgew√§hlt: ${teamName}`;
        kaderTeamName.textContent = teamName;
        gameplanTeamName.textContent = teamName;
        customActionTeamName.textContent = teamName;
        
        addPlayerButton.disabled = false;
        addGameButton.disabled = false;
        addCustomActionButton.disabled = false;
        [tabBtnSaison, tabBtnTestspiel, tabBtnTurnier].forEach(btn => btn.disabled = false);

        loadPlayers(teamId);
        loadGames(teamId);
        loadCustomActions(teamId);
        loadTournaments(teamId); // NEU
    }
    
    async function loadTeams() {
        const token = getToken();
        if (!token) { teamListDiv.innerHTML = '<p class="error">Token fehlt.</p>'; return; }

        try {
            const response = await fetch('/teams/list', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.status === 401 || response.status === 403) { logout(); }
            if (!response.ok) throw new Error('Netzwerkfehler beim Laden der Teams.');

            const teams = await response.json();
            teamListDiv.innerHTML = '';
            
            selectedTeamId = null;
            selectedTeamInfo.textContent = "";
            kaderTeamName.textContent = "(Team w√§hlen)";
            gameplanTeamName.textContent = "(Team w√§hlen)";
            customActionTeamName.textContent = "(Team w√§hlen)";
            addPlayerButton.disabled = true;
            addGameButton.disabled = true;
            addCustomActionButton.disabled = true;
            [tabBtnSaison, tabBtnTestspiel, tabBtnTurnier].forEach(btn => btn.disabled = true);
            
            playerListContainer.innerHTML = '<p style="opacity: 0.6;">W√§hlen Sie eine Mannschaft aus.</p>';
            gameListContainer.innerHTML = '<p style="opacity: 0.6;">W√§hlen Sie eine Mannschaft aus.</p>';
            customActionListContainer.innerHTML = '<p style="opacity: 0.6;">W√§hlen Sie eine Mannschaft aus.</p>';
            tournamentSelect.innerHTML = '<option value="" disabled selected>Team w√§hlen...</option>';

            if (teams.length === 0) {
                teamListDiv.innerHTML = '<p style="opacity: 0.6;">Noch keine Mannschaften vorhanden.</p>';
                return;
            }

            teams.forEach(team => {
                const teamItem = document.createElement('div');
                teamItem.className = 'team-list-item';
                teamItem.id = `team-${team.id}`;
                teamItem.innerHTML = `<span><strong>${team.name}</strong> (${team.league})</span>`;
                teamItem.addEventListener('click', () => selectTeam(team.id, team.name));
                teamListDiv.appendChild(teamItem);
            });

        } catch (error) {
            console.error('Fehler beim Laden der Teams:', error);
            teamListDiv.innerHTML = `<p class="error">FEHLER beim Laden der Teams.</p>`;
        }
    }
    
    document.getElementById('add-team-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        const name = document.getElementById('team-name').value;
        const league = document.getElementById('team-league').value;
        const token = getToken();
        if (!token) { /* ... */ return; }
        teamMessageDiv.textContent = 'Erstelle Mannschaft...';
        teamMessageDiv.className = 'message';
        try {
            const response = await fetch('/teams/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ name, league }),
            });
            const data = await response.json();
            if (response.ok) {
                teamMessageDiv.textContent = `‚úÖ Mannschaft "${name}" erfolgreich erstellt.`;
                teamMessageDiv.className = 'message success';
                document.getElementById('add-team-form').reset();
                loadTeams(); 
            } else if (response.status === 401 || response.status === 403) {
                logout();
            } else {
                teamMessageDiv.textContent = `‚ùå Fehler: ${data.detail || 'Unbekannter Fehler'}`;
                teamMessageDiv.className = 'message error';
            }
        } catch (error) {
            teamMessageDiv.textContent = '‚ùå Serverfehler beim Erstellen der Mannschaft.';
            teamMessageDiv.className = 'message error';
        }
    });

    // --- Spieler-Logik (Unver√§ndert) ---
    async function deletePlayer(playerId) {
        if (!confirm("Sind Sie sicher, dass Sie diesen Spieler l√∂schen m√∂chten?")) return;
        const token = getToken();
        if (!token) return logout();
        try {
            const response = await fetch(`/players/delete/${playerId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                playerMessageDiv.textContent = `‚úÖ Spieler erfolgreich gel√∂scht.`;
                playerMessageDiv.className = 'message success';
                loadPlayers(selectedTeamId);
            } else {
                const data = await response.json();
                playerMessageDiv.textContent = `‚ùå Fehler beim L√∂schen: ${data.detail || 'Unbekannt.'}`;
                playerMessageDiv.className = 'message error';
            }
        } catch (error) {
            playerMessageDiv.textContent = '‚ùå Serverfehler beim L√∂schen des Spielers.';
            playerMessageDiv.className = 'message error';
        }
    }
    document.getElementById('add-player-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        if (!selectedTeamId) {
            playerMessageDiv.textContent = '‚ùå Bitte zuerst eine Mannschaft ausw√§hlen.';
            playerMessageDiv.className = 'message error';
            return;
        }
        const name = document.getElementById('player-name').value;
        const number = document.getElementById('player-number').value ? parseInt(document.getElementById('player-number').value) : null; 
        const position = document.getElementById('player-position').value;
        const token = getToken();
        playerMessageDiv.textContent = `F√ºge Spieler zu ${selectedTeamName} hinzu...`;
        playerMessageDiv.className = 'message';
        const payload = {
            name: name, number: number,
            position: position || null, team_id: selectedTeamId 
        };
        try {
            const response = await fetch('/players/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(payload),
            });
            const data = await response.json();
            if (response.ok) {
                playerMessageDiv.textContent = `‚úÖ Spieler "${name}" erfolgreich hinzugef√ºgt.`;
                playerMessageDiv.className = 'message success';
                document.getElementById('add-player-form').reset();
                loadPlayers(selectedTeamId); 
            } else {
                playerMessageDiv.textContent = `‚ùå Fehler: ${data.detail || 'Unbekannter Fehler'}`;
                playerMessageDiv.className = 'message error';
            }
        } catch (error) {
            playerMessageDiv.textContent = '‚ùå Serverfehler beim Erstellen des Spielers.';
            playerMessageDiv.className = 'message error';
        }
    });
    async function loadPlayers(teamId) {
        const token = getToken();
        if (!token) return;
        playerListContainer.innerHTML = `<p style="opacity: 0.6;">Lade Kader...</p>`;
        try {
            const response = await fetch(`/players/list/${teamId}`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const players = await response.json();
            playerListContainer.innerHTML = '';
            if (players.length === 0) {
                playerListContainer.innerHTML = `<p style="opacity: 0.6;">Keine Spieler im Kader.</p>`;
                return;
            }
            players.forEach(player => {
                const playerItem = document.createElement('div');
                playerItem.className = 'player-list-item';
                const numberDisplay = player.number !== null ? `#${player.number}` : '';
                const positionDisplay = player.position ? ` (${player.position})` : '';
                playerItem.innerHTML = `
                    <span>${numberDisplay} <strong>${player.name}</strong>${positionDisplay}</span>
                    <button class="btn-delete" onclick="deletePlayer(${player.id})">L√∂schen</button>
                `;
                playerListContainer.appendChild(playerItem);
            });
        } catch (error) {
            playerListContainer.innerHTML = `<p class="error">Fehler beim Laden des Kaders.</p>`;
        }
    }
    
    // --- Spiel-Logik (Angepasst) ---

    async function deleteGame(gameId) {
        if (!confirm("Sind Sie sicher, dass Sie dieses Spiel l√∂schen m√∂chten?")) return;
        const token = getToken();
        if (!token) return logout();
        try {
            const response = await fetch(`/games/delete/${gameId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                gameMessageDiv.textContent = `‚úÖ Spiel erfolgreich gel√∂scht.`;
                gameMessageDiv.className = 'message success';
                loadGames(selectedTeamId); 
            } else {
                const data = await response.json();
                gameMessageDiv.textContent = `‚ùå Fehler beim L√∂schen: ${data.detail || 'Unbekannt.'}`;
                gameMessageDiv.className = 'message error';
            }
        } catch (error) {
            gameMessageDiv.textContent = '‚ùå Serverfehler beim L√∂schen des Spiels.';
            gameMessageDiv.className = 'message error';
        }
    }

    document.getElementById('add-game-form').addEventListener('submit', async function(event) {
        event.preventDefault();

        if (!selectedTeamId) {
            gameMessageDiv.textContent = '‚ùå Bitte zuerst eine Mannschaft ausw√§hlen.';
            gameMessageDiv.className = 'message error';
            return;
        }

        const opponent = document.getElementById('game-opponent').value;
        const date = document.getElementById('game-date').value;
        const token = getToken();
        
        const category = activeGameCategoryInput.value;
        let tournamentName = null;

        if (category === "Turnier") {
            const selectedTournament = tournamentSelect.value;
            if (selectedTournament === "NEW") {
                tournamentName = document.getElementById('new-tournament-name').value;
                if (!tournamentName) {
                    gameMessageDiv.textContent = '‚ùå Bitte einen Namen f√ºr das neue Turnier eingeben.';
                    gameMessageDiv.className = 'message error';
                    return;
                }
            } else if (!selectedTournament) {
                 gameMessageDiv.textContent = '‚ùå Bitte ein Turnier ausw√§hlen oder ein neues anlegen.';
                 gameMessageDiv.className = 'message error';
                 return;
            } else {
                tournamentName = selectedTournament;
            }
        }

        gameMessageDiv.textContent = `Erstelle Spiel gegen ${opponent}...`;
        gameMessageDiv.className = 'message';
        
        const payload = {
            opponent: opponent,
            date: date,
            team_id: selectedTeamId,
            game_category: category,
            tournament_name: tournamentName
        };

        try {
            const response = await fetch('/games/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(payload),
            });
            const data = await response.json();
            if (response.ok) {
                gameMessageDiv.textContent = `‚úÖ Spiel gegen "${opponent}" erfolgreich angelegt.`;
                gameMessageDiv.className = 'message success';
                document.getElementById('add-game-form').reset();
                switchGameCategory('Testspiel'); // Setze auf Standard zur√ºck
                loadGames(selectedTeamId);
                if (category === "Turnier") {
                    loadTournaments(selectedTeamId); // Lade Turnierliste neu
                }
            } else if (response.status === 401 || response.status === 403) {
                logout();
            } else {
                gameMessageDiv.textContent = `‚ùå Fehler: ${data.detail || 'Unbekannter Fehler'}`;
                gameMessageDiv.className = 'message error';
            }
        } catch (error) {
            gameMessageDiv.textContent = '‚ùå Serverfehler beim Erstellen des Spiels.';
            gameMessageDiv.className = 'message error';
        }
    });

    function startProtocol(gameId) {
        localStorage.setItem('protocol_game_id', gameId);
        window.location.href = `/app/protocol/${gameId}`; 
    }

    async function loadGames(teamId) {
        const token = getToken();
        if (!token) return;

        gameListContainer.innerHTML = `<p style="opacity: 0.6;">Lade Spielplan...</p>`;
        try {
            const response = await fetch(`/games/list/${teamId}`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const games = await response.json();
            gameListContainer.innerHTML = '';
            
            if (games.length === 0) {
                gameListContainer.innerHTML = `<p style="opacity: 0.6;">Keine Spiele angelegt.</p>`;
                return;
            }

            const saisonGames = games.filter(g => g.game_category === 'Saison');
            const testGames = games.filter(g => g.game_category === 'Testspiel');
            const tournamentGames = games.filter(g => g.game_category === 'Turnier');
            
            const tournaments = {};
            tournamentGames.forEach(game => {
                const tourName = game.tournament_name || 'Unbenanntes Turnier';
                if (!tournaments[tourName]) {
                    tournaments[tourName] = [];
                }
                tournaments[tourName].push(game);
            });

            const renderGameList = (gameList) => {
                let html = '';
                gameList.forEach(game => {
                    const dateObj = new Date(game.date);
                    const formattedDate = dateObj.toLocaleDateString('de-DE', {
                        year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                    });
                    html += `
                        <div class="game-list-item">
                            <div class="game-info">
                                <span>üìÖ <strong>${formattedDate}</strong></span>
                                <span>vs. ${game.opponent}</span>
                            </div>
                            <div class="game-actions">
                                <button class="btn-protocol" onclick="startProtocol(${game.id})">Protokoll</button>
                                <button class="btn-delete" onclick="deleteGame(${game.id})">L√∂schen</button>
                            </div>
                        </div>
                    `;
                });
                return html;
            };

            let finalHtml = '';
            if (saisonGames.length > 0) {
                finalHtml += '<h3 class="game-list-header">Saison (Liga)</h3>';
                finalHtml += renderGameList(saisonGames);
            }
            if (testGames.length > 0) {
                finalHtml += '<h3 class="game-list-header">Testspiele</h3>';
                finalHtml += renderGameList(testGames);
            }
            if (Object.keys(tournaments).length > 0) {
                finalHtml += '<h3 class="game-list-header">Turniere</h3>';
                for (const tourName in tournaments) {
                    finalHtml += `<h4 style="margin: 10px 0 5px 5px; color: #ddd;">${tourName}</h4>`;
                    finalHtml += renderGameList(tournaments[tourName]);
                }
            }
            gameListContainer.innerHTML = finalHtml;

        } catch (error) {
            gameListContainer.innerHTML = `<p class="error">Fehler beim Laden des Spielplans.</p>`;
        }
    }
    
    // --- NEU: TURNIER-DROPDOWN LADEN ---
    async function loadTournaments(teamId) {
        const token = getToken();
        if (!token) return;
        
        tournamentSelect.innerHTML = '<option value="" disabled selected>Lade Turniere...</option>';
        
        try {
            const response = await fetch(`/games/tournaments/${teamId}`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!response.ok) throw new Error('Turniere konnten nicht geladen werden.');
            
            const tournaments = await response.json();
            
            tournamentSelect.innerHTML = '';
            
            if (tournaments.length > 0) {
                tournaments.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    tournamentSelect.appendChild(option);
                });
            }
            
            const newOption = document.createElement('option');
            newOption.value = 'NEW';
            newOption.textContent = '[ Neues Turnier anlegen ]';
            tournamentSelect.appendChild(newOption);
            
            if (tournaments.length > 0) {
                 tournamentSelect.selectedIndex = 0;
            } else {
                tournamentSelect.value = 'NEW';
            }
            tournamentSelect.dispatchEvent(new Event('change'));

        } catch (error) {
            console.error('Fehler beim Laden der Turniere:', error);
            tournamentSelect.innerHTML = '<option value="" disabled selected>Fehler</M√∂glichkeit>';
            const newOption = document.createElement('option');
            newOption.value = 'NEW';
            newOption.textContent = '[ Neues Turnier anlegen ]';
            tournamentSelect.appendChild(newOption);
            tournamentSelect.value = 'NEW';
            tournamentSelect.dispatchEvent(new Event('change'));
        }
    }

    // --- Custom Action Logik (Unver√§ndert) ---
    async function deleteCustomAction(actionId) {
        if (!confirm("Sind Sie sicher, dass Sie diese Aktionsvorlage l√∂schen m√∂chten?")) return;
        const token = getToken();
        if (!token) return logout();
        try {
            const response = await fetch(`/custom-actions/delete/${actionId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                customActionMessageDiv.textContent = `‚úÖ Aktion erfolgreich gel√∂scht.`;
                customActionMessageDiv.className = 'message success';
                loadCustomActions(selectedTeamId);
            } else {
                const data = await response.json();
                customActionMessageDiv.textContent = `‚ùå Fehler beim L√∂schen: ${data.detail || 'Unbekannt.'}`;
                customActionMessageDiv.className = 'message error';
            }
        } catch (error) {
            customActionMessageDiv.textContent = '‚ùå Serverfehler beim L√∂schen der Aktion.';
            customActionMessageDiv.className = 'message error';
        }
    }
    async function loadCustomActions(teamId) {
        const token = getToken();
        if (!token || !teamId) {
            customActionListContainer.innerHTML = '<p style="opacity: 0.6;">W√§hlen Sie ein Team.</p>';
            return;
        }
        customActionListContainer.innerHTML = `<p style="opacity: 0.6;">Lade Aktionen...</p>`;
        try {
            const response = await fetch(`/custom-actions/list?team_id=${teamId}`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const actions = await response.json();
            customActionListContainer.innerHTML = '';
            if (actions.length === 0) {
                customActionListContainer.innerHTML = `<p style="opacity: 0.6;">Keine eigenen Aktionen erstellt.</p>`;
                return;
            }
            actions.forEach(action => {
                const actionItem = document.createElement('div');
                actionItem.className = 'custom-action-list-item';
                const categoryDisplay = action.category ? ` (${action.category})` : '';
                actionItem.innerHTML = `
                    <span><strong>${action.name}</strong>${categoryDisplay}</span>
                    <button class="btn-delete" onclick="deleteCustomAction(${action.id})">L√∂schen</button>
                `;
                customActionListContainer.appendChild(actionItem);
            });
        } catch (error) {
            customActionListContainer.innerHTML = `<p class="error">Fehler beim Laden der Aktionen.</p>`;
        }
    }
    addCustomActionForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        if (!selectedTeamId) {
            customActionMessageDiv.textContent = '‚ùå Bitte zuerst Team ausw√§hlen.';
            customActionMessageDiv.className = 'message error';
            return;
        }
        const name = document.getElementById('custom-action-name').value;
        const category = document.getElementById('custom-action-category').value;
        const token = getToken();
        customActionMessageDiv.textContent = `Erstelle Aktion "${name}"...`;
        customActionMessageDiv.className = 'message';
        const payload = {
            name: name,
            category: category,
            team_id: selectedTeamId
        };
        try {
            const response = await fetch('/custom-actions/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(payload),
            });
            const data = await response.json();
            if (response.ok) {
                customActionMessageDiv.textContent = `‚úÖ Aktion "${name}" erfolgreich erstellt.`;
                customActionMessageDiv.className = 'message success';
                addCustomActionForm.reset();
                loadCustomActions(selectedTeamId);
            } else {
                customActionMessageDiv.textContent = `‚ùå Fehler: ${data.detail || 'Unbekannter Fehler'}`;
                customActionMessageDiv.className = 'message error';
            }
        } catch (error) {
            customActionMessageDiv.textContent = '‚ùå Serverfehler beim Erstellen der Aktion.';
            customActionMessageDiv.className = 'message error';
        }
    });

    // --- INITIALISIERUNG ---
    async function initDashboard() {
        try {
            await loadTeams();
            // Standard-Tab f√ºr "Spiel anlegen" setzen
            switchGameCategory('Testspiel');
        } catch (error) {
            teamListDiv.innerHTML = '<p class="error">FEHLER beim Laden der Teams.</p>';
        }
    }
    
    if (document.getElementById('app-features')) {
        initDashboard();
    }
    {% endif %}
  </script>

</body>
</html>

