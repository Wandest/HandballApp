<div class="card-container">
    <div class="card">
      <div class="card-content">
        <h2>Spiel anlegen</h2>
        <div class="game-category-tabs">
            <button class="tab-button" id="tab-btn-saison" onclick="switchGameCategory('Saison')" disabled>Saison</button>
            <button class="tab-button active" id="tab-btn-testspiel" onclick="switchGameCategory('Testspiel')" disabled>Testspiel</button>
            <button class="tab-button" id="tab-btn-turnier" onclick="switchGameCategory('Turnier')" disabled>Turnier</button>
        </div>
        <form id="add-game-form">
            <input type="hidden" id="active-game-category" value="Testspiel">
            <div class="form-section active" id="common-game-fields">
                <label for="game-opponent">Gegner:</label>
                <input type="text" id="game-opponent" required>
                <label for="game-date">Datum:</label>
                <input type="date" id="game-date" required>
                
                <label for="game-video-url">Video URL (Optional):</label>
                <input type="text" id="game-video-url" placeholder="https://www.youtube.com/watch?v=...">
            </div>
            
            <div class="form-section" id="tournament-game-fields">
                 <label for="tournament-select">Turnier ausw√§hlen:</label>
                 <select id="tournament-select">
                     <option value="" disabled selected>Team w√§hlen...</option>
                 </select>
                 <div id="new-tournament-group">
                     <label for="new-tournament-name">Neuer Turniername:</label>
                     <input type="text" id="new-tournament-name">
                 </div>
            </div>
            <button type="submit" class="btn btn-primary" id="add-game-button" disabled>Spiel erstellen</button>
        </form>
        <div id="game-message" class="message"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-content">
        <h2>Spielplan</h2>
        <h3><span id="gameplan-team-name" style="color: #ffcc00;">(Team w√§hlen)</span></h3>
        <div id="game-list-container" style="max-height: 400px; overflow-y: auto;">
            <p style="opacity: 0.6;">W√§hlen Sie eine Mannschaft aus.</p>
        </div>
      </div>
    </div>
</div>

<div id="video-url-modal" class="modal">
  <div class="modal-content card">
    <span class="close-btn" onclick="closeVideoModal()">&times;</span>
    <div class="card-content">
      <h3 id="video-modal-title">Video-URL bearbeiten</h3>
      <p style="opacity: 0.8; font-size: 0.9em;">
        F√ºgen Sie hier einen Link zu einer Video-Datei (MP4, M3U8) oder 
        einen YouTube-Link ein (z.B. https://www.youtube.com/watch?v=VIDEO_ID).
      </p>
      <div class="form-section active">
        <label for="video-url-input-modal">Video-URL:</label>
        <input type="text" id="video-url-input-modal" placeholder="https://...">
      </div>
      <input type="hidden" id="video-modal-game-id">
      <button id="save-video-url-btn" class="btn btn-primary btn-full-width" onclick="saveVideoUrl()">
        Speichern
      </button>
      <div id="video-modal-message" class="message"></div>
    </div>
  </div>
</div>
<script>
    // Globale Variablen (m√ºssen aus Local Storage geladen werden)
    let selectedTeamId = localStorage.getItem('selected_team_id');
    let selectedTeamName = localStorage.getItem('selected_team_name');
    
    // DOM-Elemente
    const gameplanTeamName = document.getElementById('gameplan-team-name');
    const addGameButton = document.getElementById('add-game-button');
    const gameMessageDiv = document.getElementById('game-message');
    const gameListContainer = document.getElementById('game-list-container');
    const tabBtnSaison = document.getElementById('tab-btn-saison');
    const tabBtnTestspiel = document.getElementById('tab-btn-testspiel');
    const tabBtnTurnier = document.getElementById('tab-btn-turnier');
    const activeGameCategoryInput = document.getElementById('active-game-category');
    const tournamentGameFields = document.getElementById('tournament-game-fields');
    const tournamentSelect = document.getElementById('tournament-select');
    const newTournamentGroup = document.getElementById('new-tournament-group');
    
    // --- Hilfsfunktionen ---
    // `logout()` ist global
    // `checkVerification()` ist global
    // `showToast()` ist global
    
    // --- Spielplan Logik ---
    function switchGameCategory(category) {
        activeGameCategoryInput.value = category;
        [tabBtnSaison, tabBtnTestspiel, tabBtnTurnier].forEach(btn => btn.classList.remove('active'));
        if (category === 'Saison') tabBtnSaison.classList.add('active');
        if (category === 'Testspiel') tabBtnTestspiel.classList.add('active');
        if (category === 'Turnier') tabBtnTurnier.classList.add('active');
        if (category === 'Turnier') {
            tournamentGameFields.style.display = 'block';
            if (tournamentSelect.value === 'NEW') {
                newTournamentGroup.style.display = 'block';
            } else {
                newTournamentGroup.style.display = 'none';
            }
        } else {
            tournamentGameFields.style.display = 'none';
            newTournamentGroup.style.display = 'none';
        }
    }
    tournamentSelect.addEventListener('change', function() {
        if (this.value === 'NEW') {
            newTournamentGroup.style.display = 'block';
        } else {
            newTournamentGroup.style.display = 'none';
        }
    });
    
    async function deleteGame(gameId) {
        if (!checkVerification()) return; 
        if (!confirm("Sind Sie sicher, dass Sie dieses Spiel l√∂schen m√∂chten?")) return;
        
        try {
            const response = await fetch(`/games/delete/${gameId}`, {
                method: 'DELETE'
            });
            if (response.ok) {
                showToast("Spiel erfolgreich gel√∂scht.", "success");
                loadGames(selectedTeamId); 
            } else {
                const data = await response.json();
                showToast(`Fehler beim L√∂schen: ${data.detail || 'Unbekannt.'}`, "error");
            }
        } catch (error) {
            showToast('Serverfehler beim L√∂schen des Spiels.', "error");
        }
    }
    
    document.getElementById('add-game-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        if (!checkVerification()) return;
        
        if (!selectedTeamId) {
            gameMessageDiv.textContent = '‚ùå Bitte zuerst eine Mannschaft ausw√§hlen (Team Management).';
            gameMessageDiv.className = 'message error';
            return;
        }
        const opponent = document.getElementById('game-opponent').value;
        const date = document.getElementById('game-date').value;
        const videoUrl = document.getElementById('game-video-url').value.trim();
        
        const category = activeGameCategoryInput.value;
        let tournamentName = null;
        if (category === "Turnier") {
            const selectedTournament = tournamentSelect.value;
            if (selectedTournament === "NEW") {
                tournamentName = document.getElementById('new-tournament-name').value;
                if (!tournamentName) {
                    gameMessageDiv.textContent = '‚ùå Bitte einen Namen f√ºr das neue Turnier eingeben.';
                    gameMessageDiv.className = 'message error';
                    return;
                }
            } else if (!selectedTournament) {
                 gameMessageDiv.textContent = '‚ùå Bitte ein Turnier ausw√§hlen oder ein neues anlegen.';
                 gameMessageDiv.className = 'message error';
                 return;
            } else {
                tournamentName = selectedTournament;
            }
        }
        gameMessageDiv.textContent = `Erstelle Spiel gegen ${opponent}...`;
        gameMessageDiv.className = 'message';
        
        const payload = {
            opponent: opponent,
            date: date,
            team_id: parseInt(selectedTeamId),
            game_category: category,
            tournament_name: tournamentName,
            video_url: videoUrl || null 
        };
        
        try {
            const response = await fetch('/games/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            const data = await response.json();
            if (response.ok) {
                gameMessageDiv.textContent = `‚úÖ Spiel gegen "${opponent}" erfolgreich angelegt.`;
                gameMessageDiv.className = 'message success';
                document.getElementById('add-game-form').reset();
                switchGameCategory('Testspiel');
                loadGames(selectedTeamId);
                if (category === "Turnier") {
                    loadTournaments(selectedTeamId);
                }
            } else if (response.status === 401 || response.status === 403) {
                logout();
            } else {
                gameMessageDiv.textContent = `‚ùå Fehler: ${data.detail || 'Unbekannter Fehler'}`;
                gameMessageDiv.className = 'message error';
            }
        } catch (error) {
            gameMessageDiv.textContent = '‚ùå Serverfehler beim Erstellen des Spiels.';
            gameMessageDiv.className = 'message error';
        }
    });

    function startProtocol(gameId) {
        if (!checkVerification()) return; 
        window.location.href = `/protocol/${gameId}`;
    }

    async function loadGames(teamId) {
        gameListContainer.innerHTML = `<p style="opacity: 0.6;">Lade Spielplan...</p>`;
        try {
            const response = await fetch(`/games/list/${teamId}`, {
                method: 'GET'
            });
            if (response.status === 401 || response.status === 403) { logout(); return; }
            const games = await response.json();
            gameListContainer.innerHTML = '';
            if (games.length === 0) {
                gameListContainer.innerHTML = `<p style="opacity: 0.6;">Keine Spiele angelegt.</p>`;
                return;
            }
            
            const groupedGames = {
                'Saison': [],
                'Testspiel': [],
                'Turnier': {}
            };
            const archiveGroups = {}; 
            games.forEach(game => {
                if (game.game_category === 'Saison') {
                    groupedGames.Saison.push(game);
                } else if (game.game_category === 'Testspiel') {
                    groupedGames.Testspiel.push(game);
                } else if (game.game_category === 'Turnier') {
                    const tourName = game.tournament_name || 'Unbenanntes Turnier';
                    if (!groupedGames.Turnier[tourName]) {
                        groupedGames.Turnier[tourName] = [];
                    }
                    groupedGames.Turnier[tourName].push(game);
                } else {
                    const archiveName = game.game_category;
                    if (!archiveGroups[archiveName]) {
                        archiveGroups[archiveName] = [];
                    }
                    archiveGroups[archiveName].push(game);
                }
            });
            
            // KORRIGIERT (PHASE 8): renderGameList zeigt jetzt "Video/URL"-Button
            const renderGameList = (gameList) => {
                let html = '';
                gameList.forEach(game => {
                    const dateObj = new Date(game.date);
                    const formattedDate = dateObj.toLocaleDateString('de-DE', {
                        year: 'numeric', month: '2-digit', day: '2-digit'
                    });
                    
                    // KORRIGIERT: Zeigt Kamera-Icon ODER leeren String
                    const videoIcon = game.video_url ? ' üé¨' : '';
                    // KORRIGIERT: String-URL sicher f√ºr JS-Aufruf escapen
                    const videoUrlJs = game.video_url ? `'${game.video_url.replace(/'/g, "\\'")}'` : "''";

                    html += `
                        <div class="game-list-item">
                            <div class="game-info">
                                <span>üìÖ ${formattedDate} <strong>vs. ${game.opponent}</strong>${videoIcon}</span>
                                <span>Kategorie: ${game.game_category === 'Turnier' ? game.tournament_name : game.game_category}</span>
                            </div>
                            <div class="game-actions">
                                <button class="btn btn-secondary btn-small" 
                                        style="margin: 0 5px 0 0; padding: 4px 8px; font-size: 0.9em;"
                                        onclick="openVideoModal(${game.id}, ${videoUrlJs})">
                                    Video/URL
                                </button>
                                <button class="btn btn-info btn-inline" onclick="startProtocol(${game.id})">Protokoll</button>
                                <button class="btn btn-danger btn-inline-delete" onclick="deleteGame(${game.id})">L√∂schen</button>
                            </div>
                        </div>
                    `;
                });
                return html;
            };
            
            let finalHtml = '';
            if (groupedGames.Saison.length > 0) {
                finalHtml += '<h3 class="game-list-header">Saison (Liga)</h3>';
                finalHtml += renderGameList(groupedGames.Saison);
            }
            if (groupedGames.Testspiel.length > 0) {
                finalHtml += '<h3 class="game-list-header">Testspiele</h3>';
                finalHtml += renderGameList(groupedGames.Testspiel);
            }
            if (Object.keys(groupedGames.Turnier).length > 0) {
                finalHtml += '<h3 class="game-list-header">Turniere</h3>';
                for (const tourName in groupedGames.Turnier) {
                    finalHtml += `<h4 style="margin: 10px 0 5px 5px; color: #ddd;">${tourName}</h4>`;
                    finalHtml += renderGameList(groupedGames.Turnier[tourName]);
                }
            }
            if (Object.keys(archiveGroups).length > 0) {
                finalHtml += '<h3 class="game-list-header" style="color: #9e9e9e;">Archiv</h3>';
                for (const archiveName in archiveGroups) {
                    finalHtml += `<h4 style="margin: 10px 0 5px 5px; color: #ccc;">${archiveName}</h4>`;
                    finalHtml += renderGameList(archiveGroups[archiveName]);
                }
            }
            gameListContainer.innerHTML = finalHtml;
        } catch (error) {
            console.error("Fehler loadGames:", error);
            gameListContainer.innerHTML = `<p class="error">Fehler beim Laden des Spielplans.</p>`;
        }
    }
    
    async function loadTournaments(teamId) {
        tournamentSelect.innerHTML = '<option value="" disabled selected>Lade Turniere...</option>';
        try {
            const response = await fetch(`/games/tournaments/${teamId}`, {
                method: 'GET'
            });
            if (response.status === 401 || response.status === 403) { logout(); return; }
            if (!response.ok) throw new Error('Turniere konnten nicht geladen werden.');
            const tournaments = await response.json();
            tournamentSelect.innerHTML = '';
            if (tournaments.length > 0) {
                tournaments.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    tournamentSelect.appendChild(option);
                });
            }
            const newOption = document.createElement('option');
            newOption.value = 'NEW';
            newOption.textContent = '[ Neues Turnier anlegen ]';
            tournamentSelect.appendChild(newOption);
            
            if (tournamentSelect.options.length > 0 && tournamentSelect.value === "") {
                 tournamentSelect.selectedIndex = 0;
            } else if (tournamentSelect.options.length === 1) {
                tournamentSelect.value = 'NEW';
            }
            tournamentSelect.dispatchEvent(new Event('change'));

        } catch (error) {
            console.error('Fehler beim Laden der Turniere:', error);
            tournamentSelect.innerHTML = '<option value="" disabled selected>Fehler</M√∂glichkeit>';
            const newOption = document.createElement('option');
            newOption.value = 'NEW';
            newOption.textContent = '[ Neues Turnier anlegen ]';
            tournamentSelect.appendChild(newOption);
            tournamentSelect.value = 'NEW';
            tournamentSelect.dispatchEvent(new Event('change'));
        }
    }
    
    // ==================================================
    // NEUE JS-FUNKTIONEN (PHASE 8)
    // ==================================================
    const videoModal = document.getElementById('video-url-modal');
    const videoUrlInputModal = document.getElementById('video-url-input-modal');
    const videoModalGameId = document.getElementById('video-modal-game-id');
    const videoModalMessage = document.getElementById('video-modal-message');

    function openVideoModal(gameId, currentUrl) {
        videoModalGameId.value = gameId;
        videoUrlInputModal.value = currentUrl || ''; // Setzt die aktuelle URL
        videoModalMessage.textContent = '';
        videoModalMessage.className = 'message';
        document.getElementById('video-modal-title').textContent = `Video-URL f√ºr Spiel #${gameId}`;
        videoModal.style.display = 'block';
    }

    function closeVideoModal() {
        videoModal.style.display = 'none';
    }

    async function saveVideoUrl() {
        const gameId = videoModalGameId.value;
        const newUrl = videoUrlInputModal.value.trim();
        videoModalMessage.textContent = 'Speichere...';
        videoModalMessage.className = 'message';

        try {
            const response = await fetch(`/games/update-video/${gameId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ video_url: newUrl || null }) // Sendet null, wenn Feld leer ist
            });
            
            if (response.status === 401) { logout(); return; }
            if (!response.ok) {
                throw new Error('Fehler beim Speichern der URL.');
            }
            
            videoModalMessage.textContent = '‚úÖ Erfolgreich gespeichert.';
            videoModalMessage.className = 'message success';
            
            // Lade die Spiele neu, damit die 'game.video_url' in der JS-Variable aktuell ist
            loadGames(selectedTeamId); // WICHTIG: Spielplan neu laden

            setTimeout(closeVideoModal, 1000); // Modal nach Erfolg schlie√üen

        } catch (error) {
            videoModalMessage.textContent = `‚ùå ${error.message}`;
            videoModalMessage.className = 'message error';
            console.error("Fehler Video-URL:", error);
        }
    }

    // Schlie√üen, wenn au√üerhalb geklickt wird
    window.addEventListener('click', function(event) {
        if (event.target == videoModal) {
            closeVideoModal();
        }
    });
    // ==================================================
    // ENDE NEUE JS-FUNKTIONEN
    // ==================================================


    // --- Initialisierung ---
    function initGamePlanning() {
        console.log("initGamePlanning() wird aufgerufen.");
        // Lade Team aus Local Storage, falls vorhanden
        const storedId = localStorage.getItem('selected_team_id');
        const storedName = localStorage.getItem('selected_team_name');
        
        if (storedId && storedName) {
            selectedTeamId = storedId;
            selectedTeamName = storedName;

            gameplanTeamName.textContent = selectedTeamName;
            addGameButton.disabled = false;
            [tabBtnSaison, tabBtnTestspiel, tabBtnTurnier].forEach(btn => btn.disabled = false);
            loadGames(selectedTeamId);
            loadTournaments(selectedTeamId);
            switchGameCategory('Testspiel');
        } else {
            gameplanTeamName.textContent = "(Team w√§hlen)";
            addGameButton.disabled = true;
            [tabBtnSaison, tabBtnTestspiel, tabBtnTurnier].forEach(btn => btn.disabled = true);
            gameListContainer.innerHTML = '<p style="opacity: 0.6;">W√§hlen Sie eine Mannschaft aus.</p>';
        }
    }
    
    initGamePlanning();
</script>