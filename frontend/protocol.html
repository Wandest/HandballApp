<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <!-- Titel wird von main.py √ºbergeben -->
    <title>{{ title }}</title>
    <style>
        /* ================================================== */
        /* BASIS-STYLES (Kopiert aus app_layout.html) */
        /* ================================================== */
        body {
            font-family: system-ui, sans-serif;
            background: linear-gradient(120deg, #1e3c72, #2a5298);
            color: white;
            margin: 0;
            padding: 20px; /* Padding f√ºr die ganze Seite */
            min-height: 100vh;
            box-sizing: border-box; /* Wichtig, damit padding funktioniert */
        }
        
        /* Allgemeine UI-Elemente */
        h2 { color: #fff; margin-top: 0; margin-bottom: 15px; }
        h3 { color: #ffcc00; margin-top: 0; margin-bottom: 10px; }
        .message { margin-top: 10px; font-weight: bold; }
        .success { color: #38E838; }
        .error { color: #FF6666; }
        
        .btn {
            padding: 12px 15px; border: none; border-radius: 5px;
            font-weight: bold; cursor: pointer; font-size: 1em;
            color: white;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            margin-top: 10px;
            display: inline-flex; align-items: center; justify-content: center;
            text-decoration: none; box-sizing: border-box;
        }
        .btn.btn-full-width { width: 100%; }
        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-primary { background: #38E838; color: #1e3c72; }
        .btn-primary:hover:not(:disabled) { background: #50f050; }
        .btn-danger { background-color: #f44336; color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #d32f2f; }
        .btn-info { background-color: #00bcd4; color: white; }
        .btn-info:hover:not(:disabled) { background-color: #0097a7; }
        .btn-inline-delete {
            width: auto; padding: 4px 8px; font-size: 0.9em;
            margin: 0; margin-left: 10px; flex-shrink: 0;
        }

        /* Banner (wird von JS hinzugef√ºgt, falls n√∂tig) */
        .verification-banner {
            background-color: #ffcc00; color: #1e3c72;
            padding: 15px 20px; margin-bottom: 20px; border-radius: 8px;
            display: flex; align-items: center; justify-content: space-between;
            font-weight: bold; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .verification-banner .btn-refresh {
            background-color: #1e3c72; color: #ffcc00; border: none;
            padding: 8px 15px; border-radius: 5px; cursor: pointer;
            font-weight: bold; margin-left: 20px;
        }
        
        /* Modal Styles (Global f√ºr Wurf-Modal) */
        .modal {
            display: none; position: fixed; z-index: 1000; 
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.7); 
        }
        .modal-content {
            background-color: #1e3c72;
            margin: 5% auto; padding: 30px; border-radius: 10px;
            width: 80%; max-width: 700px; /* Schmaler f√ºr Wurfmodal */
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            max-height: 80vh; overflow-y: auto;
        }
        .close-btn {
            color: #aaa; float: right; font-size: 28px; font-weight: bold;
        }
        .close-btn:hover, .close-btn:focus {
            color: white; text-decoration: none; cursor: pointer;
        }

        /* Toast-Nachrichten */
        .toast {
            visibility: hidden; min-width: 250px;
            background-color: #333; color: #fff; text-align: center;
            border-radius: 5px; padding: 16px; position: fixed;
            z-index: 1001; left: 50%; transform: translateX(-50%);
            bottom: 30px; font-size: 1em;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        .toast.error { background-color: #f44336; }
        .toast.success { background-color: #38E838; color: #1e3c72; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        
        /* ================================================== */
        /* STYLES F√úR SHOT CHARTS (im Modal) */
        /* ================================================== */
        .shot-chart-container-full {
            position: relative; width: 100%;
            background-color: #ffffff; border: 2px solid #000;
            box-sizing: border-box; border-radius: 5px;
            overflow: hidden; margin-top: 15px;
            max-width: 700px; margin-left: auto; margin-right: auto;
        }
        .svg-handball-pitch {
            width: 100%; height: auto; 
            display: block; z-index: 1; 
        }
        .shot-overlay {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 2; 
        }
        .shot-overlay p { color: #000; opacity: 0.7; }
        
        /* ================================================== */
        /* CSS F√úR PROTOKOLL-SEITE (Eigenst√§ndig) */
        /* ================================================== */
        
        .protocol-grid {
            display: grid; 
            grid-template-columns: 2fr 1fr 3fr;
            gap: 20px; 
            margin: 0 auto;
        }
        /* Alle 3 Spalten bekommen den .card Look */
        .player-list, .action-controls, .right-column-area {
             background: rgba(0, 0, 0, 0.2); /* Dunklerer Hintergrund f√ºr Kontrast */
             padding: 15px;
             border-radius: 8px;
             min-height: 75vh;
        }
        
        /* Header-Leiste (wie im Referenzbild) */
        .header {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header .match-info {
            text-align: center;
        }
        .header .match-info h2 { 
            margin: 0 0 5px 0; 
            color: #ffcc00; 
            font-size: 1.5em; /* Etwas kleiner */
        }
        .header .match-info p { margin: 0; font-size: 0.9em; opacity: 0.8; }
        
        .header .header-button {
            padding: 10px 15px;
            margin: 0; 
            font-size: 0.9em;
        }
        .header .score-info {
            text-align: center;
        }
        .header .score-board-display { 
            font-size: 2.5em; /* Gr√∂√üer */
            font-weight: bold; 
            color: #38E838; 
            margin: 0;
            line-height: 1;
        }
        .header .header-half-toggle-container {
            display: flex;
            gap: 10px;
            margin-top: 10px; /* Mehr Abstand */
        }
        .header .header-half-button {
            padding: 5px 12px; border: 2px solid #ffcc00;
            background: none; color: #ffcc00;
            border-radius: 5px; font-weight: bold;
            cursor: pointer; font-size: 0.9em;
            opacity: 0.6; transition: background-color 0.2s, opacity 0.2s;
        }
        .header .header-half-button:hover:not(.active) {
            opacity: 1; background-color: rgba(255, 204, 0, 0.1);
        }
        .header .header-half-button.active {
            background: #ffcc00; color: #1e3c72; opacity: 1;
        }
        #current-half-display { /* Versteckt, da Buttons ausreichen */
            display: none;
        }
        
        /* Spieler-Buttons */
        .player-list h3 { text-align: center; }
        .player-list button {
            width: 100%; padding: 12px; margin-bottom: 10px;
            background: #00bcd4; color: white; border: none;
            border-radius: 5px; cursor: pointer; font-weight: bold;
            transition: background-color 0.2s;
        }
        .player-list button:hover { background: #0097a7; }
        .player-list button.goalkeeper { background: #ffcc00; color: #333; }
        .player-list button.selected { background: #ff6666; }
        .player-list button.opponent {
            background: #9e9e9e; color: white; border: 2px dashed white;
        }
        .player-list button.opponent.selected {
            background: #ff6666; border-color: #ff6666;
        }
        .player-list button.active-goalie {
            border: 3px solid #38E838;
            box-shadow: 0 0 10px rgba(56, 232, 56, 0.7);
        }
        
        /* Aktions-Buttons */
        .action-controls h3 { color: #ffcc00; margin-top: 0; text-align: center; }
        .action-controls button {
            width: 100%; padding: 10px; border: none; border-radius: 5px; 
            font-weight: bold; cursor: pointer; font-size: 1.1em;
            margin: 4px 0; display: flex;
            align-items: center; justify-content: center;
        }
        .btn-goal { background: #38E838; color: #333; }
        .btn-miss { background: #ff6666; color: white; }
        .btn-error { background: #f44336; color: white; }
        .btn-save-opp { background: #00bcd4; color: white; }
        .btn-opp-goal { background: #9e9e9e; color: white; }
        .btn-opp-miss { background: #795548; color: white; }
        .btn-opp-error { background: #616161; color: white; }
        .btn-custom { background: #673ab7; color: white; }
        .btn-custom-Offensiv { background: #ff9800; color: white; }
        .btn-custom-Defensiv { background: #00bcd4; color: white; }
        .btn-custom-Torwart { background: #ffcc00; color: #333; }
        .btn-custom-Sonstiges { background: #607d8b; color: white; }
        hr.divider { border-color: rgba(255,255,255,0.2); margin: 15px 0; }
        
        /* Protokoll Tab-Navigation */
        .tab-nav {
            display: flex; border-bottom: 2px solid #ffcc00;
            margin-bottom: 15px;
        }
        .tab-nav .tab-button {
            flex-grow: 1; padding: 10px 15px; cursor: pointer; background: none;
            border: none; color: white; font-weight: bold;
            opacity: 0.7; font-size: 1.0em;
            border-top-left-radius: 5px; border-top-right-radius: 5px;
            transition: background-color 0.2s, opacity 0.2s;
            border-bottom: none; 
        }
        .tab-nav .tab-button:hover:not(:disabled) {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }
        .tab-nav .tab-button.active {
            background: #ffcc00; 
            color: #1e3c72; 
            opacity: 1;
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Protokoll-Filter-Buttons */
        .stats-filter-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: flex-start;
        }
        .filter-button {
            padding: 6px 12px; border: 2px solid #607d8b;
            background: none; color: #607d8b;
            border-radius: 5px; font-weight: bold;
            cursor: pointer; font-size: 0.9em;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .filter-button:hover:not(.active) {
            background-color: rgba(96, 125, 139, 0.2);
            color: #78909c;
        }
        .filter-button.active {
            background: #607d8b; color: white; border-color: #607d8b;
        }
        
        /* Tabellen-Styles (Statistik & Log) */
        .stats-table-container { width: 100%; overflow-x: auto; }
        .stats-table, .log-table {
            width: 100%;
            min-width: 500px; 
            border-collapse: collapse;
            margin-top: 15px;
        }
        .stats-table th, .stats-table td, .log-table th, .log-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9em;
        }
        .stats-table th, .log-table th {
            color: #ffcc00;
            border-bottom: 2px solid #ffcc00;
            text-transform: uppercase;
        }
        .stats-table td:first-child, .stats-table th:first-child,
        .log-table td:nth-child(3), .log-table th:nth-child(3) { 
            text-align: left; 
        }
        .stats-table tfoot tr {
            background-color: rgba(0,0,0,0.3); 
            font-weight: bold; 
            border-top: 2px solid #ffcc00;
        }
        
        .opponent-stats-table {
            width: 100%; max-width: 400px;
            margin-top: 15px;
        }
        .opponent-stats-table td {
             padding: 10px;
             border-bottom: 1px solid rgba(255, 255, 255, 0.1);
             font-size: 1.1em;
        }
        .opponent-stats-table td:first-child { font-weight: bold; width: 80%; }
        .opponent-stats-table td:last-child {
            text-align: center; font-weight: bold; font-size: 1.2em;
        }
        
        /* Protokoll-Roster-Tab */
        #roster-checklist-container {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 10px; margin-bottom: 20px;
        }
        .roster-player-item {
            background: rgba(255, 255, 255, 0.1); padding: 10px;
            border-radius: 4px; display: flex; align-items: center;
        }
        .roster-player-item input[type="checkbox"] {
            width: 18px; height: 18px; margin-right: 10px; cursor: pointer;
        }
        .roster-player-item label { cursor: pointer; font-size: 1.1em; }
        
        /* Video-Analyse-Tab (PHASE 8) */
        .video-analysis-container {
            width: 100%; max-width: 650px; 
            margin: 10px auto; padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        .video-input-group {
            display: flex; gap: 10px; margin-bottom: 15px;
        }
        .video-input-group input[type="text"] {
            flex-grow: 1; margin-bottom: 0;
            /* Styles aus app_layout kopiert */
            padding: 10px; border-radius: 5px; border: 1px solid #ccc;
            box-sizing: border-box; background: #f0f0f0;
            color: #333; font-size: 1em;
        }
        .video-input-group button {
            margin-top: 0; flex-shrink: 0;
        }
        #player-container {
            position: relative; padding-bottom: 56.25%; /* 16:9 */
            height: 0; overflow: hidden;
            background: #000; border-radius: 5px;
        }
        #youtube-player {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
        }
        
    </style>
</head>
<body>
    
    <!-- Toast-Container (f√ºr showToast) -->
    <div id="toast-message" class="toast"></div>

    <div class="header">
        <button class="btn btn-info header-button" onclick="leaveProtocol()">‚¨ÖÔ∏è Dashboard</button>
        <div class="match-info">
            <h2>{{ team_name }} vs. {{ opponent }}</h2>
            <p>Spiel-ID: {{ game_id }} | Team-ID: {{ team_id }}</p>
        </div>
        <div class="score-info">
            <p id="score-board" class="score-board-display">0 - 0</p>
            <div class="header-half-toggle-container">
                <button id="half-btn-H1" class="header-half-button active" onclick="setHalf('H1')">H√§lfte 1</button>
                <button id="half-btn-H2" class="header-half-button" onclick="setHalf('H2')">H√§lfte 2</button>
            </div>
        </div>
        <button class="btn btn-info header-button" onclick="updateAllStats()">üîÑ Aktualisieren</button>
    </div>

    <div class="protocol-grid">
        
        <div class="player-list card protocol-card">
            <h3>Teilnehmende Spieler</h3>
            <p style="font-weight: bold;">Ausgew√§hlt: <span id="selected-player-info" style="color: #ffcc00;">Keiner</span></p>
            <div id="player-buttons-container">
                <p style="text-align: center;">Lade Kader...</p>
            </div>
        </div>

        <div class="action-controls card protocol-card">
            <h3>Meine Aktionen</h3>
            
            <button class="btn-goal" onclick="showShotModal('Goal', false)">ü•Ö Tor erzielt</button>
            <button class="btn-miss" onclick="showShotModal('Miss', false)">‚ùå Wurf verworfen</button>
            <button class="btn-goal" onclick="showShotModal('Goal', true)">üéØ 7m Tor</button>
            <button class="btn-miss" onclick="showShotModal('Miss', true)">üß± 7m verworfen</button>
            <button class="btn-error" onclick="showShotModal('TechError', false)">‚ö†Ô∏è Technischer Fehler</button>
            
            <button class="btn-error" onclick="showShotModal('Fehlpass', false)">üö´ Fehlpass</button>
            
            <button class="btn-error" onclick="handleAction('SEVEN_METER_CAUSED')">üö® 7m verursacht</button>
            <hr class="divider">
            <h3>Team-Aktionen</h3>
            <div id="custom-action-buttons">
                <p style="opacity: 0.6; text-align: center;">Lade Aktionen...</p>
            </div>
            <hr class="divider">
            <h3>Torwart-Aktionen</h3>
            <button class="btn-save-opp" onclick="handleGoalieAction('Save')">üß§ Parade Torwart</button>
            <button class="btn-save-opp" onclick="handleGoalieAction('SEVEN_METER_SAVE')">üß± 7m Gehalten</button>
            <button class="btn-opp-goal" onclick="handleGoalieAction('SEVEN_METER_RECEIVED')">ü•Ö 7m Tor (kassiert)</button>
            
            <hr class="divider">
            <h3>Gegner-Aktionen</h3>
            <button class="btn-opp-goal" onclick="showShotModal('OppGoal', false)">üü° Gegner Tor</button>
            <button class="btn-opp-miss" onclick="showShotModal('OppMiss', false)">üí® Gegner Fehlwurf</button>
            <button class="btn-opp-error" onclick="handleOpponentAction('OppTechError')">üö´ Gegner Tech. Fehler</button>
        </div>
        
        <div class="right-column-area card protocol-card">
            
            <!-- KORREKTUR: Video Analyse Tab hinzugef√ºgt -->
            <div class="tab-nav">
                <button class="tab-button active" onclick="showTab('stats')">Live-Statistik</button>
                <button class="tab-button" onclick="showTab('log')">Protokoll</button>
                <button class="tab-button" onclick="showTab('roster')">Kader / Roster</button>
                <button class="tab-button" onclick="showTab('video')">üé¨ Video Analyse</button>
            </div>

            <div id="stats-tab" class="tab-content active">
                
                <div class="stats-filter-container">
                    <button id="filter-btn-ALL" class="filter-button active" onclick="setFilterHalf('ALL')">Gesamt</button>
                    <button id="filter-btn-H1" class="filter-button" onclick="setFilterHalf('H1')">H√§lfte 1</button>
                    <button id="filter-btn-H2" class="filter-button" onclick="setFilterHalf('H2')">H√§lfte 2</button>
                </div>

                <h3 style="margin-top: 20px;">Gegner-Statistik</h3>
                <div id="stats-table-container-opponent">
                    <p style="opacity: 0.6; text-align: center;">Lade Statistiken...</p>
                </div>

                <h3 style="margin-top: 20px;">Feldspieler-Statistik</h3>
                <div class="stats-table-container" id="stats-table-container-field">
                    <p style="opacity: 0.6; text-align: center;">Lade Statistiken...</p>
                </div>
                
                <h3 style="margin-top: 20px;">Torwart-Statistik</h3>
                <div id="stats-table-container-goalie">
                    <p style="opacity: 0.6; text-align: center;">Lade Statistiken...</p>
                </div>

                <h3 style="margin-top: 20px;">Team-Aktionen Statistik</h3>
                <div id="stats-table-container-custom">
                    <p style="opacity: 0.6; text-align: center;">Lade Statistiken...</p>
                </div>
            </div>

            <div id="log-tab" class="tab-content">
                <h3>Protokoll Tabelle (Letzte Aktionen zuerst)</h3>
                <div class="stats-filter-container">
                    <button id="log-filter-btn-ALL" class="filter-button active" onclick="setFilterHalf('ALL', true)">Gesamt</button>
                    <button id="log-filter-btn-H1" class="filter-button" onclick="setFilterHalf('H1', true)">H√§lfte 1</button>
                    <button id="log-filter-btn-H2" class="filter-button" onclick="setFilterHalf('H2', true)">H√§lfte 2</button>
                </div>
                <div id="action-log-container" class="stats-table-container"></div>
            </div>
            
            <div id="roster-tab" class="tab-content">
                <h3>Spielberichtsbogen</h3>
                <p style="font-size: 0.9em; opacity: 0.8;">W√§hle alle Spieler aus, die an diesem Spiel teilnehmen.</p>
                <div id="roster-checklist-container">
                    <p style="opacity: 0.6; text-align: center; grid-column: span 2;">Lade Team-Kader...</p>
                </div>
                <button id="save-roster-btn" class="btn btn-primary btn-full-width">Kader speichern</button>
                <div id="roster-message" class="message"></div>
            </div>
            
            <!-- NEUER TAB-INHALT F√úR VIDEO -->
            <div id="video-tab" class="tab-content">
                
                <div class="video-analysis-container">
                    <h3 style="margin-top: 0;">Video Analyse</h3>
                    <p style="font-size: 0.9em; opacity: 0.8;">
                        F√ºge eine YouTube-URL (oder Video-ID) ein, um das Video hier zu laden.
                        Die Zeitstempel werden dann automatisch beim Loggen von Aktionen erfasst.
                    </p>
                    <div class="video-input-group">
                        <input type="text" id="video-url-input" placeholder="YouTube Video URL oder ID einf√ºgen...">
                        <button class="btn btn-primary" onclick="loadVideo()">Video laden</button>
                    </div>
                    <div id="player-container">
                        <div id="youtube-player" style="display: flex; align-items: center; justify-content: center; color: #aaa;">
                            Video-Player.
                        </div>
                    </div>
                </div>
                
            </div>
            
        </div>
    </div>
    
    <!-- Shot Modal -->
    <div id="shot-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeShotModal()">&times;</span>
            <h3 id="shot-modal-title" class="pitch-instructions">Aktion eintragen:</h3>
            
            <div class="shot-chart-container-full" onclick="logShotWithCoordinates(event)">
                <img src="/static/ganzfeld.svg" class="svg-handball-pitch" alt="Handball-Ganzfeld">
                <div class="shot-overlay"></div>
            </div>
            
            <p style="text-align: center; font-size: 0.9em; margin-top: 10px;">
                Klicke (oder tippe) auf dem Spielfeld, um die Position der Aktion festzuhalten.
            </p>
        </div>
    </div>

    <!-- YouTube IFrame API Script -->
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script>
        // --- Globale Konstanten ---
        const GAME_ID = {{ game_id }};
        const TEAM_ID = {{ team_id }}; 
        const PRELOADED_VIDEO_URL = {{ video_url | tojson }};
        
        // DOM Elemente
        const ACTION_LOG_CONTAINER = document.getElementById('action-log-container');
        const PLAYER_BUTTONS_CONTAINER = document.getElementById('player-buttons-container');
        const SCORE_BOARD = document.getElementById('score-board');
        const SELECTED_PLAYER_INFO = document.getElementById('selected-player-info');
        const STATS_TABLE_CONTAINER_FIELD = document.getElementById('stats-table-container-field');
        const STATS_TABLE_CONTAINER_GOALIE = document.getElementById('stats-table-container-goalie');
        const STATS_TABLE_CONTAINER_CUSTOM = document.getElementById('stats-table-container-custom');
        const STATS_TABLE_CONTAINER_OPPONENT = document.getElementById('stats-table-container-opponent');
        const CUSTOM_ACTION_BUTTONS_CONTAINER = document.getElementById('custom-action-buttons');
        const ROSTER_CHECKLIST_CONTAINER = document.getElementById('roster-checklist-container');
        const ROSTER_MESSAGE = document.getElementById('roster-message');
        const SAVE_ROSTER_BTN = document.getElementById('save-roster-btn');
        // const CURRENT_HALF_DISPLAY = document.getElementById('current-half-display'); // Wird nicht mehr gebraucht

        // Shot Modal DOM
        const SHOT_MODAL = document.getElementById('shot-modal');
        const SHOT_MODAL_TITLE = document.getElementById('shot-modal-title');

        let fullTeamRoster = []; 
        let participatingPlayers = []; 
        let customActions = [];
        let selectedPlayerId = null; 
        let activeGoalieId = null; 
        let pendingActionType = null;
        let pendingIsSevenMeter = false;
        let protocolCurrentHalf = 'H1'; 
        let currentFilterHalf = 'ALL'; 
        
        // Globale Player-Variable
        let youtubePlayer = null;
        
        // --- Verifizierungs-Logik ---
        function showVerificationBanner() {
            // Diese Funktion pr√ºft localStorage (gesetzt von app_layout)
            if (localStorage.getItem('is_verified') !== 'true') {
                const banner = document.createElement('div');
                banner.className = 'verification-banner visible';
                banner.innerHTML = `
                    <span>
                        ‚ö†Ô∏è Dein Konto ist nicht verifiziert. Bitte √ºberpr√ºfe dein E-Mail-Postfach (ggf. Spam).
                    </span>
                    <button class="btn-refresh" onclick="location.reload()">
                        Refresh
                    </button>
                `;
                // F√ºge das Banner am Anfang des Grids ein, nicht ganz oben
                document.querySelector('.protocol-grid').prepend(banner);
            }
        }
        function checkVerification() {
             if (localStorage.getItem('is_verified') === 'true') {
                return true;
            } else {
                showToast("Bitte verifiziere dein Konto, um diese Aktion auszuf√ºhren.", "error");
                return false;
            }
        }
        
        // --- Hilfsfunktionen ---
        function leaveProtocol() { window.location.href = "/dashboard"; } 
        
        function updateAllStats() {
            updateScoreDisplay(); 
            if (document.getElementById('stats-tab').classList.contains('active')) {
                loadStats();
                loadOpponentStats();
            }
            if (document.getElementById('log-tab').classList.contains('active')) {
                loadActionLog();
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-nav .tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.querySelector(`.tab-nav .tab-button[onclick="showTab('${tabName}')"]`).classList.add('active');
            
            setFilterHalf(currentFilterHalf, tabName === 'log');
            
            if (tabName === 'stats') { 
                loadStats();
                loadOpponentStats();
            } 
            else if (tabName === 'log') { 
                loadActionLog(); 
            }
            else if (tabName === 'video') {
                if (!youtubePlayer && (document.getElementById('video-url-input').value || PRELOADED_VIDEO_URL)) {
                    loadVideo();
                }
            }
        }
        
        function selectPlayer(playerId, playerName, isGoalie) {
            selectedPlayerId = playerId;
            SELECTED_PLAYER_INFO.textContent = playerName;
            document.querySelectorAll('.player-list button').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.getElementById(`player-btn-${playerId}`).classList.add('selected');
            if (isGoalie) {
                document.querySelectorAll('.player-list button.active-goalie').forEach(btn => {
                    btn.classList.remove('active-goalie');
                });
                document.getElementById(`player-btn-${playerId}`).classList.add('active-goalie');
                activeGoalieId = playerId;
            }
        }
        
        function setHalf(half) {
            protocolCurrentHalf = half;
            // CURRENT_HALF_DISPLAY.innerHTML = `Aktuell: <strong>${half === 'H1' ? 'H√§lfte 1' : 'H√§lfte 2'}</strong>`;
            document.getElementById('half-btn-H1').classList.toggle('active', half === 'H1');
            document.getElementById('half-btn-H2').classList.toggle('active', half === 'H2');
        }
        
        function setFilterHalf(half, isLogTab = false) {
            currentFilterHalf = half;
            // Aktualisiere beide Filter-Gruppen (Stats & Log)
            document.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll(`#filter-btn-${half}, #log-filter-btn-${half}`).forEach(btn => {
                if(btn) btn.classList.add('active');
            });
            
            if (isLogTab) {
                loadActionLog();
            } else {
                loadStats();
                loadOpponentStats();
            }
        }

        // --- Wurf Modal Logik ---
        function getActionLabel(actionType, isSevenMeter) {
            if (isSevenMeter) { return actionType === 'Goal' ? '7m Tor' : '7m verworfen'; }
            if (actionType === 'Goal') return 'Tor erzielt (Feld)';
            if (actionType === 'Miss') return 'Wurf verworfen';
            if (actionType === 'TechError') return 'Technischer Fehler';
            if (actionType === 'Fehlpass') return 'Fehlpass';
            if (actionType === 'OppGoal') return 'Gegner Tor';
            if (actionType === 'OppMiss') return 'Gegner Fehlwurf';
            return actionType; 
        }
        function showShotModal(actionType, isSevenMeter) {
            if (!checkVerification()) return;
            const isOpponentAction = (actionType === 'OppGoal' || actionType === 'OppMiss');
            if (!isOpponentAction && selectedPlayerId === null) {
                 showToast("Bitte w√§hle zuerst einen Spieler aus der Liste (links).", "error"); return;
            }
            // Gegner (ID 0) kann keine eigenen Aktionen ausf√ºhren
            if (!isOpponentAction && selectedPlayerId === 0) {
                 showToast("Diese Aktion kann nur eigenen Spielern zugewiesen werden.", "error"); return;
            }
            pendingActionType = actionType;
            pendingIsSevenMeter = isSevenMeter;
            const actionLabel = getActionLabel(actionType, isSevenMeter);
            let titleText = "";
            if (isOpponentAction) {
                titleText = `Position f√ºr: GEGNER - ${actionLabel}`;
            } else {
                const player = participatingPlayers.find(p => p.id === selectedPlayerId);
                titleText = `Position f√ºr: ${player.name} - ${actionLabel}`;
            }
            SHOT_MODAL_TITLE.textContent = titleText;
            SHOT_MODAL.style.display = 'block';
        }
        function closeShotModal() {
            SHOT_MODAL.style.display = 'none';
            pendingActionType = null;
            pendingIsSevenMeter = false;
        }
        SHOT_MODAL.addEventListener('click', function(event) {
            if (event.target === SHOT_MODAL) {
                closeShotModal();
            }
        });
        function logShotWithCoordinates(event) {
            event.stopPropagation(); 
            const container = event.currentTarget; 
            const rect = container.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            const xCoord = (x / rect.width) * 100;
            const yCoord = (y / rect.height) * 100;
            const isOpponentAction = (pendingActionType === 'OppGoal' || pendingActionType === 'OppMiss');
            if (isOpponentAction) {
                logAction(pendingActionType, null, false, protocolCurrentHalf, xCoord, yCoord, activeGoalieId);
            } else {
                logAction(pendingActionType, selectedPlayerId, pendingIsSevenMeter, protocolCurrentHalf, xCoord, yCoord, null);
            }
            closeShotModal();
        }
        
        // --- Video Player Logik (PHASE 8) ---
        function onYouTubeIframeAPIReady() {
            console.log("YouTube API ist bereit.");
            if (PRELOADED_VIDEO_URL) {
                document.getElementById('video-url-input').value = PRELOADED_VIDEO_URL;
                loadVideo();
            }
        }
        function extractVideoID(url) {
            if (!url) return null;
            let videoID = url; 
            try {
                const urlObj = new URL(url, 'https://www.youtube.com');
                if (urlObj.hostname === 'youtu.be') {
                    videoID = urlObj.pathname.substring(1);
                } else {
                    const urlParams = urlObj.searchParams;
                    if (urlParams.has('v')) {
                        videoID = urlParams.get('v');
                    }
                }
            } catch(e) {
                // F√§llt zur√ºck auf die Annahme, dass es eine ID ist
            }
            if (/^[a-zA-Z0-9_-]{11}$/.test(videoID)) {
                return videoID;
            }
            return null; 
        }
        function loadVideo() {
            const urlInput = document.getElementById('video-url-input').value;
            const videoID = extractVideoID(urlInput);
            if (!videoID) {
                showToast("Ung√ºltige YouTube Video URL oder ID.", "error");
                return;
            }
            if (youtubePlayer) {
                youtubePlayer.loadVideoById(videoID);
                return;
            }
            youtubePlayer = new YT.Player('youtube-player', {
                height: '100%',
                width: '100%',
                videoId: videoID,
                playerVars: { 'playsinline': 1, 'modestbranding': 1, 'rel': 0 }
            });
        }
        function getCurrentVideoTime() {
            if (youtubePlayer && typeof youtubePlayer.getCurrentTime === 'function') {
                const time = youtubePlayer.getCurrentTime();
                return time > 0 ? time.toFixed(2) : null; 
            }
            return null;
        }
        function formatVideoTime(seconds) {
            if (!seconds || seconds <= 0) return '‚Äî';
            try {
                const totalSec = Math.floor(parseFloat(seconds));
                const min = Math.floor(totalSec / 60);
                const sec = totalSec % 60;
                return `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
            } catch (e) {
                return 'N/A';
            }
        }

        // --- Aktion verarbeiten (mit Koordinaten) ---
        function handleAction(actionType) {
            if (!checkVerification()) return;
            if (selectedPlayerId === null || selectedPlayerId === 0) {
                 showToast("Bitte w√§hle einen eigenen Spieler.", "error"); return;
            }
            if (actionType === 'SEVEN_METER_CAUSED') {
                logAction(actionType, selectedPlayerId, false, protocolCurrentHalf, null, null);
            } else {
                 showToast("Diese Aktion sollte das Shot-Modal √∂ffnen.", "error");
            }
        }
        function handleCustomAction(actionName) {
             if (!checkVerification()) return;
             if (selectedPlayerId === null || selectedPlayerId === 0) {
                 showToast("Bitte w√§hle einen eigenen Spieler.", "error"); return;
            }
            const actionsWithCoords = ['Fehlpass']; 
            if (actionsWithCoords.includes(actionName)) {
                 showShotModal(actionName, false);
            } else {
                 logAction(actionName, selectedPlayerId, false, protocolCurrentHalf, null, null);
            }
        }
        function handleGoalieAction(actionType) {
            if (!checkVerification()) return;
            if (selectedPlayerId === null || selectedPlayerId === 0) {
                 showToast("Bitte w√§hle einen eigenen Torwart.", "error"); return;
            }
            const selectedPlayer = participatingPlayers.find(p => p.id === selectedPlayerId);
            if (!selectedPlayer || selectedPlayer.position !== 'Torwart') {
                showToast("Bitte w√§hle zuerst einen Torwart f√ºr diese Aktion aus.", "error"); return;
            }
            logAction(actionType, selectedPlayerId, false, protocolCurrentHalf, null, null);
        }
        function handleOpponentAction(actionType) {
            if (!checkVerification()) return;
            logAction(actionType, null, false, protocolCurrentHalf, null, null, activeGoalieId);
        }
        
        async function logAction(
            actionType, playerId = null, isSevenMeter = false, half = 'H1',
            xCoord = null, yCoord = null, activeGoalieIdForOpponentAction = null
        ) {
            const videoTimestamp = getCurrentVideoTime();
            let finalActionType = actionType;
            if (isSevenMeter) {
                if (actionType === 'Goal') { finalActionType = 'Goal_7m'; }
                if (actionType === 'Miss') { finalActionType = 'Miss_7m'; }
            }
            const payload = {
                action_type: finalActionType, time_in_game: half, game_id: GAME_ID, 
                player_id: playerId, is_seven_meter: isSevenMeter,
                x_coordinate: xCoord, y_coordinate: yCoord,
                active_goalie_id: activeGoalieIdForOpponentAction,
                video_timestamp: videoTimestamp
            };
            try {
                const response = await fetch('/actions/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload),
                });
                if (response.ok) { 
                    updateAllStats(); 
                    selectedPlayerId = null;
                    SELECTED_PLAYER_INFO.textContent = "Keiner";
                    document.querySelectorAll('.player-list button').forEach(btn => {
                        btn.classList.remove('selected');
                    });
                } 
                else if (response.status === 401 || response.status === 403) { 
                    logout(); 
                } 
                else { 
                    const data = await response.json();
                    showToast(`Fehler beim Protokollieren: ${data.detail || 'Unbekannt'}`, "error"); 
                }
            } catch (error) { console.error('Protokollfehler:', error); }
        }
        
        async function deleteAction(actionId) {
            if (!checkVerification()) return;
            if (!confirm("Sind Sie sicher, dass Sie diese Aktion l√∂schen m√∂chten?")) return;
            try {
                const response = await fetch(`/actions/delete/${actionId}?half=${currentFilterHalf}`, {
                    method: 'DELETE' 
                });
                if (response.ok) { updateAllStats(); } 
                else { showToast('Aktion konnte nicht gel√∂scht werden.', "error"); }
            } catch (error) { console.error('L√∂schfehler:', error); }
        }
        
        async function updateScoreDisplay() {
            try {
                const response = await fetch(`/actions/list/${GAME_ID}?half=${currentFilterHalf}`);
                if (response.status === 401 || response.status === 403) {
                    SCORE_BOARD.textContent = "N/A";
                    return logout();
                }
                if (!response.ok) { SCORE_BOARD.textContent = "N/A"; return; }
                const actions = await response.json();
                const own_goals_count = actions.filter(a => a.action_type === 'Goal' || a.action_type === 'Goal_7m').length;
                const opp_goals_count = actions.filter(a => a.action_type === 'OppGoal').length;
                SCORE_BOARD.textContent = `${own_goals_count} - ${opp_goals_count}`;
            } catch (error) {
                console.error("Score Update Fehler:", error);
                SCORE_BOARD.textContent = "N/A";
            }
        }

        async function loadOpponentStats() {
            STATS_TABLE_CONTAINER_OPPONENT.innerHTML = '<p style="opacity: 0.6; text-align: center;">Lade...</p>';
            try {
                const response = await fetch(`/actions/stats/opponent/${GAME_ID}?half=${currentFilterHalf}`);
                if (response.status === 401 || response.status === 403) return logout();
                if (!response.ok) throw new Error('Gegner-Stats-Daten nicht gefunden');
                const stats = await response.json();
                let tableHtml = `<table class="opponent-stats-table"><tbody>
                    <tr><td>üü° Gegner Tore</td><td>${stats.opponent_goals}</td></tr>
                    <tr><td>üí® Gegner Fehlw√ºrfe</td><td>${stats.opponent_misses}</td></tr>
                    <tr><td>üö´ Gegner Tech. Fehler</td><td>${stats.opponent_tech_errors}</td></tr>
                </tbody></table>`;
                STATS_TABLE_CONTAINER_OPPONENT.innerHTML = tableHtml;
            } catch (error) {
                console.error('Fehler beim Laden der Gegner-Stats:', error);
                STATS_TABLE_CONTAINER_OPPONENT.innerHTML = '<p class="error">Fehler beim Laden der Gegner-Statistik.</p>';
            }
        }

        async function loadActionLog() {
            try {
                const response = await fetch(`/actions/list/${GAME_ID}?half=${currentFilterHalf}`);
                if (response.status === 401 || response.status === 403) return logout();
                if (!response.ok) throw new Error('Log-Daten nicht gefunden');
                const actions = await response.json();
                if (actions.length === 0) {
                    ACTION_LOG_CONTAINER.innerHTML = '<p style="text-align: center; opacity: 0.7;">Noch keine Aktionen protokolliert.</p>';
                    return;
                }
                const actionTextMap = {
                    'Goal': '‚öΩ TOR (Feld)', 'Miss': 'üí® Fehlwurf (Feld)',
                    'Goal_7m': 'üéØ TOR (7m)', 'Miss_7m': 'üß± Fehlwurf (7m)', 
                    'TechError': 'üö´ Technischer Fehler', 'Fehlpass': 'üö´ Fehlpass', 
                    'Save': 'üõë Parade', 'SEVEN_METER_CAUSED': 'üö® 7m verursacht',
                    'SEVEN_METER_SAVE': 'üß± 7m Gehalten', 'SEVEN_METER_RECEIVED': 'üü° 7m Bekommen', 
                    'OppGoal': 'üü° Gegner Tor', 'OppMiss': 'üí® Gegner Fehlwurf',
                    'OppTechError': 'üö´ Gegner Tech. Fehler'
                };
                let tableHtml = `<table class="log-table"><thead><tr>
                                    <th>H√§lfte</th><th>Zeit</th><th>Aktion</th><th>Spieler</th><th>#</th><th>L√∂schen</th>
                                 </tr></thead><tbody>`;
                actions.forEach(action => { 
                    let actionText = actionTextMap[action.action_type] || `‚≠ê ${action.action_type}`;
                    if (action.action_type === 'SEVEN_METER_RECEIVED' && action.player_name) {
                        actionText = 'ü•Ö 7m Tor (kassiert)';
                    }
                    let playerInfo = action.player_name || 'TEAM';
                    if (action.action_type.startsWith('Opp') && !action.player_name) {
                        playerInfo = 'GEGNER';
                    }
                    const playerNumber = action.player_number !== null ? action.player_number : '';
                    const videoTimeFormatted = formatVideoTime(action.video_timestamp);
                    tableHtml += `<tr>
                            <td>${action.time_in_game || 'N/A'}</td>
                            <td>${videoTimeFormatted}</td>
                            <td>${actionText}</td><td>${playerInfo}</td><td>${playerNumber}</td>
                            <td><button class="btn btn-danger btn-inline-delete btn-delete-log" onclick="deleteAction(${action.id})">L√∂schen</button></td>
                         </tr>`;
                });
                tableHtml += `</tbody></table>`;
                ACTION_LOG_CONTAINER.innerHTML = tableHtml;
            } catch (error) {
                console.error('Fehler beim Laden des Logs:', error);
                ACTION_LOG_CONTAINER.innerHTML = '<p class="error">Fehler beim Laden des Protokolls.</p>';
            }
        }
        
        async function loadCustomActions() {
            CUSTOM_ACTION_BUTTONS_CONTAINER.innerHTML = '<p style="opacity: 0.6; text-align: center;">Lade Aktionen...</p>';
            try {
                const response = await fetch(`/custom-actions/list?team_id=${TEAM_ID}`);
                if (response.status === 401 || response.status === 403) return logout();
                if (!response.ok) throw new Error('Fehler beim Laden der Custom Actions.');
                customActions = await response.json(); 
                CUSTOM_ACTION_BUTTONS_CONTAINER.innerHTML = '';
                if (customActions.length === 0) {
                    CUSTOM_ACTION_BUTTONS_CONTAINER.innerHTML = '<p style="opacity: 0.6; text-align: center;">Keine Team-Aktionen erstellt.</p>';
                    return;
                }
                customActions.forEach(action => {
                    const button = document.createElement('button');
                    let categoryClass = 'btn-custom'; 
                    if (action.category) {
                        const safeCategory = action.category.replace(/\s+/g, '-');
                        categoryClass = `btn-custom-${safeCategory}`;
                    }
                    button.className = categoryClass; 
                    button.textContent = `‚≠ê ${action.name}`;
                    button.onclick = () => handleCustomAction(action.name);
                    CUSTOM_ACTION_BUTTONS_CONTAINER.appendChild(button);
                });
            } catch (error) {
                CUSTOM_ACTION_BUTTONS_CONTAINER.innerHTML = '<p class="error">Fehler beim Laden der Aktionen.</p>';
                console.error(error);
            }
        }

        async function loadStats() {
            STATS_TABLE_CONTAINER_FIELD.innerHTML = '<p style="opacity: 0.6; text-align: center;">Lade...</p>';
            STATS_TABLE_CONTAINER_GOALIE.innerHTML = '<p style="opacity: 0.6; text-align: center;">Lade...</p>';
            STATS_TABLE_CONTAINER_CUSTOM.innerHTML = '<p style="opacity: 0.6; text-align: center;">Lade...</p>';
            try {
                const response = await fetch(`/actions/stats/${GAME_ID}?half=${currentFilterHalf}`);
                if (response.status === 401 || response.status === 403) return logout();
                if (!response.ok) throw new Error('Statistik-Ladefehler.');
                const stats = await response.json();
                if (stats.length === 0) {
                    STATS_TABLE_CONTAINER_FIELD.innerHTML = '<p style="opacity: 0.6; text-align: center;">Keine Spielerdaten.</p>';
                    STATS_TABLE_CONTAINER_GOALIE.innerHTML = '<p style="opacity: 0.6; text-align: center;">Keine Spielerdaten.</p>';
                    STATS_TABLE_CONTAINER_CUSTOM.innerHTML = '<p style="opacity: 0.6; text-align: center;">Keine Spielerdaten.</p>';
                    return;
                }
                let fieldTableHtml = `<table class="stats-table"><thead><tr>
                                        <th>Spieler</th><th>#</th>
                                        <th>Tore (Quote)</th>
                                        <th>Fehlw√ºrfe</th>
                                        <th>Tech. Fehler / Fehlp√§sse</th>
                                        <th>7m (T/M)</th>
                                        <th>7m Verurs.</th>
                                      </tr></thead><tbody>`;
                let goalieTableHtml = `<table class="stats-table"><thead><tr>
                                        <th>Spieler</th><th>#</th>
                                        <th>Paraden (Quote)</th>
                                        <th>7m (Geh/Bek)</th>
                                      </tr></thead><tbody>`;
                let customTableHtml = `<table class="stats-table"><thead><tr>
                                        <th>Spieler</th><th>#</th>`;
                const customActionNames = customActions.map(ca => ca.name);
                customActionNames.forEach(name => {
                    customTableHtml += `<th>${name}</th>`;
                });
                customTableHtml += `</tr></thead><tbody>`;
                let goaliesFound = false;
                let fieldPlayersFound = false;
                let totalGoals = 0, totalShots = 0, totalTechErrors = 0, totalFehlpaesse = 0,
                    totalSevenMeterCaused = 0, totalSevenMeterAttempts = 0, totalSevenMeterGoals = 0;

                stats.forEach(player => {
                    if (player.position === 'Torwart') {
                        goaliesFound = true;
                        const totalSaves = player.saves + player.seven_meter_saves;
                        const totalGoalsReceived = player.opponent_goals_received + player.seven_meter_received;
                        const totalShotsOnGoal = totalSaves + totalGoalsReceived;
                        const saveQuote = totalShotsOnGoal > 0 ? ((totalSaves / totalShotsOnGoal) * 100).toFixed(0) + '%' : '‚Äî';
                        const totalSevenMeterOnGoal = player.seven_meter_saves + player.seven_meter_received;
                        const sevenMeterQuote = totalSevenMeterOnGoal > 0 ? ((player.seven_meter_saves / totalSevenMeterOnGoal) * 100).toFixed(0) + '%' : '‚Äî';
                        goalieTableHtml += `<tr>
                            <td>${player.player_name}</td>
                            <td>${player.player_number || ''}</td>
                            <td>${totalSaves} (${saveQuote})</td>
                            <td>${player.seven_meter_saves} / ${totalSevenMeterOnGoal} (${sevenMeterQuote})</td>
                        </tr>`;
                    } else {
                        fieldPlayersFound = true;
                        const currentTotalGoals = player.goals + player.seven_meter_goals;
                        const currentTotalShots = currentTotalGoals + player.misses + player.seven_meter_misses;
                        const shotQuote = currentTotalShots > 0 ? ((currentTotalGoals / currentTotalShots) * 100).toFixed(0) + '%' : '‚Äî';
                        fieldTableHtml += `<tr>
                            <td>${player.player_name}</td>
                            <td>${player.player_number || ''}</td>
                            <td>${currentTotalGoals} (${shotQuote})</td>
                            <td>${player.misses + player.seven_meter_misses}</td>
                            <td>${player.tech_errors} / ${player.fehlpaesse}</td>
                            <td>${player.seven_meter_goals} / ${player.seven_meter_goals + player.seven_meter_misses}</td>
                            <td>${player.seven_meter_caused}</td>
                        </tr>`;
                        customTableHtml += `<tr>
                            <td>${player.player_name}</td>
                            <td>${player.player_number || ''}</td>`;
                        customActionNames.forEach(name => {
                            customTableHtml += `<td>${player.custom_counts[name] || 0}</td>`;
                        });
                        customTableHtml += `</tr>`;
                        totalGoals += currentTotalGoals;
                        totalShots += currentTotalShots;
                        totalTechErrors += player.tech_errors;
                        totalFehlpaesse += player.fehlpaesse;
                        totalSevenMeterCaused += player.seven_meter_caused;
                        totalSevenMeterAttempts += player.seven_meter_goals + player.seven_meter_misses;
                        totalSevenMeterGoals += player.seven_meter_goals;
                    }
                });
                const totalShotQuote = totalShots > 0 ? ((totalGoals / totalShots) * 100).toFixed(0) + '%' : '‚Äî';
                fieldTableHtml += `</tbody>
                                  <tfoot>
                                    <tr>
                                        <td>TOTAL TEAM</td>
                                        <td>-</td>
                                        <td>${totalGoals} (${totalShotQuote})</td>
                                        <td>${totalShots - totalGoals}</td>
                                        <td>${totalTechErrors} / ${totalFehlpaesse}</td>
                                        <td>${totalSevenMeterGoals} / ${totalSevenMeterAttempts}</td>
                                        <td>${totalSevenMeterCaused}</td>
                                    </tr>
                                  </tfoot>
                                  </table>`; 
                goalieTableHtml += `</tbody></table>`;
                customTableHtml += `</tbody></table>`;
                STATS_TABLE_CONTAINER_FIELD.innerHTML = fieldPlayersFound ? fieldTableHtml : '<p style="opacity: 0.6; text-align: center;">Keine Feldspieler im Kader.</p>';
                STATS_TABLE_CONTAINER_GOALIE.innerHTML = goaliesFound ? goalieTableHtml : '<p style="opacity: 0.6; text-align: center;">Keine Torh√ºter im Kader.</p>';
                STATS_TABLE_CONTAINER_CUSTOM.innerHTML = (customActionNames.length > 0 && fieldPlayersFound) ? customTableHtml : '<p style="opacity: 0.6; text-align: center;">Keine Team-Aktionen oder Spieler vorhanden.</p>';
            } catch (error) {
                STATS_TABLE_CONTAINER_FIELD.innerHTML = '<p class="error">Fehler beim Laden der Statistik.</p>';
                STATS_TABLE_CONTAINER_GOALIE.innerHTML = '<p class="error">Fehler beim Laden der Statistik.</p>';
                STATS_TABLE_CONTAINER_CUSTOM.innerHTML = '<p class="error">Fehler beim Laden der Statistik.</p>';
                console.error(error);
            }
        }
        
        async function loadFullTeamRoster() {
            try {
                const response = await fetch(`/players/list/${TEAM_ID}`);
                if (response.status === 401 || response.status === 403) return logout();
                if (!response.ok) throw new Error('Fehler beim Laden des Team-Kaders.');
                fullTeamRoster = await response.json();
                buildRosterChecklist();
            } catch (error) {
                ROSTER_CHECKLIST_CONTAINER.innerHTML = '<p class="error">Team-Kader konnte nicht gel√∂scht werden.</p>';
                console.error(error);
            }
        }
        
        function buildRosterChecklist() {
            ROSTER_CHECKLIST_CONTAINER.innerHTML = '';
            fullTeamRoster.forEach(player => {
                const item = document.createElement('div');
                item.className = 'roster-player-item';
                item.innerHTML = `
                    <input type="checkbox" id="roster-check-${player.id}" data-player-id="${player.id}">
                    <label for="roster-check-${player.id}">
                        #${player.number || '?'} ${player.name}
                    </label>
                `;
                ROSTER_CHECKLIST_CONTAINER.appendChild(item);
            });
        }
        
        async function loadGameRoster() {
            try {
                const response = await fetch(`/games/roster/${GAME_ID}`);
                if (response.status === 401 || response.status === 403) return logout();
                if (!response.ok) throw new Error('Fehler beim Laden des Spiel-Kaders.');
                participatingPlayers = await response.json();
                const firstGoalie = participatingPlayers.find(p => p.position === 'Torwart');
                if (firstGoalie) {
                    activeGoalieId = firstGoalie.id;
                }
                updateRosterChecklist();
                buildActionPlayerButtons();
                if (activeGoalieId) {
                    const goalieBtn = document.getElementById(`player-btn-${activeGoalieId}`);
                    if(goalieBtn) goalieBtn.classList.add('active-goalie');
                }
            } catch (error) {
                console.error('Fehler beim Laden des Spiel-Kaders:', error);
                buildActionPlayerButtons(); 
            }
        }
        
        function updateRosterChecklist() {
            const participatingIds = participatingPlayers.map(p => p.id);
            ROSTER_CHECKLIST_CONTAINER.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                 checkbox.checked = false;
            });
            participatingIds.forEach(id => {
                const checkbox = document.getElementById(`roster-check-${id}`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
        }
        
        function buildActionPlayerButtons() {
            PLAYER_BUTTONS_CONTAINER.innerHTML = '';
            participatingPlayers.sort((a, b) => {
                if (a.position === 'Torwart' && b.position !== 'Torwart') { return -1; }
                if (a.position !== 'Torwart' && b.position === 'Torwart') { return 1; }
                const numA = a.number !== null ? a.number : 999;
                const numB = b.number !== null ? b.number : 999;
                return numA - numB;
            });
            let hasPlayers = false;
            participatingPlayers.forEach(player => {
                hasPlayers = true;
                const isGoalie = player.position === 'Torwart';
                const button = document.createElement('button');
                button.textContent = `#${player.number || '?'} ${player.name}`;
                button.className = isGoalie ? 'goalkeeper' : '';
                button.id = `player-btn-${player.id}`;
                button.onclick = () => selectPlayer(player.id, player.name, isGoalie); 
                PLAYER_BUTTONS_CONTAINER.appendChild(button);
            });
            if (!hasPlayers) {
                 PLAYER_BUTTONS_CONTAINER.innerHTML = '<p style="text-align: center; opacity: 0.7;">Keine Spieler f√ºr dieses Spiel ausgew√§hlt. Bitte im Tab "Kader / Roster" festlegen.</p>';
            }
        }
        
        async function handleSaveRoster() {
            if (!checkVerification()) return;
            ROSTER_MESSAGE.textContent = 'Speichere Kader...';
            ROSTER_MESSAGE.className = 'message';
            const checkedBoxes = ROSTER_CHECKLIST_CONTAINER.querySelectorAll('input[type="checkbox"]:checked');
            const player_ids = Array.from(checkedBoxes)
                .map(box => parseInt(box.dataset.playerId));
            try {
                const response = await fetch(`/games/roster/${GAME_ID}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ player_ids: player_ids }),
                });
                if (response.status === 401 || response.status === 403) return logout();
                if (!response.ok) throw new Error('Fehler beim Speichern.');
                await loadGameRoster(); 
                selectedPlayerId = null;
                SELECTED_PLAYER_INFO.textContent = "Keiner";
                ROSTER_MESSAGE.textContent = '‚úÖ Kader erfolgreich gespeichert.';
                ROSTER_MESSAGE.className = 'message success';
            } catch (error) {
                ROSTER_MESSAGE.textContent = '‚ùå Fehler beim Speichern des Kaders.';
                ROSTER_MESSAGE.className = 'message error';
                console.error(error);
            }
        }
        SAVE_ROSTER_BTN.addEventListener('click', handleSaveRoster);

        // --- Seite initialisieren ---
        function initProtocol() {
            try {
                // Die globale Funktion checkVerification() ist in app_layout.html definiert
                // und pr√ºft localStorage.
                // KORREKTUR: showVerificationBanner() wird von der (nicht existenten) app_layout.html aufgerufen
                // Wir m√ºssen es hier selbst tun.
                if (localStorage.getItem('is_verified') !== 'true') {
                    const banner = document.createElement('div');
                    banner.className = 'verification-banner visible';
                    banner.innerHTML = `
                        <span>
                            ‚ö†Ô∏è Dein Konto ist nicht verifiziert. Bitte √ºberpr√ºfe dein E-Mail-Postfach (ggf. Spam).
                        </span>
                        <button class="btn-refresh" onclick="location.reload()">
                            Refresh
                        </button>
                    `;
                    // F√ºge das Banner GANZ OBEN ein, √ºber dem Header
                    document.body.prepend(banner);
                }
                
                setHalf('H1');
                Promise.all([
                    loadFullTeamRoster(),
                    loadCustomActions()
                ]).then(() => {
                    loadGameRoster().then(() => {
                        updateAllStats();
                    });
                });
                if (PRELOADED_VIDEO_URL) {
                    document.getElementById('video-url-input').value = PRELOADED_VIDEO_URL;
                }
            } catch (error) {
                console.error("Fehler bei der Initialisierung des Protokolls:", error);
                alert("Ein kritischer Fehler ist beim Laden der Protokolldaten aufgetreten. Bitte zur√ºck zum Dashboard.");
            }
        }
        
        // Globale Toast-Funktion (Fallback, falls app_layout nicht geladen wird)
        if (typeof showToast === 'undefined') {
            var showToast = function(message, type = 'info') {
                const toast = document.getElementById('toast-message');
                if (!toast) return;
                toast.textContent = message;
                toast.className = `toast show ${type}`;
                setTimeout(() => {
                    toast.className = toast.className.replace('show', '');
                }, 3000);
            }
        }
        
        // Ruft die init-Funktion dieser Seite auf
        document.addEventListener('DOMContentLoaded', initProtocol);
        
    </script>
</body>
</html>

