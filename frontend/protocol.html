<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>{{ title }} - {{ team_name }} vs. {{ opponent }}</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            background: linear-gradient(120deg, #1e3c72, #2a5298);
            color: white;
            padding: 20px;
        }
        .header {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .match-info h2 { margin: 0 0 5px 0; color: #ffcc00; }
        .match-info p { margin: 0; font-size: 0.9em; }
        .header-button {
            background: #00bcd4; color: white; border: none;
            border-radius: 5px; cursor: pointer; font-weight: bold;
            padding: 10px 15px; transition: background-color 0.2s;
        }
        .header-button:hover { background: #0097a7; }
        .score-board-display { font-size: 2em; font-weight: bold; color: #38E838; }
        .protocol-grid {
            display: grid; grid-template-columns: 2fr 1fr 3fr;
            gap: 20px; max-width: 1400px; margin: 0 auto;
        }
        .player-list, .action-controls, .right-column-area {
            background: rgba(255, 255, 255, 0.1); padding: 15px;
            border-radius: 8px; min-height: 70vh;
        }
        .player-list button {
            width: 100%; padding: 12px; margin-bottom: 10px;
            background: #00bcd4; color: white; border: none;
            border-radius: 5px; cursor: pointer; font-weight: bold;
            transition: background-color 0.2s;
        }
        .player-list button:hover { background: #0097a7; }
        .player-list button.goalkeeper { background: #ffcc00; color: #333; }
        .player-list button.selected { background: #ff6666; }
        
        /* NEU: Eigener Stil f√ºr Gegner-Button */
        .player-list button.opponent {
            background: #9e9e9e; /* Grau */
            color: white;
            border: 2px dashed white;
        }
        .player-list button.opponent.selected {
            background: #ff6666; /* Rot, wenn ausgew√§hlt */
            border-color: #ff6666;
        }

        .action-controls h3 { color: #ffcc00; margin-top: 0; text-align: center; }
        .action-controls button {
            width: 100%; padding: 10px; margin-bottom: 8px;
            border: none; border-radius: 5px; font-weight: bold;
            cursor: pointer; font-size: 1.1em;
        }
        .btn-goal { background: #38E838; color: #333; }
        .btn-miss { background: #ff6666; color: white; }
        .btn-error { background: #f44336; color: white; }
        .btn-save-opp { background: #00bcd4; color: white; }
        .btn-opp-goal { background: #9e9e9e; color: white; }
        .btn-opp-miss { background: #795548; color: white; }
        .btn-opp-error { background: #616161; color: white; }
        .btn-custom { background: #673ab7; color: white; }
        .btn-custom-Offensiv { background: #ff9800; color: white; }
        .btn-custom-Defensiv { background: #00bcd4; color: white; }
        .btn-custom-Torwart { background: #ffcc00; color: #333; }
        .btn-custom-Sonstiges { background: #607d8b; color: white; }
        hr.divider { border-color: rgba(255,255,255,0.2); margin: 20px 0; }
        .tab-nav {
            display: flex; border-bottom: 2px solid #ffcc00;
            margin-bottom: 15px;
        }
        .tab-button {
            padding: 10px 15px; cursor: pointer; background: none;
            border: none; color: white; font-weight: bold;
            opacity: 0.7; font-size: 1.1em;
        }
        .tab-button.active {
            background: rgba(255, 255, 255, 0.2); opacity: 1;
            border-top-left-radius: 5px; border-top-right-radius: 5px;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stats-table {
            width: 100%; border-collapse: collapse; margin-top: 15px;
        }
        .stats-table th, .stats-table td {
            padding: 10px; text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stats-table th {
            color: #ffcc00; border-bottom: 2px solid #ffcc00;
            font-size: 0.9em; text-transform: uppercase;
        }
        .stats-table td:first-child, .stats-table th:first-child { text-align: left; }
        .log-table {
            width: 100%; border-collapse: collapse; margin-top: 10px;
        }
        .log-table th {
            text-align: left; padding: 8px 10px;
            border-bottom: 2px solid #ffcc00; font-size: 0.9em;
        }
        .log-table td {
            padding: 8px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9em;
        }
        .btn-delete-log {
            background: #f44336; color: white; padding: 4px 8px;
            font-size: 0.9em; margin: 0; border: none;
            border-radius: 4px; cursor: pointer;
        }
        #roster-checklist-container {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 10px; margin-bottom: 20px;
        }
        .roster-player-item {
            background: rgba(255, 255, 255, 0.1); padding: 10px;
            border-radius: 4px; display: flex; align-items: center;
        }
        /* NEU: Eigener Stil f√ºr Gegner-Checkbox */
        .roster-player-item.opponent {
            background: rgba(0, 0, 0, 0.2);
            border: 1px dashed #9e9e9e;
        }
        .roster-player-item input[type="checkbox"] {
            width: 18px; height: 18px; margin-right: 10px; cursor: pointer;
        }
        .roster-player-item label { cursor: pointer; font-size: 1.1em; }
        #save-roster-btn { background: #38E838; color: #333; width: 100%; }
        .message { margin-top: 10px; font-weight: bold; }
        .success { color: #38E838; }
        .error { color: #FF6666; }
    </style>
</head>
<body>

    <div class="header">
        <button class="header-button" onclick="leaveProtocol()">‚¨ÖÔ∏è Dashboard</button>
        <div class="match-info">
            <h2>{{ team_name }} vs. {{ opponent }}</h2>
            <p>Spiel-ID: {{ game_id }} | Team-ID: {{ team_id }}</p>
        </div>
        <div class="score-info">
            <p id="score-board" class="score-board-display">0 - 0</p>
        </div>
        <button class="header-button" onclick="updateAllStats()">üîÑ Aktualisieren</button>
    </div>

    <div class="protocol-grid">
        
        <div class="player-list">
            <h3>Teilnehmende Spieler</h3>
            <p style="font-weight: bold;">Ausgew√§hlt: <span id="selected-player-info" style="color: #ffcc00;">Keiner</span></p>
            <div id="player-buttons-container">
                <p style="text-align: center;">Lade Kader...</p>
            </div>
        </div>

        <div class="action-controls">
            <!-- Die "Gegner-Aktionen"-Buttons sind entfernt (gem√§√ü Phase 8) -->
            <h3>Meine Aktionen</h3>
            <button class="btn-goal" onclick="handleShotAction('Goal', false)">ü•Ö Tor erzielt</button>
            <button class="btn-miss" onclick="handleShotAction('Miss', false)">‚ùå Wurf verworfen</button>
            <button class="btn-goal" onclick="handleShotAction('Goal', true)">üéØ 7m Tor</button>
            <button class="btn-miss" onclick="handleShotAction('Miss', true)">üß± 7m verworfen</button>
            <button class="btn-error" onclick="handleAction('TechError')">‚ö†Ô∏è Technischer Fehler</button>
            <button class="btn-error" onclick="handleAction('SEVEN_METER_CAUSED')">üö® 7m verursacht</button>
            <hr class="divider">
            <h3>Team-Aktionen</h3>
            <div id="custom-action-buttons">
                <p style="opacity: 0.6; text-align: center;">Lade Aktionen...</p>
            </div>
            <hr class="divider">
            <h3>Torwart-Aktionen</h3>
            <button class="btn-save-opp" onclick="handleGoalieAction('Save')">üß§ Parade Torwart</button>
            <button class="btn-save-opp" onclick="handleGoalieAction('SEVEN_METER_SAVE')">üß± 7m Gehalten</button>
            <button class="btn-opp-goal" onclick="handleGoalieAction('SEVEN_METER_RECEIVED')">üü° 7m Bekommen</button>
        </div>

        <div class="right-column-area">
            <div class="tab-nav">
                <button class="tab-button active" onclick="showTab('stats')">Live-Statistik</button>
                <button class="tab-button" onclick="showTab('log')">Protokoll</button>
                <button class="tab-button" onclick="showTab('roster')">Kader / Roster</button>
            </div>

            <!-- HTML F√úR GEGNER-STATISTIK ENTFERNT (Phase 8 Feature) -->
            <div id="stats-tab" class="tab-content active">
                <h3 style="margin-top: 20px;">Feldspieler-Statistik</h3>
                <div id="stats-table-container-field">
                    <p style="opacity: 0.6; text-align: center;">Lade Statistiken...</p>
                </div>
                
                <h3 style="margin-top: 20px;">Torwart-Statistik</h3>
                <div id="stats-table-container-goalie">
                    <p style="opacity: 0.6; text-align: center;">Lade Statistiken...</p>
                </div>

                <h3 style="margin-top: 20px;">Team-Aktionen Statistik</h3>
                <div id="stats-table-container-custom">
                    <p style="opacity: 0.6; text-align: center;">Lade Statistiken...</p>
                </div>
            </div>

            <div id="log-tab" class="tab-content">
                <h3>Protokoll Tabelle (Letzte Aktionen zuerst)</h3>
                <div id="action-log-container"></div>
            </div>
            
            <div id="roster-tab" class="tab-content">
                <h3>Spielberichtsbogen</h3>
                <p style="font-size: 0.9em; opacity: 0.8;">W√§hle alle Spieler aus, die an diesem Spiel teilnehmen. Nur ausgew√§hlte Spieler erscheinen links zur Aktions-Zuweisung.</p>
                <div id="roster-checklist-container">
                    <p style="opacity: 0.6; text-align: center; grid-column: span 2;">Lade Team-Kader...</p>
                </div>
                <button id="save-roster-btn" class="header-button">Kader speichern</button>
                <div id="roster-message" class="message"></div>
            </div>
        </div>
    </div>

    <script>
        // --- Globale Konstanten ---
        const GAME_ID = {{ game_id }};
        const TEAM_ID = {{ team_id }}; 
        
        // DOM Elemente
        const ACTION_LOG_CONTAINER = document.getElementById('action-log-container');
        const PLAYER_BUTTONS_CONTAINER = document.getElementById('player-buttons-container');
        const SCORE_BOARD = document.getElementById('score-board');
        const SELECTED_PLAYER_INFO = document.getElementById('selected-player-info');
        const STATS_TABLE_CONTAINER_FIELD = document.getElementById('stats-table-container-field');
        const STATS_TABLE_CONTAINER_GOALIE = document.getElementById('stats-table-container-goalie');
        const STATS_TABLE_CONTAINER_CUSTOM = document.getElementById('stats-table-container-custom');
        const CUSTOM_ACTION_BUTTONS_CONTAINER = document.getElementById('custom-action-buttons');
        const ROSTER_CHECKLIST_CONTAINER = document.getElementById('roster-checklist-container');
        const ROSTER_MESSAGE = document.getElementById('roster-message');
        const SAVE_ROSTER_BTN = document.getElementById('save-roster-btn');
        // const STATS_TABLE_CONTAINER_OPPONENT = document.getElementById('stats-table-container-opponent'); // Entfernt

        let fullTeamRoster = []; 
        let participatingPlayers = []; 
        let customActions = []; // Wichtig: Wird von loadCustomActions() bef√ºllt
        let selectedPlayerId = null; 

        // --- Hilfsfunktionen ---
        function getToken() { return localStorage.getItem('access_token'); }
        function leaveProtocol() { window.location.href = "/app/dashboard"; }
        
        function updateAllStats() {
            updateScoreDisplay();
            if (document.getElementById('stats-tab').classList.contains('active')) {
                loadStats();
               // loadOpponentStats(); // Bleibt auskommentiert
            }
            if (document.getElementById('log-tab').classList.contains('active')) {
                loadActionLog();
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`).classList.add('active');
            
            if (tabName === 'stats') { 
                loadStats(); 
              //  loadOpponentStats(); // Bleibt auskommentiert
            } 
            else if (tabName === 'log') { loadActionLog(); }
        }
        
        function selectPlayer(playerId, playerName, isGoalie) {
            selectedPlayerId = playerId;
            SELECTED_PLAYER_INFO.textContent = playerName;
            document.querySelectorAll('.player-list button').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.getElementById(`player-btn-${playerId}`).classList.add('selected');
        }

        // --- Aktion verarbeiten ---
        
        // Normale Aktion (z.B. Tech. Fehler)
        function handleAction(actionType) {
            if (selectedPlayerId === null) {
                 alert("Bitte w√§hle zuerst einen Spieler aus der Liste (links).");
                 return;
            }
            
            if (selectedPlayerId === 0) { // 0 ist unsere ID f√ºr "GEGNER"
                if (actionType === 'TechError') {
                    logAction('OppTechError', null, false);
                } else {
                    alert("Diese Aktion ist f√ºr den 'GEGNER'-Spieler nicht vorgesehen.");
                }
            } else {
                // Normaler Spieler
                logAction(actionType, selectedPlayerId, false);
            }
        }
        
        // Team-Aktion
        function handleCustomAction(actionName) {
             if (selectedPlayerId === null) {
                 alert("Bitte w√§hle zuerst einen Spieler aus der Liste (links).");
                 return;
            }
            if (selectedPlayerId === 0) {
                alert("Team-Aktionen k√∂nnen nicht dem 'GEGNER'-Spieler zugewiesen werden.");
                return;
            }
            logAction(actionName, selectedPlayerId, false);
        }

        // Wurf-Aktion (z.B. Tor, Fehlwurf)
        function handleShotAction(actionType, isSevenMeter) {
            if (selectedPlayerId === null) {
                 alert("Bitte w√§hle zuerst einen Spieler aus der Liste (links).");
                 return;
            }
            
            if (selectedPlayerId === 0) { // 0 ist "GEGNER"
                if (actionType === 'Goal') {
                    logAction('OppGoal', null, false);
                } else if (actionType === 'Miss') {
                    logAction('OppMiss', null, false);
                }
                // 7m-Aktionen werden f√ºr den Gegner-Spieler ignoriert
            } else {
                // Normaler Spieler
                logAction(actionType, selectedPlayerId, isSevenMeter);
            }
        }
        
        // Torwart-Aktion
        function handleGoalieAction(actionType) {
            if (selectedPlayerId === null) {
                 alert("Bitte w√§hle zuerst einen Spieler aus der Liste (links).");
                 return;
            }
            if (selectedPlayerId === 0) {
                 alert("Torwart-Aktionen k√∂nnen nicht dem 'GEGNER'-Spieler zugewiesen werden.");
                 return;
            }
            const selectedPlayer = participatingPlayers.find(p => p.id === selectedPlayerId);
            if (!selectedPlayer || selectedPlayer.position !== 'Torwart') {
                alert("Bitte w√§hle zuerst einen Torwart (der am Spiel teilnimmt) f√ºr diese Aktion aus.");
                return;
            }
            logAction(actionType, selectedPlayerId, false);
        }

        // Aktion protokollieren (Sendet an Backend)
        async function logAction(actionType, playerId = null, isSevenMeter = false) {
            const token = getToken();
            if (!token) return leaveProtocol();
            const payload = {
                action_type: actionType, time_in_game: "N/A", 
                game_id: GAME_ID, player_id: playerId, is_seven_meter: isSevenMeter
            };
            try {
                const response = await fetch('/actions/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload),
                });
                if (response.ok) { updateAllStats(); } 
                else if (response.status === 401 || response.status === 403) { leaveProtocol(); } 
                else { alert('Fehler beim Protokollieren der Aktion.'); }
            } catch (error) { console.error('Protokollfehler:', error); }
        }
        
        // Aktion l√∂schen
        async function deleteAction(actionId) {
            if (!confirm("Sind Sie sicher, dass Sie diese Aktion l√∂schen m√∂chten?")) return;
            const token = getToken();
            if (!token) return leaveProtocol();
            try {
                const response = await fetch(`/actions/delete/${actionId}`, {
                    method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) { updateAllStats(); } 
                else { alert('Aktion konnte nicht gel√∂scht werden.'); }
            } catch (error) { console.error('L√∂schfehler:', error); }
        }
        
        // Score aktualisieren
        async function updateScoreDisplay() {
            const token = getToken();
            if (!token) return;
            try {
                const response = await fetch(`/actions/list/${GAME_ID}`, {
                    method: 'GET', headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Score-Daten nicht gefunden');
                const actions = await response.json();
                let ownGoals = 0; let opponentGoals = 0;
                actions.forEach(action => {
                    if (action.action_type === 'Goal' || action.action_type === 'Goal_7m') { ownGoals++; } 
                    else if (action.action_type === 'OppGoal') { opponentGoals++; }
                });
                SCORE_BOARD.textContent = `${ownGoals} - ${opponentGoals}`;
            } catch (error) {
                console.error("Score Update Fehler:", error);
                SCORE_BOARD.textContent = "N/A";
            }
        }

        // Protokoll laden
        async function loadActionLog() {
            const token = getToken();
            if (!token) return;
            try {
                const response = await fetch(`/actions/list/${GAME_ID}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Log-Daten nicht gefunden');
                const actions = await response.json();
                if (actions.length === 0) {
                    ACTION_LOG_CONTAINER.innerHTML = '<p style="text-align: center; opacity: 0.7;">Noch keine Aktionen protokolliert.</p>';
                    return;
                }
                const actionTextMap = {
                    'Goal': '‚öΩ TOR (Feld)', 'Miss': 'üí® Fehlwurf (Feld)',
                    'Goal_7m': 'üéØ TOR (7m)', 'Miss_7m': 'üß± Fehlwurf (7m)', 
                    'TechError': 'üö´ Technischer Fehler', 'Save': 'üõë Parade',
                    'SEVEN_METER_CAUSED': 'üö® 7m verursacht',
                    'SEVEN_METER_SAVE': 'üß± 7m Gehalten',
                    'SEVEN_METER_RECEIVED': 'üü° 7m Bekommen',
                    'OppGoal': 'üü° Gegner Tor',
                    'OppMiss': 'üí® Gegner Fehlwurf',
                    'OppTechError': 'üö´ Gegner Tech. Fehler'
                };
                let tableHtml = `<table class="log-table"><thead><tr>
                                    <th>Aktion</th><th>Spieler</th><th>#</th><th>L√∂schen</th>
                                 </tr></thead><tbody>`;
                actions.forEach(action => {
                    const actionText = actionTextMap[action.action_type] || `‚≠ê ${action.action_type}`;
                    let playerInfo = action.player_name || 'TEAM';
                    if (action.action_type.startsWith('Opp') && !action.player_name) {
                        playerInfo = 'GEGNER';
                    }
                    const playerNumber = action.player_number !== null ? action.player_number : '';
                    tableHtml += `<tr>
                            <td>${actionText}</td><td>${playerInfo}</td><td>${playerNumber}</td>
                            <td><button class="btn-delete-log" onclick="deleteAction(${action.id})">L√∂schen</button></td>
                         </tr>`;
                });
                tableHtml += `</tbody></table>`;
                ACTION_LOG_CONTAINER.innerHTML = tableHtml;
            } catch (error) {
                console.error('Fehler beim Laden des Logs:', error);
                ACTION_LOG_CONTAINER.innerHTML = '<p class="error">Fehler beim Laden des Protokolls.</p>';
            }
        }
        
        // --- NEU: Custom Actions laden (WIEDERHERGESTELLT) ---
        async function loadCustomActions() {
            const token = getToken();
            if (!token) return;
            
            CUSTOM_ACTION_BUTTONS_CONTAINER.innerHTML = '<p style="opacity: 0.6; text-align: center;">Lade Aktionen...</p>';
            
            try {
                // Der Endpunkt erwartet team_id als Query-Parameter
                const response = await fetch(`/custom-actions/list?team_id=${TEAM_ID}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.status === 401 || response.status === 403) return leaveProtocol();
                if (!response.ok) throw new Error('Fehler beim Laden der Custom Actions.');

                customActions = await response.json(); // Store in global variable
                CUSTOM_ACTION_BUTTONS_CONTAINER.innerHTML = '';

                if (customActions.length === 0) {
                    CUSTOM_ACTION_BUTTONS_CONTAINER.innerHTML = '<p style="opacity: 0.6; text-align: center;">Keine Team-Aktionen erstellt.</p>';
                    return;
                }

                customActions.forEach(action => {
                    const button = document.createElement('button');
                    // Standard-Klasse
                    let categoryClass = 'btn-custom'; 
                    // Spezifische Klasse basierend auf der Kategorie
                    if (action.category) {
                        // Ersetze Leerzeichen oder ung√ºltige Zeichen f√ºr CSS-Klassen
                        const safeCategory = action.category.replace(/\s+/g, '-');
                        categoryClass = `btn-custom-${safeCategory}`;
                    }
                    
                    button.className = categoryClass; // Z.B. btn-custom-Offensiv
                    button.textContent = `‚≠ê ${action.name}`;
                    button.onclick = () => handleCustomAction(action.name);
                    CUSTOM_ACTION_BUTTONS_CONTAINER.appendChild(button);
                });

            } catch (error) {
                CUSTOM_ACTION_BUTTONS_CONTAINER.innerHTML = '<p class="error">Fehler beim Laden der Aktionen.</p>';
                console.error(error);
            }
        }

        // --- NEU: Spieler-Statistik-Tabelle laden (WIEDERHERGESTELLT) ---
        async function loadStats() {
            const token = getToken();
            if (!token) return;

            STATS_TABLE_CONTAINER_FIELD.innerHTML = '<p style="opacity: 0.6; text-align: center;">Lade...</p>';
            STATS_TABLE_CONTAINER_GOALIE.innerHTML = '<p style="opacity: 0.6; text-align: center;">Lade...</p>';
            STATS_TABLE_CONTAINER_CUSTOM.innerHTML = '<p style="opacity: 0.6; text-align: center;">Lade...</p>';

            try {
                const response = await fetch(`/actions/stats/${GAME_ID}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.status === 401 || response.status === 403) return leaveProtocol();
                if (!response.ok) throw new Error('Statistik-Ladefehler.');

                const stats = await response.json();

                if (stats.length === 0) {
                    STATS_TABLE_CONTAINER_FIELD.innerHTML = '<p style="opacity: 0.6; text-align: center;">Keine Spielerdaten.</p>';
                    STATS_TABLE_CONTAINER_GOALIE.innerHTML = '<p style="opacity: 0.6; text-align: center;">Keine Spielerdaten.</p>';
                    STATS_TABLE_CONTAINER_CUSTOM.innerHTML = '<p style="opacity: 0.6; text-align: center;">Keine Spielerdaten.</p>';
                    return;
                }

                let fieldTableHtml = `<table class="stats-table"><thead><tr>
                                        <th>Spieler</th><th>#</th>
                                        <th>Tore (Quote)</th>
                                        <th>Fehlw√ºrfe</th>
                                        <th>Tech. Fehler</th>
                                        <th>7m (T/M)</th>
                                        <th>7m Verurs.</th>
                                      </tr></thead><tbody>`;
                
                let goalieTableHtml = `<table class="stats-table"><thead><tr>
                                        <th>Spieler</th><th>#</th>
                                        <th>Paraden (Quote)</th>
                                        <th>7m (Geh/Bek)</th>
                                      </tr></thead><tbody>`;

                // Dynamische Header for Custom-Tabelle
                let customTableHtml = `<table class="stats-table"><thead><tr>
                                        <th>Spieler</th><th>#</th>`;
                const customActionNames = customActions.map(ca => ca.name); // Globale Variable von loadCustomActions()
                customActionNames.forEach(name => {
                    customTableHtml += `<th>${name}</th>`;
                });
                customTableHtml += `</tr></thead><tbody>`;

                let goaliesFound = false;
                let fieldPlayersFound = false;

                stats.forEach(player => {
                    if (player.position === 'Torwart') {
                        goaliesFound = true;
                        const totalSaves = player.saves + player.seven_meter_saves;
                        // Bugfix: opponent_goals ist beim Torwart die Anzahl der Gegentore, die er erhalten hat
                        // seven_meter_received ist die GESAMTZAHL der 7m (gehalten + rein)
                        const totalGoalsReceived = player.opponent_goals + (player.seven_meter_received - player.seven_meter_saves);
                        const totalShotsOnGoal = totalSaves + totalGoalsReceived;
                        const saveQuote = totalShotsOnGoal > 0 ? ((totalSaves / totalShotsOnGoal) * 100).toFixed(0) + '%' : '‚Äî';
                        
                        const sevenMeterQuote = player.seven_meter_received > 0 ? ((player.seven_meter_saves / player.seven_meter_received) * 100).toFixed(0) + '%' : '‚Äî';

                        goalieTableHtml += `<tr>
                            <td>${player.player_name}</td>
                            <td>${player.player_number || ''}</td>
                            <td>${totalSaves} (${saveQuote})</td>
                            <td>${player.seven_meter_saves} / ${player.seven_meter_received} (${sevenMeterQuote})</td>
                        </tr>`;
                    } else {
                        fieldPlayersFound = true;
                        const totalGoals = player.goals + player.seven_meter_goals;
                        const totalShots = totalGoals + player.misses + player.seven_meter_misses;
                        const shotQuote = totalShots > 0 ? ((totalGoals / totalShots) * 100).toFixed(0) + '%' : '‚Äî';

                        fieldTableHtml += `<tr>
                            <td>${player.player_name}</td>
                            <td>${player.player_number || ''}</td>
                            <td>${totalGoals} (${shotQuote})</td>
                            <td>${player.misses}</td>
                            <td>${player.tech_errors}</td>
                            <td>${player.seven_meter_goals} / ${player.seven_meter_goals + player.seven_meter_misses}</td>
                            <td>${player.seven_meter_caused}</td>
                        </tr>`;
                        
                        // Custom-Tabelle auch f√ºllen
                        customTableHtml += `<tr>
                            <td>${player.player_name}</td>
                            <td>${player.player_number || ''}</td>`;
                        customActionNames.forEach(name => {
                            customTableHtml += `<td>${player.custom_counts[name] || 0}</td>`;
                        });
                        customTableHtml += `</tr>`;
                    }
                });

                fieldTableHtml += `</tbody></table>`;
                goalieTableHtml += `</tbody></table>`;
                customTableHtml += `</tbody></table>`;

                STATS_TABLE_CONTAINER_FIELD.innerHTML = fieldPlayersFound ? fieldTableHtml : '<p style="opacity: 0.6; text-align: center;">Keine Feldspieler im Kader.</p>';
                STATS_TABLE_CONTAINER_GOALIE.innerHTML = goaliesFound ? goalieTableHtml : '<p style="opacity: 0.6; text-align: center;">Keine Torh√ºter im Kader.</p>';
                STATS_TABLE_CONTAINER_CUSTOM.innerHTML = customActionNames.length > 0 ? customTableHtml : '<p style="opacity: 0.6; text-align: center;">Keine Team-Aktionen definiert.</p>';

            } catch (error) {
                STATS_TABLE_CONTAINER_FIELD.innerHTML = '<p class="error">Fehler beim Laden der Statistik.</p>';
                STATS_TABLE_CONTAINER_GOALIE.innerHTML = '<p class="error">Fehler beim Laden der Statistik.</p>';
                STATS_TABLE_CONTAINER_CUSTOM.innerHTML = '<p class="error">Fehler beim Laden der Statistik.</p>';
                console.error(error);
            }
        }
        
        // Gegner-Statistik-Tabelle laden (ENTFERNT)
        // async function loadOpponentStats() { ... }
        
        
        // --- Roster/Kader-Funktionen (Unver√§ndert) ---
        
        async function loadFullTeamRoster() {
            const token = getToken();
            if (!token) return leaveProtocol();
            try {
                const response = await fetch(`/players/list/${TEAM_ID}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Fehler beim Laden des Team-Kaders.');
                fullTeamRoster = await response.json();
                buildRosterChecklist();
            } catch (error) {
                ROSTER_CHECKLIST_CONTAINER.innerHTML = '<p class="error">Team-Kader konnte nicht geladen werden.</p>';
                console.error(error);
            }
        }
        
        function buildRosterChecklist() {
            ROSTER_CHECKLIST_CONTAINER.innerHTML = '';
            
            fullTeamRoster.forEach(player => {
                const item = document.createElement('div');
                item.className = 'roster-player-item';
                item.innerHTML = `
                    <input type="checkbox" id="roster-check-${player.id}" data-player-id="${player.id}">
                    <label for="roster-check-${player.id}">
                        #${player.number || '?'} ${player.name}
                    </label>
                `;
                ROSTER_CHECKLIST_CONTAINER.appendChild(item);
            });
            
            const opponentItem = document.createElement('div');
            opponentItem.className = 'roster-player-item opponent';
            opponentItem.innerHTML = `
                <input type="checkbox" id="roster-check-0" data-player-id="0">
                <label for="roster-check-0">
                    #0 GEGNER (Simulation)
                </label>
            `;
            ROSTER_CHECKLIST_CONTAINER.appendChild(opponentItem);
        }
        
        async function loadGameRoster() {
            const token = getToken();
            if (!token) return leaveProtocol();
            try {
                const response = await fetch(`/games/roster/${GAME_ID}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Fehler beim Laden des Spiel-Kaders.');
                participatingPlayers = await response.json();
                updateRosterChecklist();
                buildActionPlayerButtons();
            } catch (error) {
                console.error('Fehler beim Laden des Spiel-Kaders:', error);
                buildActionPlayerButtons(); 
            }
        }
        
        function updateRosterChecklist() {
            const participatingIds = participatingPlayers.map(p => p.id);
            ROSTER_CHECKLIST_CONTAINER.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.dataset.playerId !== "0") {
                    checkbox.checked = false;
                }
            });
            participatingIds.forEach(id => {
                const checkbox = document.getElementById(`roster-check-${id}`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
        }
        
        function buildActionPlayerButtons() {
            PLAYER_BUTTONS_CONTAINER.innerHTML = '';
            
            if (participatingPlayers.length === 0) {
                PLAYER_BUTTONS_CONTAINER.innerHTML = '<p style="text-align: center; opacity: 0.7;">Keine Spieler f√ºr dieses Spiel ausgew√§hlt. Bitte im Tab "Kader / Roster" festlegen.</p>';
            }
            participatingPlayers.forEach(player => {
                const isGoalie = player.position === 'Torwart';
                const button = document.createElement('button');
                button.textContent = `#${player.number || '?'} ${player.name}`;
                button.className = isGoalie ? 'goalkeeper' : '';
                button.id = `player-btn-${player.id}`;
                button.onclick = () => selectPlayer(player.id, player.name, isGoalie); 
                PLAYER_BUTTONS_CONTAINER.appendChild(button);
            });
            
            const opponentCheckbox = document.getElementById('roster-check-0');
            if (opponentCheckbox && opponentCheckbox.checked) {
                const button = document.createElement('button');
                button.textContent = `#0 GEGNER`;
                button.className = 'opponent';
                button.id = `player-btn-0`;
                button.onclick = () => selectPlayer(0, 'GEGNER', false); 
                PLAYER_BUTTONS_CONTAINER.appendChild(button);
            }
        }
        
        async function handleSaveRoster() {
            const token = getToken();
            if (!token) return leaveProtocol();
            ROSTER_MESSAGE.textContent = 'Speichere Kader...';
            ROSTER_MESSAGE.className = 'message';
            
            const checkedBoxes = ROSTER_CHECKLIST_CONTAINER.querySelectorAll('input[type="checkbox"]:checked');
            const player_ids = Array.from(checkedBoxes)
                .map(box => parseInt(box.dataset.playerId))
                .filter(id => id !== 0); // Filtert die 0 (Gegner) raus
            
            try {
                const response = await fetch(`/games/roster/${GAME_ID}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ player_ids: player_ids }),
                });
                
                if (!response.ok) throw new Error('Fehler beim Speichern.');
                
                participatingPlayers = await response.json();
                buildActionPlayerButtons();
                
                selectedPlayerId = null;
                SELECTED_PLAYER_INFO.textContent = "Keiner";
                ROSTER_MESSAGE.textContent = '‚úÖ Kader erfolgreich gespeichert.';
                ROSTER_MESSAGE.className = 'message success';
            } catch (error) {
                ROSTER_MESSAGE.textContent = '‚ùå Fehler beim Speichern des Kaders.';
                ROSTER_MESSAGE.className = 'message error';
                console.error(error);
            }
        }
        SAVE_ROSTER_BTN.addEventListener('click', handleSaveRoster);

        // --- Seite initialisieren ---
        async function initializeProtocol() {
            try {
                await Promise.all([
                    loadFullTeamRoster(),
                    loadCustomActions()
                ]);
                await loadGameRoster();
                updateAllStats();
            } catch (error) {
                console.error("Fehler bei der Initialisierung des Protokolls:", error);
                alert("Ein kritischer Fehler ist beim Laden der Protokolldaten aufgetreten. Bitte zur√ºck zum Dashboard.");
            }
        }
        
        // Start
        initializeProtocol();
    </script>
</body>
</html>
