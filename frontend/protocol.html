<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>{{ title }} - {{ team_name }} vs. {{ opponent }}</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            background: linear-gradient(120deg, #1e3c72, #2a5298);
            color: white;
            padding: 20px;
        }
        .header {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .match-info h2 {
            margin: 0 0 5px 0;
            color: #ffcc00;
        }
        .match-info p {
            margin: 0;
            font-size: 0.9em;
        }
        .score-board-display {
            font-size: 2em;
            font-weight: bold;
            color: #38E838;
        }

        /* --- HAUPTPROTOKOLL LAYOUT --- */
        .protocol-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 3fr; /* Spieler | Kontrollen | Statistik/Protokoll */
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .player-list, .action-controls, .right-column-area {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            min-height: 70vh;
        }
        
        /* Spielerliste Buttons */
        .player-list button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background: #00bcd4;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .player-list button:hover {
            background: #0097a7;
        }
        .player-list button.goalkeeper {
            background: #ffcc00;
            color: #333;
        }
        .player-list button.selected {
            background: #ff6666; /* Spieler ist ausgew√§hlt */
        }

        /* Kontrollen (Mitte) */
        .action-controls h3 {
            color: #ffcc00;
            margin-top: 0;
            text-align: center;
        }
        .action-controls button {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.1em;
        }
        .btn-goal { background: #38E838; color: #333; }
        .btn-miss { background: #ff6666; color: white; }
        .btn-error { background: #f44336; color: white; }
        .btn-save-opp { background: #00bcd4; color: white; } /* Parade */
        .btn-opp-goal { background: #9e9e9e; color: white; } /* Gegner Tor */

        /* NEU: Tab-Navigation */
        .tab-nav {
            display: flex;
            border-bottom: 2px solid #ffcc00;
            margin-bottom: 15px;
        }
        .tab-button {
            padding: 10px 15px;
            cursor: pointer;
            background: none;
            border: none;
            color: white;
            font-weight: bold;
            opacity: 0.7;
            font-size: 1.1em;
        }
        .tab-button.active {
            background: rgba(255, 255, 255, 0.2);
            opacity: 1;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }
        .tab-content {
            display: none; /* Standardm√§√üig ausgeblendet */
        }
        .tab-content.active {
            display: block; /* Aktivierter Tab wird angezeigt */
        }


        /* Statistik-Tabelle */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .stats-table th, .stats-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .stats-table th {
            color: #ffcc00;
            border-bottom: 2px solid #ffcc00;
            font-size: 0.9em;
            text-transform: uppercase;
        }
        .stats-table td:first-child, .stats-table th:first-child {
            text-align: left;
        }

        /* Protokoll-Tabelle */
        .log-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .log-table th {
            text-align: left;
            padding: 8px 10px;
            border-bottom: 2px solid #ffcc00;
            font-size: 0.9em;
        }
        .log-table td {
            padding: 8px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9em;
        }
        .btn-delete-log {
            background: #f44336;
            color: white;
            padding: 4px 8px;
            font-size: 0.9em;
            margin: 0;
        }
    </style>
</head>
<body>

    <div class="header">
        <button onclick="leaveProtocol()">‚¨ÖÔ∏è Dashboard</button>
        <div class="match-info">
            <h2>{{ team_name }} vs. {{ opponent }}</h2>
            <p>Spiel-ID: {{ game_id }}</p>
        </div>
        <div classs="score-info">
            <p id="score-board" class="score-board-display">0 - 0</p>
        </div>
        <button onclick="updateAllStats()">üîÑ Aktualisieren</button>
    </div>

    <div class="protocol-grid">
        
        <div class="player-list">
            <h3>Spieler (Aktion zuordnen)</h3>
            <p style="font-weight: bold;">Ausgew√§hlt: <span id="selected-player-info" style="color: #ffcc00;">Keiner</span></p>
            <div id="player-buttons-container">
                <p style="text-align: center;">Lade Kader...</p>
            </div>
        </div>

        <div class="action-controls">
            <h3>Aktionen protokollieren</h3>
            
            <button class="btn-goal" onclick="handleShotAction('Goal', false)">ü•Ö Tor erzielt</button>
            <button class="btn-miss" onclick="handleShotAction('Miss', false)">‚ùå Wurf verworfen</button>
            <button class="btn-goal" onclick="handleShotAction('Goal', true)">üéØ 7m Tor</button>
            <button class="btn-miss" onclick="handleShotAction('Miss', true)">üß± 7m verworfen</button>
            <button class="btn-error" onclick="handleAction('TechError', false)">‚ö†Ô∏è Technischer Fehler</button>
            
            <hr style="border-color: rgba(255,255,255,0.2); margin: 20px 0;">

            <button class="btn-error" onclick="handleAction('SEVEN_METER_CAUSED', false)">üö® 7m verursacht</button>
            
            <button class="btn-save-opp" onclick="handleGoalieAction('Save')">üß§ Parade Torwart</button>
            <button class="btn-save-opp" onclick="handleGoalieAction('SEVEN_METER_SAVE')">üß± 7m Gehalten</button>

            <button class="btn-opp-goal" onclick="logAction('OppGoal', null, false)">üü° Gegner Tor</button>
        </div>

        <div class="right-column-area">
            <div class="tab-nav">
                <button class="tab-button active" onclick="showTab('stats')">Live-Statistik</button>
                <button class="tab-button" onclick="showTab('log')">Protokoll</button>
            </div>

            <div id="stats-tab" class="tab-content active">
                
                <h3>Feldspieler-Statistik</h3>
                <div id="stats-table-container-field">
                    <p style="opacity: 0.6; text-align: center;">Lade Statistiken...</p>
                </div>
                
                <h3 style="margin-top: 20px;">Torwart-Statistik</h3>
                <div id="stats-table-container-goalie">
                    <p style="opacity: 0.6; text-align: center;">Lade Statistiken...</p>
                </div>

            </div>

            <div id="log-tab" class="tab-content">
                <h3>Protokoll Tabelle (Letzte Aktionen zuerst)</h3>
                <div id="action-log-container">
                    </div>
            </div>
        </div>
        
    </div>

    <script>
        const GAME_ID = {{ game_id }};
        const ACTION_LOG_CONTAINER = document.getElementById('action-log-container');
        const PLAYER_BUTTONS_CONTAINER = document.getElementById('player-buttons-container');
        const SCORE_BOARD = document.getElementById('score-board');
        const SELECTED_PLAYER_INFO = document.getElementById('selected-player-info');
        const STATS_TABLE_CONTAINER_FIELD = document.getElementById('stats-table-container-field');
        const STATS_TABLE_CONTAINER_GOALIE = document.getElementById('stats-table-container-goalie');

        let players = []; 
        let selectedPlayerId = null; 

        // Hilfsfunktionen
        function getToken() { return localStorage.getItem('access_token'); }
        function leaveProtocol() {
            localStorage.removeItem('protocol_game_id');
            window.location.href = "/app/dashboard"; 
        }
        
        // Tab-Umschaltfunktion
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            if (tabName === 'stats') {
                document.getElementById('stats-tab').classList.add('active');
                document.querySelector('.tab-button[onclick="showTab(\'stats\')"]').classList.add('active');
                loadStats(); 
            } else {
                document.getElementById('log-tab').classList.add('active');
                document.querySelector('.tab-button[onclick="showTab(\'log\')"]').classList.add('active');
                loadActionLog(); 
            }
        }
        
        // Kombinierte Aktualisierungsfunktion
        function updateAllStats() {
            updateScoreDisplay();
            if (document.getElementById('stats-tab').classList.contains('active')) {
                loadStats();
            }
            if (document.getElementById('log-tab').classList.contains('active')) {
                loadActionLog();
            }
        }

        
        // --- Spieler-Auswahl ---
        function selectPlayer(playerId, playerName, isGoalie) {
            selectedPlayerId = playerId;
            SELECTED_PLAYER_INFO.textContent = playerName;

            document.querySelectorAll('.player-list button').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.getElementById(`player-btn-${playerId}`).classList.add('selected');
        }

        
        // --- Aktion verarbeiten: Feldspieler ---
        function handleAction(actionType, isGoalieAction) {
            if (selectedPlayerId === null) {
                 alert("Bitte w√§hle zuerst einen Spieler aus der Liste (links).");
                 return;
            }
            logAction(actionType, selectedPlayerId, false, false);
        }
        
        // Aktion verarbeiten: Wurfaktionen (Unterscheidet 7m)
        function handleShotAction(actionType, isSevenMeter) {
            if (selectedPlayerId === null) {
                 alert("Bitte w√§hle zuerst einen Spieler aus der Liste (links).");
                 return;
            }
            logAction(actionType, selectedPlayerId, isSevenMeter, false);
        }
        
        // Aktion verarbeiten: Torwart
        function handleGoalieAction(actionType) {
            const selectedPlayer = players.find(p => p.id === selectedPlayerId);
            
            if (!selectedPlayer || selectedPlayer.position !== 'Torwart') {
                alert("Bitte w√§hle zuerst einen Torwart f√ºr diese Aktion aus.");
                return;
            }

            logAction(actionType, selectedPlayerId, false, false);
        }

        
        // --- Aktion protokollieren (Sendet an Backend) ---
        async function logAction(actionType, playerId = null, isSevenMeter = false, requiresConfirmation = false) {
            const token = getToken();
            if (!token) return leaveProtocol();

            if (requiresConfirmation && !confirm(`Aktion: ${actionType} protokollieren?`)) {
                return;
            }

            const payload = {
                action_type: actionType,
                time_in_game: "N/A", 
                game_id: GAME_ID,
                player_id: playerId,
                is_seven_meter: isSevenMeter
            };

            try {
                const response = await fetch('/actions/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload),
                });

                if (response.ok) {
                    updateAllStats(); 
                } else if (response.status === 401 || response.status === 403) {
                    leaveProtocol();
                } else {
                    alert('Fehler beim Protokollieren der Aktion.');
                }
            } catch (error) {
                console.error('Protokollfehler:', error);
            }
        }
        
        // Aktion l√∂schen
        async function deleteAction(actionId) {
            if (!confirm("Sind Sie sicher, dass Sie diese Aktion l√∂schen m√∂chten?")) return;
            
            const token = getToken();
            if (!token) return leaveProtocol();

            try {
                const response = await fetch(`/actions/delete/${actionId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    updateAllStats(); 
                } else {
                    alert('Aktion konnte nicht gel√∂scht werden.');
                }
            } catch (error) {
                console.error('L√∂schfehler:', error);
            }
        }

        
        // --- Score aktualisieren ---
        async function updateScoreDisplay() {
            const token = getToken();
            if (!token) return;

            try {
                const response = await fetch(`/actions/list/${GAME_ID}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const actions = await response.json();

                let ownGoals = 0;
                let opponentGoals = 0;

                actions.forEach(action => {
                    if (action.action_type === 'Goal' || action.action_type === 'Goal_7m') {
                        ownGoals++;
                    } else if (action.action_type === 'OppGoal') {
                        opponentGoals++;
                    }
                });

                SCORE_BOARD.textContent = `${ownGoals} - ${opponentGoals}`;
            } catch (error) {
                console.error("Score Update Fehler:", error);
            }
        }

        
        // --- Protokoll laden (Als Tabelle) ---
        async function loadActionLog() {
            const token = getToken();
            if (!token) return;

            try {
                const response = await fetch(`/actions/list/${GAME_ID}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const actions = await response.json();
                
                if (actions.length === 0) {
                    ACTION_LOG_CONTAINER.innerHTML = '<p style="text-align: center; opacity: 0.7;">Noch keine Aktionen protokolliert.</p>';
                    return;
                }
                
                let tableHtml = `<table class="log-table">
                                    <thead>
                                        <tr>
                                            <th>Aktion</th>
                                            <th>Spieler</th>
                                            <th>#</th>
                                            <th>L√∂schen</th>
                                        </tr>
                                    </thead>
                                    <tbody>`;

                actions.forEach(action => {
                    const actionText = {
                        'Goal': '‚öΩ TOR (Feld)',
                        'Miss': 'üí® Fehlwurf (Feld)',
                        'Goal_7m': 'üéØ TOR (7m)', 
                        'Miss_7m': 'üß± Fehlwurf (7m)', 
                        'TechError': 'üö´ Technischer Fehler',
                        'Save': 'üõë Parade',
                        'OppGoal': 'üü° Gegner Tor',
                        'SEVEN_METER_CAUSED': 'üö® 7m verursacht',
                        'SEVEN_METER_SAVE': 'üß± 7m Gehalten',
                        'Timeout': '‚è±Ô∏è Timeout',
                    }[action.action_type] || action.action_type;

                    const playerInfo = action.player_name || 'TEAM';
                    const playerNumber = action.player_number !== null ? action.player_number : '';

                    tableHtml += `
                        <tr>
                            <td>${actionText}</td>
                            <td>${playerInfo}</td>
                            <td>${playerNumber}</td>
                            <td>
                                <button class="btn-delete-log" onclick="deleteAction(${action.id})">L√∂schen</button>
                            </td>
                        </tr>`;
                });
                
                tableHtml += `</tbody></table>`;
                ACTION_LOG_CONTAINER.innerHTML = tableHtml;


            } catch (error) {
                console.error('Fehler beim Laden des Logs:', error);
            }
        }
        
        // --- Kader laden und Buttons generieren ---
        async function loadPlayers() {
            const token = getToken();
            if (!token) return leaveProtocol();

            try {
                const response = await fetch(`/players/list/${GAME_ID}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Fehler beim Laden des Kaders.');
                
                players = await response.json();
                PLAYER_BUTTONS_CONTAINER.innerHTML = '';

                if (players.length === 0) {
                    PLAYER_BUTTONS_CONTAINER.innerHTML = '<p style="text-align: center;">Kader ist leer. Bitte im Dashboard Spieler hinzuf√ºgen.</p>';
                    return;
                }

                players.forEach(player => {
                    const isGoalie = player.position === 'Torwart';
                    const button = document.createElement('button');
                    button.textContent = `#${player.number || '?'} ${player.name}`;
                    button.className = isGoalie ? 'goalkeeper' : '';
                    button.id = `player-btn-${player.id}`;
                    
                    button.onclick = () => selectPlayer(player.id, player.name, isGoalie); 
                    
                    PLAYER_BUTTONS_CONTAINER.appendChild(button);
                });
                
            } catch (error) {
                PLAYER_BUTTONS_CONTAINER.innerHTML = '<p style="text-align: center; color: #ff6666;">Kader konnte nicht geladen werden.</p>';
                console.error(error);
            }
        }

        // --- Statistik-Tabelle laden (KOMPLETT √úBERARBEITET) ---
        async function loadStats() {
            const token = getToken();
            if (!token) return;

            STATS_TABLE_CONTAINER_FIELD.innerHTML = '<p style="opacity: 0.6; text-align: center;">Aktualisiere Statistiken...</p>';
            STATS_TABLE_CONTAINER_GOALIE.innerHTML = '<p style="opacity: 0.6; text-align: center;">Aktualisiere Statistiken...</p>';

            try {
                const response = await fetch(`/actions/stats/${GAME_ID}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Statistikdaten konnten nicht abgerufen werden.');
                
                const stats = await response.json();
                
                if (stats.length === 0) {
                    STATS_TABLE_CONTAINER_FIELD.innerHTML = '<p style="opacity: 0.6; text-align: center;">Keine Spielerdaten verf√ºgbar.</p>';
                    STATS_TABLE_CONTAINER_GOALIE.innerHTML = '<p style="opacity: 0.6; text-align: center;">Keine Torwartdaten verf√ºgbar.</p>';
                    return;
                }

                // --- KORREKTUR FELD FELDPIELER ---
                // Header f√ºr Feldspieler (7m angepasst)
                let fieldHeaders = [
                    { key: 'player_name', name: 'Spieler', isFixed: true },
                    { key: 'player_number', name: '#', isFixed: true },
                    { key: 'goals', name: 'Tore (Quote)' },
                    { key: 'misses', name: 'Fehlw√ºrfe' },
                    { key: 'tech_errors', name: 'Tech. Fehler' },
                    { key: 'seven_meter_stats', name: '7M (T/V | QUOTE)' }, // NEU
                    { key: 'seven_meter_caused', name: '7m Verursacht' },
                ];
                
                // Header f√ºr Torwart (Namen angepasst)
                let goalieHeaders = [
                    { key: 'player_name', name: 'Spieler', isFixed: true },
                    { key: 'player_number', name: '#', isFixed: true },
                    { key: 'saves', name: 'Paraden (QUOTE)' },          // NEU
                    { key: 'seven_meter_saves', name: '7m Gehalten (QUOTE)' }, // NEU
                    { key: 'opponent_goals', name: 'Gegentore' }, 
                ];
                
                let fieldTableHtml = `<table class="stats-table"><thead><tr>`;
                fieldHeaders.forEach(h => { fieldTableHtml += `<th>${h.name}</th>`; });
                fieldTableHtml += `</tr></thead><tbody>`;

                let goalieTableHtml = `<table class="stats-table"><thead><tr>`;
                goalieHeaders.forEach(h => { goalieTableHtml += `<th>${h.name}</th>`; });
                goalieTableHtml += `</tr></thead><tbody>`;

                let fieldPlayersFound = false;
                let goaliesFound = false;

                stats.forEach(player => {
                    if (player.position === 'Torwart') {
                        // --- TORWART-TABELLE ---
                        goaliesFound = true;
                        goalieTableHtml += `<tr>`;
                        
                        goalieHeaders.forEach(h => {
                            let value = player[h.key] !== undefined ? player[h.key] : 0;
                            
                            // NEU: Quote f√ºr Paraden
                            if (h.key === 'saves') {
                                const saves = player.saves || 0;
                                const opp_goals = player.opponent_goals || 0; // Kommt jetzt vom Backend
                                const total_shots = saves + opp_goals;
                                const quote = total_shots > 0 ? ((saves / total_shots) * 100).toFixed(0) + '%' : '‚Äî';
                                value = `${saves} (${quote})`;
                            }
                            // NEU: Quote f√ºr 7m Gehalten
                            else if (h.key === 'seven_meter_saves') {
                                const sm_saves = player.seven_meter_saves || 0;
                                // Backend liefert Gesamtzahl 7m (aus 7m_verursacht) in diesem Feld f√ºr Torh√ºter
                                const sm_faced = player.seven_meter_caused || 0; 
                                const quote = sm_faced > 0 ? ((sm_saves / sm_faced) * 100).toFixed(0) + '%' : '‚Äî';
                                value = `${sm_saves} (${quote})`;
                            }
                            
                            goalieTableHtml += `<td>${value}</td>`;
                        });
                        goalieTableHtml += `</tr>`;
                        
                    } else {
                        // --- FELDSPIELER-TABELLE ---
                        fieldPlayersFound = true;
                        fieldTableHtml += `<tr>`;
                        
                        fieldHeaders.forEach(h => {
                            let value = player[h.key] !== undefined ? player[h.key] : 0;
                            
                            // Spezielle Behandlung f√ºr Tore/Quote (Gesamt)
                            if (h.key === 'goals') {
                                const totalShots = (player.goals || 0) + (player.misses || 0) + (player.seven_meter_goals || 0) + (player.seven_meter_misses || 0);
                                const totalGoals = (player.goals || 0) + (player.seven_meter_goals || 0);
                                const quote = totalShots > 0 ? ((totalGoals / totalShots) * 100).toFixed(0) + '%' : '‚Äî';
                                value = `${totalGoals} (${quote})`;
                            }
                            // NEU: Spezielle Behandlung f√ºr 7m (T/V | Quote)
                            else if (h.key === 'seven_meter_stats') {
                                const sm_goals = player.seven_meter_goals || 0;
                                const sm_misses = player.seven_meter_misses || 0;
                                const sm_total = sm_goals + sm_misses;
                                const quote = sm_total > 0 ? ((sm_goals / sm_total) * 100).toFixed(0) + '%' : '‚Äî';
                                // Format: T / V (Quote)
                                value = `${sm_goals} / ${sm_misses} (${quote})`;
                            }
                            
                            fieldTableHtml += `<td>${value}</td>`;
                        });
                        fieldTableHtml += `</tr>`;
                    }
                });

                fieldTableHtml += `</tbody></table>`;
                goalieTableHtml += `</tbody></table>`;
                
                STATS_TABLE_CONTAINER_FIELD.innerHTML = fieldPlayersFound ? fieldTableHtml : '<p style="opacity: 0.6; text-align: center;">Keine Feldspieler im Kader.</p>';
                STATS_TABLE_CONTAINER_GOALIE.innerHTML = goaliesFound ? goalieTableHtml : '<p style="opacity: 0.6; text-align: center;">Keine Torh√ºter im Kader.</p>';

            } catch (error) {
                STATS_TABLE_CONTAINER_FIELD.innerHTML = `<p class="error">FEHLER beim Laden der Statistik.</p>`;
                STATS_TABLE_CONTAINER_GOALIE.innerHTML = '';
                console.error("Statistikfehler:", error);
            }
        }
        // --- ENDE KORREKTUR ---
        
        // --- Seite initialisieren ---
        async function initializeProtocol() {
            await loadPlayers();
            
            // Lade den Rest
            updateAllStats(); // Ruft loadStats und loadActionLog auf
        }
        
        initializeProtocol();
    </script>

</body>
</html>