<style>
    /* * Diese Stile sind 1:1 aus app_layout.html / season_analysis.html kopiert,
     * damit die Wurfbilder und Tabellen im Modal korrekt aussehen.
     */
    .shot-chart-container-half,
    .shot-chart-container-full {
        position: relative; width: 100%;
        background-color: #ffffff; border: 2px solid #000;
        box-sizing: border-box; border-radius: 5px;
        overflow: hidden; margin-top: 15px;
    }
    .shot-chart-container-full {
        /* Im Scouting-Modal wollen wir nur Ganzfeld */
        max-width: 700px;
        margin-left: auto;
        margin-right: auto;
    }
    .svg-handball-pitch {
        width: 100%;
        height: auto;
        display: block;
        z-index: 1; 
    }
    .shot-overlay {
        position: absolute; top: 0; left: 0;
        width: 100%; height: 100%;
        z-index: 2; 
    }
    .shot-overlay p { color: #000; opacity: 0.7; }
    
    .stats-table tfoot tr {
        background-color: rgba(0,0,0,0.3); 
        font-weight: bold; 
        border-top: 2px solid #ffcc00;
    }
    .shot-dot {
        position: absolute; width: 12px; height: 12px;
        border-radius: 50%; transform: translate(-50%, -50%);
        border: 2px solid rgba(0,0,0,0.7);
        box-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }
    .shot-dot.goal { background-color: #38E838; }
    .shot-dot.miss { background-color: #f44336; }
    .shot-dot.tech-error-pass { background-color: #ff9800; }
    .shot-dot.opp-goal { background-color: #9E9E9E; }
    .shot-dot.opp-miss { background-color: #795548; }
    
    .shot-chart-legend {
        display: flex; justify-content: center;
        gap: 20px; margin-top: 15px;
        color: white; /* Legenden-Text im Modal ist wei√ü */
    }
    .legend-item { display: flex; align-items: center; }
    .legend-color-box {
        width: 15px; height: 15px;
        margin-right: 8px; border: 1px solid rgba(255,255,255,0.5);
        border-radius: 3px;
    }
    .legend-color-box.goal { background-color: #38E838; }
    .legend-color-box.miss { background-color: #f44336; }
    .legend-color-box.tech-error-pass { background-color: #ff9800; }
    .legend-color-box.opp-goal { background-color: #9E9E9E; }
    .legend-color-box.opp-miss { background-color: #795548; }
    
    /* ================================================== */
    /* (PHASE 9): Stile f√ºr Scouting-Berichte */
    /* ================================================== */
    #scouting-reports-list {
        margin-top: 15px;
        max-height: 300px;
        overflow-y: auto;
    }
    .report-item {
        background: rgba(0, 0, 0, 0.2);
        padding: 12px 15px;
        border-radius: 5px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .report-item-info strong {
        display: block;
        font-size: 1.1em;
        color: #fff;
    }
    .report-item-info span {
        font-size: 0.9em;
        opacity: 0.7;
    }
    .report-item-actions .btn {
        margin-top: 0;
        margin-left: 10px;
        padding: 5px 10px;
        font-size: 0.9em;
    }
    
    /* Stile f√ºr das Editor-Modal */
    #report-editor-modal .modal-content {
        max-width: 800px; /* Breiter f√ºr Text-Editor */
    }
    #report-editor-modal textarea {
        width: 100%;
        box-sizing: border-box;
        padding: 10px;
        font-family: system-ui, sans-serif;
        font-size: 1em;
        border-radius: 5px;
        border: 1px solid #ccc;
        background: #f0f0f0;
        color: #333;
        resize: vertical; /* Erlaube Gr√∂√üen√§nderung in der H√∂he */
    }
</style>

<div class="analysis-grid-1-col">
    <div class="card">
        <div class="card-content">
            <h2>Liga-Scouting</h2>
            <label for="public-league-select">√ñffentliche Liga ausw√§hlen:</label>
            <select id="public-league-select" onchange="loadPublicTeams(this.value)">
                <option value="" disabled selected>Lade Ligen...</option>
            </select>
            <p style="font-weight: bold; margin-top: 10px; color: #ffcc00;">Teams in dieser Liga:</p>
            <div id="public-teams-list" style="max-height: 400px; overflow-y: auto;">
                <p style="opacity: 0.6;">Bitte eine Liga ausw√§hlen.</p>
            </div>
        </div>
    </div>
</div>

<div id="scouting-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h2 id="scouting-team-name" style="color: #38E838;"></h2>
        <p style="opacity: 0.8; margin-bottom: 20px;">Aggregierte Saison-Statistik (√ñffentlich)</p>

        <div class="card" style="background: #1a335c; padding: 10px; margin-bottom: 15px;">
            <div class="card-content">
                <h3 style="margin-top: 0px;">Gegner-Statistik (Saison)</h3>
                <div id="public-stats-table-opponent-season">
                    <p style="opacity: 0.6; text-align: center;">Lade Statistik...</p>
                </div>
            </div>
        </div>

        <div class="card" style="background: #1a335c; padding: 10px; margin-bottom: 15px;">
            <div class="card-content">
                <h3 style="margin-top: 0px;">Feldspieler-Statistik</h3>
                <div class="stats-table-container" id="public-stats-table-field-season">
                    <p style="opacity: 0.6; text-align: center;">Lade Statistik...</p>
                </div>
            </div>
        </div>
        
        <div class="card" style="background: #1a335c; padding: 10px; margin-bottom: 15px;">
            <div class="card-content">
                <h3 style="margin-top: 0px;">Torwart-Statistik</h3>
                <div class="stats-table-container" id="public-stats-table-goalie-season"></div>
            </div>
        </div>

        <div class="card" style="background: #1a335c; padding: 10px; margin-bottom: 15px;">
            <div class="card-content">
                <h3 style="margin-top: 0px;">Team-Aktionen Statistik</h3>
                <div class="stats-table-container" id="public-stats-table-custom-season"></div>
            </div>
        </div>
        
        <hr style="border-color: rgba(255,255,255,0.2); margin: 30px 0;">
        <h2 style="color: #38E838;">Wurf-Analyse (√ñffentlich)</h2>

        <div class="card" style="margin-top: 20px; background: #1a335c; padding: 10px;">
            <div class="card-content">
                <h3 style="color: #ffcc00;">Eigenes Wurfbild (Team)</h3>
                <label for="public-shot-chart-player-select">Spieler ausw√§hlen:</label>
                <select id="public-shot-chart-player-select">
                    <option value="all" selected>Alle Spieler</option>
                </select>
                <div class="shot-chart-container-full">
                    <img src="/static/ganzfeld.svg" class="svg-handball-pitch" alt="Handball-Ganzfeld">
                    <div class="shot-overlay" id="public-shot-chart-overlay"></div>
                </div>
                <div class="shot-chart-legend">
                    <div class="legend-item"><span class="legend-color-box goal"></span> <span>Tor</span></div>
                    <div class="legend-item"><span class="legend-color-box miss"></span> <span>Fehlwurf</span></div>
                </div>
            </div>
        </div>
        
        <div class="card" style="margin-top: 20px; background: #1a335c; padding: 10px;">
            <div class="card-content">
                <h3 style="color: #ffcc00;">Eigenes Fehlerbild (Team)</h3>
                <label for="public-error-chart-player-select">Spieler ausw√§hlen:</label>
                <select id="public-error-chart-player-select">
                    <option value="all" selected>Alle Spieler</option>
                </select>
                <div class="shot-chart-container-full">
                    <img src="/static/ganzfeld.svg" class="svg-handball-pitch" alt="Handball-Ganzfeld">
                    <div class="shot-overlay" id="public-error-chart-overlay"></div>
                </div>
                <div class="shot-chart-legend">
                    <div class="legend-item"><span class="legend-color-box miss"></span> <span>Tech. Fehler</span></div>
                    <div class="legend-item"><span class="legend-color-box tech-error-pass"></span> <span>Fehlpass</span></div>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 20px; background: #1a335c; padding: 10px;">
            <div class="card-content">
                <h3 style="color: #ffcc00;">Gegner Wurfbild (Team)</h3>
                <div class="shot-chart-container-full">
                    <img src="/static/ganzfeld.svg" class="svg-handball-pitch" alt="Handball-Ganzfeld">
                    <div class="shot-overlay" id="public-opponent-shot-chart-overlay"></div>
                </div>
                <div class="shot-chart-legend">
                    <div class="legend-item"><span class="legend-color-box opp-goal"></span> <span>Gegner Tor</span></div>
                    <div class="legend-item"><span class="legend-color-box opp-miss"></span> <span>Gegner Fehlwurf</span></div>
                </div>
            </div>
        </div>
        
        <hr style="border-color: rgba(255,255,255,0.2); margin: 30px 0;">
        <h2 style="color: #38E838;">Qualitative Scouting-Berichte (Meine Notizen)</h2>
        
        <input type="hidden" id="scouting-modal-opponent-name">
        <input type="hidden" id="scouting-modal-my-team-id">

        <button class="btn btn-primary" onclick="openReportEditor(null)">
            Neuen Bericht f√ºr diesen Gegner schreiben
        </button>
        
        <div id="scouting-reports-list">
            <p style="opacity: 0.6; margin-top: 15px;">Lade Berichte...</p>
        </div>
        </div>
</div>

<div id="report-editor-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeReportEditor()">&times;</span>
        <h3 id="report-editor-title">Scouting-Bericht</h3>
        
        <div class="form-section active">
            <label for="report-title">Titel:</label>
            <input type="text" id="report-title" placeholder="z.B. Abwehr-Analyse vs. 6-0">
        </div>
        
        <div class="form-section active">
            <label for="report-opponent">Gegner (Teamname):</label>
            <input type="text" id="report-opponent" disabled style="background: #ccc;">
        </div>
        
        <div class="form-section active">
            <label for="report-game-select">Zugeh√∂riges Spiel (Optional):</label>
            <select id="report-game-select">
                <option value="">Kein spezifisches Spiel</option>
                </select>
        </div>
        
        <div class="form-section active">
            <label for="report-content">Inhalt (Notizen):</label>
            <textarea id="report-content" rows="12" placeholder="Qualitative Notizen..."></textarea>
        </div>
        
        <input type="hidden" id="report-editor-report-id">
        <button class="btn btn-primary btn-full-width" onclick="saveReport()">
            Bericht speichern
        </button>
        <div id="report-editor-message" class="message"></div>
    </div>
</div>


<script>
    // Globale Variablen (nur f√ºr Scouting)
    let publicSeasonShotData = [];
    let publicSeasonErrorData = [];
    
    // ==================================================
    // (PHASE 9): Globale Variablen f√ºr Berichte
    // ==================================================
    let myActiveTeamId = localStorage.getItem('selected_team_id');
    let currentScoutingOpponentName = null; // Name des Gegners im Modal
    let myTeamGames = []; // Cache f√ºr die Spiele des eigenen Teams
    let myScoutingReports = []; // Cache f√ºr die geladenen Berichte

    // Liga Scouting Elemente
    const publicLeagueSelect = document.getElementById('public-league-select');
    const publicTeamsList = document.getElementById('public-teams-list');
    const scoutingModal = document.getElementById('scouting-modal');
    const scoutingTeamName = document.getElementById('scouting-team-name');
    const publicStatsField = document.getElementById('public-stats-table-field-season');
    const publicStatsGoalie = document.getElementById('public-stats-table-goalie-season');
    const publicStatsCustom = document.getElementById('public-stats-table-custom-season');
    const publicStatsOpponent = document.getElementById('public-stats-table-opponent-season');
    
    // Public Chart DOM-Elemente
    const publicShotChartPlayerSelect = document.getElementById('public-shot-chart-player-select');
    const publicShotChartOverlay = document.getElementById('public-shot-chart-overlay');
    const publicErrorChartPlayerSelect = document.getElementById('public-error-chart-player-select');
    const publicErrorChartOverlay = document.getElementById('public-error-chart-overlay');
    const publicOpponentShotChartOverlay = document.getElementById('public-opponent-shot-chart-overlay');
    
    // ==================================================
    // (PHASE 9): DOM-Elemente f√ºr Berichts-Editor
    // ==================================================
    const scoutingReportsList = document.getElementById('scouting-reports-list');
    const scoutingModalOpponentName = document.getElementById('scouting-modal-opponent-name');
    const scoutingModalMyTeamId = document.getElementById('scouting-modal-my-team-id');
    
    const reportEditorModal = document.getElementById('report-editor-modal');
    const reportEditorTitle = document.getElementById('report-editor-title');
    const reportTitleInput = document.getElementById('report-title');
    const reportOpponentInput = document.getElementById('report-opponent');
    const reportGameSelect = document.getElementById('report-game-select');
    const reportContentInput = document.getElementById('report-content');
    const reportEditorReportId = document.getElementById('report-editor-report-id');
    const reportEditorMessage = document.getElementById('report-editor-message');


    // --- LIGA-SCOUTING FUNKTIONEN (Hierher verschoben) ---
    
    function closeModal() {
        scoutingModal.style.display = 'none';
        publicStatsField.innerHTML = '<p style="opacity: 0.6; text-align: center;">Lade Statistik...</p>';
        publicStatsGoalie.innerHTML = '';
        publicStatsCustom.innerHTML = '';
        publicStatsOpponent.innerHTML = '';
        publicShotChartOverlay.innerHTML = '';
        publicErrorChartOverlay.innerHTML = '';
        publicOpponentShotChartOverlay.innerHTML = '';
        publicShotChartPlayerSelect.innerHTML = '<option value="all" selected>Alle Spieler</option>';
        publicErrorChartPlayerSelect.innerHTML = '<option value="all" selected>Alle Spieler</option>';
    }
    
    scoutingModal.addEventListener('click', function(event) {
        if (event.target === scoutingModal) {
            closeModal();
        }
    });
    
    async function loadPublicLeagues() {
        publicLeagueSelect.innerHTML = '<option value="" disabled selected>Lade Ligen...</option>';
        try {
            const response = await fetch('/public/leagues');
            if (!response.ok) throw new Error("Ligen-API-Fehler");
            const leagues = await response.json();
            publicLeagueSelect.innerHTML = '<option value="" disabled selected>√ñffentliche Liga ausw√§hlen</option>';
            if (leagues.length === 0) {
                 publicLeagueSelect.innerHTML = '<option value="" disabled selected>Keine √∂ffentlichen Ligen gefunden.</option>';
                 publicTeamsList.innerHTML = '<p style="opacity: 0.6;">Keine Teams in √∂ffentlichen Ligen.</p>';
                 return;
            }
            leagues.forEach(league => {
                const option = document.createElement('option');
                option.value = league;
                option.textContent = league;
                publicLeagueSelect.appendChild(option);
            });
        } catch (error) {
            publicLeagueSelect.innerHTML = '<option value="" disabled selected>Fehler beim Laden.</option>';
            publicTeamsList.innerHTML = `<p class="error">Fehler beim Laden der Ligen.</p>`;
            console.error('Public Leagues Error:', error);
        }
    }
    
    // ==================================================
    // KORRIGIERTE `loadPublicTeams`-Funktion
    // ==================================================
    async function loadPublicTeams(leagueName) {
        if (!leagueName) return;
        publicTeamsList.innerHTML = '<p style="opacity: 0.6;">Lade Teams...</p>';
        try {
            const response = await fetch(`/public/teams/${encodeURIComponent(leagueName)}`);
            if (!response.ok) throw new Error("Teams-API-Fehler");
            const teams = await response.json();
            
            // KORREKTUR: Filtere ZUERST das eigene Team heraus
            const otherTeams = teams.filter(team => team.id != myActiveTeamId);
            
            publicTeamsList.innerHTML = ''; // Liste leeren
            
            // KORREKTUR: Pr√ºfe die L√ÑNGE der GEFILTERTEN Liste
            if (otherTeams.length === 0) {
                 publicTeamsList.innerHTML = '<p style="opacity: 0.6;">Keine *anderen* √∂ffentlichen Teams in dieser Liga gefunden.</p>';
                 return; // Beenden, da keine Teams anzuzeigen sind
            }
            
            // Iteriere √ºber die GEFILTERTE Liste
            otherTeams.forEach(team => {
                const teamItem = document.createElement('div');
                teamItem.className = 'league-team-item';
                teamItem.innerHTML = `<strong>${team.name}</strong>`;
                teamItem.onclick = () => showPublicTeamStats(team.id, team.name);
                publicTeamsList.appendChild(teamItem);
            });
            
        } catch (error) {
            publicTeamsList.innerHTML = `<p class="error">Fehler beim Laden der Teams.</p>`;
            console.error('Public Teams Error:', error);
        }
    }
    // ==================================================
    
    async function showPublicTeamStats(teamId, teamName) {
        if (!myActiveTeamId) {
            showToast("Bitte zuerst ein eigenes Team im Dashboard ausw√§hlen.", "error");
            return;
        }
        
        scoutingTeamName.textContent = teamName;
        scoutingModal.style.display = 'block';
        
        // Kontext f√ºr Scouting-Berichte setzen
        currentScoutingOpponentName = teamName;
        scoutingModalOpponentName.value = teamName;
        scoutingModalMyTeamId.value = myActiveTeamId;
        
        // Lade quantitative √∂ffentliche Daten
        publicStatsField.innerHTML = '<p style="opacity: 0.6; text-align: center;">Lade Statistik...</p>';
        publicStatsGoalie.innerHTML = '';
        publicStatsCustom.innerHTML = '';
        publicStatsOpponent.innerHTML = '<p style="opacity: 0.6; text-align: center;">Lade Statistik...</p>';
        publicShotChartOverlay.innerHTML = '<p style="opacity: 0.6; text-align: center; padding-top: 22%; color: black;">Lade Wurfbild...</p>';
        publicErrorChartOverlay.innerHTML = '<p style="opacity: 0.6; text-align: center; padding-top: 22%; color: black;">Lade Fehlerbild...</p>';
        publicOpponentShotChartOverlay.innerHTML = '<p style="opacity: 0.6; text-align: center; padding-top: 22%; color: black;">Lade Gegner-Wurfbild...</p>';

        // Lade qualitative private Berichte
        loadScoutingReports(myActiveTeamId, teamName);

        try {
            const [
                statsResponse,
                publicShotDataResponse,
                publicErrorDataResponse,
                publicOpponentShotDataResponse
            ] = await Promise.all([
                fetch(`/public/stats/season/${teamId}`),
                fetch(`/public/shots/season/${teamId}`),
                fetch(`/public/stats/errors/season/${teamId}`),
                fetch(`/public/shots/opponent/season/${teamId}`)
            ]);

            if (statsResponse.ok) {
                const stats = await statsResponse.json();
                displaySeasonPlayerStats(stats.player_stats, 'public-stats-table-');
                displaySeasonOpponentStats(stats.opponent_stats, publicStatsOpponent);
            } else { throw new Error('√ñffentliche Statistik konnte nicht geladen werden.'); }
            
            if (publicShotDataResponse.ok) {
                publicSeasonShotData = await publicShotDataResponse.json();
                renderShotChart('all', publicShotChartOverlay, publicSeasonShotData); 
                publicShotChartPlayerSelect.innerHTML = '<option value="all" selected>Alle Spieler</option>';
                publicSeasonShotData.forEach(playerData => {
                    const option = document.createElement('option');
                    option.value = playerData.player_id;
                    option.textContent = `#${playerData.player_number || '?'} ${playerData.player_name}`;
                    publicShotChartPlayerSelect.appendChild(option);
                });
            } else { publicShotChartOverlay.innerHTML = '<p class="error" style="text-align: center; padding-top: 22%; color: black;">Fehler beim Laden.</p>'; }
            
            if (publicErrorDataResponse.ok) {
                publicSeasonErrorData = await publicErrorDataResponse.json();
                renderErrorChart('all', publicErrorChartOverlay, publicSeasonErrorData); 
                publicErrorChartPlayerSelect.innerHTML = '<option value="all" selected>Alle Spieler</option>';
                publicSeasonErrorData.forEach(playerData => {
                    const option = document.createElement('option');
                    option.value = playerData.player_id;
                    option.textContent = `#${playerData.player_number || '?'} ${playerData.player_name}`;
                    publicErrorChartPlayerSelect.appendChild(option);
                });
            } else { publicErrorChartOverlay.innerHTML = '<p class="error" style="text-align: center; padding-top: 22%; color: black;">Fehler beim Laden.</p>'; }
            
            if (publicOpponentShotDataResponse.ok) {
                const publicOpponentData = await publicOpponentShotDataResponse.json();
                renderOpponentShotChart(publicOpponentShotChartOverlay, publicOpponentData);
            } else { publicOpponentShotChartOverlay.innerHTML = '<p class="error" style="text-align: center; padding-top: 22%; color: black;">Fehler beim Laden.</p>'; }
            
        } catch (error) {
            publicStatsField.innerHTML = `<p class="error">FEHLER: Statistik konnte nicht geladen werden.</p>`;
            publicStatsGoalie.innerHTML = '';
            publicStatsCustom.innerHTML = '';
            publicStatsOpponent.innerHTML = `<p class="error">FEHLER: Statistik konnte nicht geladen werden.</p>`;
            console.error('Public Stats Error:', error);
        }
    }
    
    // --- Abh√§ngigkeiten f√ºr das Modal ---
    // (Diese Funktionen werden vom Modal-Skript aufgerufen)
    function displaySeasonOpponentStats(stats, targetContainer) {
        if (!targetContainer) { return; }
        let tableHtml = `<table class="opponent-stats-table"><tbody>
            <tr><td>üü° Gegner Tore (Gesamt)</td><td>${stats.opponent_goals}</td></tr>
            <tr><td>üí® Gegner Fehlw√ºrfe</td><td>${stats.opponent_misses}</td></tr>
            <tr><td>üö´ Gegner Tech. Fehler</td><td>${stats.opponent_tech_errors}</td></tr>
        </tbody></table>`;
        targetContainer.innerHTML = tableHtml;
    }
    function displaySeasonPlayerStats(stats, containerPrefix) {
        const fieldContainer = document.getElementById(`${containerPrefix}field-season`);
        const goalieContainer = document.getElementById(`${containerPrefix}goalie-season`);
        const customContainer = document.getElementById(`${containerPrefix}custom-season`);
        if (!fieldContainer || !goalieContainer || !customContainer) { return; }
        let fieldHeaders = [{ key: 'player_name', name: 'Spieler', isFixed: true }, { key: 'player_number', name: '#', isFixed: true },{ key: 'games_played', name: 'Spiele' }, { key: 'goals', name: 'Tore (Quote)' }, { key: 'tore_pro_spiel', name: 'Tore/Spiel' }, { key: 'misses', name: 'Fehlw√ºrfe' },{ key: 'tech_errors', name: 'Tech. Fehler / Fehlp√§sse' }, { key: 'seven_meter_goals', name: '7m Tor' },{ key: 'seven_meter_misses', name: '7m Fehl' }, { key: 'seven_meter_caused', name: '7m Verursacht' }];
        let goalieHeaders = [{ key: 'player_name', name: 'Spieler', isFixed: true }, { key: 'player_number', name: '#', isFixed: true },{ key: 'games_played', name: 'Spiele' }, { key: 'saves', name: 'Paraden Ges. (Quote)' }, { key: 'seven_meter_saves', name: '7m-Quote' }];
        let fieldTableHtml = `<table class="stats-table"><thead><tr>`;
        fieldHeaders.forEach(h => { fieldTableHtml += `<th>${h.name}</th>`; });
        fieldTableHtml += `</tr></thead><tbody>`;
        let goalieTableHtml = `<table class="stats-table"><thead><tr>`;
        goalieHeaders.forEach(h => { goalieTableHtml += `<th>${h.name}</th>`; });
        goalieTableHtml += `</tr></thead><tbody>`;
        let fieldPlayersFound = false, goaliesFound = false;
        if (stats.length === 0) {
             fieldContainer.innerHTML = '<p style="opacity: 0.6; text-align: center;">Keine Spielerdaten.</p>';
             goalieContainer.innerHTML = '<p style="opacity: 0.6; text-align: center;">Keine Torwartdaten.</p>';
             customContainer.innerHTML = '<p style="opacity: 0.6; text-align: center;">Keine Team-Aktionen.</p>';
             return;
        }
        let totalGoals = 0, totalShots = 0, totalTechErrors = 0, totalFehlpaesse = 0, totalSevenMeterCaused = 0, totalSevenMeterAttempts = 0, totalSevenMeterGoals = 0, totalGamesPlayed = 0, totalFieldPlayers = 0;
        stats.forEach(player => {
            if (player.position === 'Torwart') {
                goaliesFound = true; goalieTableHtml += `<tr>`;
                goalieHeaders.forEach(h => {
                    let value = player[h.key] !== undefined ? player[h.key] : 0;
                    if (h.name === 'Paraden Ges. (Quote)') { const totalSaves = player.saves + player.seven_meter_saves; const totalGoalsReceived = player.opponent_goals_received + player.seven_meter_received; const totalShotsOnGoal = totalSaves + totalGoalsReceived; const quote = totalShotsOnGoal > 0 ? ((totalSaves / totalShotsOnGoal) * 100).toFixed(0) + '%' : '‚Äî'; value = `${totalSaves} (${quote})`; }
                    if (h.name === '7m-Quote') { const totalSevenMetersOnGoal = player.seven_meter_saves + player.seven_meter_received; const quote = totalSevenMetersOnGoal > 0 ? ((player.seven_meter_saves / totalSevenMetersOnGoal) * 100).toFixed(0) + '%' : '‚Äî'; value = `${player.seven_meter_saves} / ${totalSevenMetersOnGoal} (${quote})`; }
                    if (h.name === 'Tore (Quote)') { const totalShots = player.goals + player.misses + player.seven_meter_goals + player.seven_meter_misses; const totalGoals = player.goals + player.seven_meter_goals; const quote = totalShots > 0 ? ((totalGoals / totalShots) * 100).toFixed(0) + '%' : '‚Äî'; value = `${totalGoals} (${quote})`; }
                    if (h.name === 'Tore/Spiel') { if (player.games_played > 0) { const totalGoals = player.goals + player.seven_meter_goals; value = (totalGoals / player.games_played).toFixed(1); } else { value = '0.0'; } }
                    goalieTableHtml += `<td>${value}</td>`;
                });
                goalieTableHtml += `</tr>`;
            } else {
                fieldPlayersFound = true; totalFieldPlayers++; const currentTotalGoals = player.goals + player.seven_meter_goals; const currentTotalShots = currentTotalGoals + player.misses + player.seven_meter_misses;
                fieldTableHtml += `<tr>`;
                fieldHeaders.forEach(h => {
                    let value = player[h.key] !== undefined ? player[h.key] : 0;
                    if (h.name === 'Tore (Quote)') { const quote = currentTotalShots > 0 ? ((currentTotalGoals / currentTotalShots) * 100).toFixed(0) + '%' : '‚Äî'; value = `${currentTotalGoals} (${quote})`; }
                    if (h.name === 'Tore/Spiel') { if (player.games_played > 0) { value = (currentTotalGoals / player.games_played).toFixed(1); } else { value = '0.0'; } }
                    if (h.name === 'Fehlw√ºrfe') { value = player.misses + player.seven_meter_misses; }
                    if (h.name === 'Tech. Fehler / Fehlp√§sse') { value = `${player.tech_errors} / ${player.fehlpaesse}`; }
                    fieldTableHtml += `<td>${value}</td>`;
                });
                fieldTableHtml += `</tr>`;
                totalGoals += currentTotalGoals; totalShots += currentTotalShots; totalTechErrors += player.tech_errors; totalFehlpaesse += player.fehlpaesse; totalSevenMeterCaused += player.seven_meter_caused; totalSevenMeterAttempts += player.seven_meter_goals + player.seven_meter_misses; totalSevenMeterGoals += player.seven_meter_goals; totalGamesPlayed += player.games_played;
            }
        });
        const totalShotQuote = totalShots > 0 ? ((totalGoals / totalShots) * 100).toFixed(0) + '%' : '‚Äî'; const avgGames = totalFieldPlayers > 0 ? (totalGamesPlayed / totalFieldPlayers).toFixed(0) : 0; const avgGoalsPerGame = parseFloat(avgGames) > 0 ? (totalGoals / parseFloat(avgGames)).toFixed(1) : (totalGamesPlayed > 0 ? (totalGoals / totalGamesPlayed).toFixed(1) : "0.0");
        fieldTableHtml += `</tbody><tfoot><tr><td>TOTAL TEAM</td><td>-</td><td>${avgGames}</td><td>${totalGoals} (${totalShotQuote})</td><td>${avgGoalsPerGame}</td><td>${totalShots - totalGoals}</td><td>${totalTechErrors} / ${totalFehlpaesse}</td><td>${totalSevenMeterGoals}</td><td>${totalSevenMeterAttempts - totalSevenMeterGoals}</td><td>${totalSevenMeterCaused}</td></tr></tfoot></table>`;
        goalieTableHtml += `</tbody></table>`;
        fieldContainer.innerHTML = fieldPlayersFound ? fieldTableHtml : '<p style="opacity: 0.6; text-align: center;">Keine Feldspieler im Kader.</p>';
        goalieContainer.innerHTML = goaliesFound ? goalieTableHtml : '<p style="opacity: 0.6; text-align: center;">Keine Torh√ºter im Kader.</p>';
        const customActionNames = (stats.length > 0 && stats[0].custom_counts) ? Object.keys(stats[0].custom_counts) : [];
        if (customActionNames.length === 0) { customContainer.innerHTML = '<p style="opacity: 0.6; text-align: center;">Keine Team-Aktionen definiert.</p>'; } else {
            let customTableHtml = `<table class="stats-table"><thead><tr><th>Spieler</th><th>#</th><th>Spiele</th>`;
            customActionNames.forEach(name => { customTableHtml += `<th>${name}</th>`; });
            customTableHtml += `</tr></thead><tbody>`;
            stats.forEach(player => {
                if (player.position !== 'Torwart' && player.games_played > 0) {
                    customTableHtml += `<tr><td>${player.player_name}</td><td>${player.player_number || ''}</td><td>${player.games_played}</td>`; 
                    customActionNames.forEach(name => { customTableHtml += `<td>${player.custom_counts[name] || 0}</td>`; });
                    customTableHtml += `</tr>`;
                }
            });
            customTableHtml += `</tbody></table>`; customContainer.innerHTML = customTableHtml;
        }
    }
    
    // WICHTIG: renderShotChart, renderErrorChart, und renderOpponentShotChart
    // werden hier ben√∂tigt, da sie vom Modal-Code aufgerufen werden.
    
    function renderShotChart(playerId, targetOverlay, data) {
        targetOverlay.innerHTML = ''; let shotsToRender = [];
        if (playerId === 'all') { data.forEach(playerData => { shotsToRender.push(...playerData.shots); }); } else { const playerData = data.find(p => p.player_id == playerId); if (playerData) { shotsToRender = playerData.shots; } }
        const isHalfField = targetOverlay.parentElement.classList.contains('shot-chart-container-half'); 
        const emptyMessagePadding = isHalfField ? '45%' : '22%';
        if (shotsToRender.length === 0) { targetOverlay.innerHTML = `<p style="opacity: 0.6; text-align: center; padding-top: ${emptyMessagePadding}; color: black;">Keine Wurfdaten.</p>`; return; }
        shotsToRender.forEach(shot => {
            const dot = document.createElement('div'); const isGoal = shot.action_type === 'Goal' || shot.action_type === 'Goal_7m'; dot.className = `shot-dot ${isGoal ? 'goal' : 'miss'}`;
            if (shot.x_coordinate <= 50) { 
                if (isHalfField) { dot.style.left = `${shot.x_coordinate * 2}%`; } else { dot.style.left = `${shot.x_coordinate}%`; }
                dot.style.top = `${shot.y_coordinate}%`; targetOverlay.appendChild(dot);
            }
        });
    }
    function renderErrorChart(playerId, targetOverlay, data) {
        targetOverlay.innerHTML = ''; let errorsToRender = [];
        if (playerId === 'all') { data.forEach(playerData => { errorsToRender.push(...playerData.shots); }); } else { const playerData = data.find(p => p.player_id == playerId); if (playerData) { errorsToRender = playerData.shots; } }
        const isHalfField = targetOverlay.parentElement.classList.contains('shot-chart-container-half'); const emptyMessagePadding = isHalfField ? '45%' : '22%';
        if (errorsToRender.length === 0) { targetOverlay.innerHTML = `<p style="opacity: 0.6; text-align: center; padding-top: ${emptyMessagePadding}; color: black;">Keine Fehlerdaten.</p>`; return; }
        errorsToRender.forEach(error => {
            const dot = document.createElement('div'); const isFehlpass = error.action_type === 'Fehlpass'; dot.className = `shot-dot ${isFehlpass ? 'tech-error-pass' : 'miss'}`;
            dot.style.left = `${error.x_coordinate}%`; dot.style.top = `${error.y_coordinate}%`;
            targetOverlay.appendChild(dot);
        });
    }
    function renderOpponentShotChart(targetOverlay, data) {
        targetOverlay.innerHTML = ''; const shotsToRender = data;
        const isHalfField = targetOverlay.parentElement.classList.contains('shot-chart-container-half'); const emptyMessagePadding = isHalfField ? '45%' : '22%';
        if (shotsToRender.length === 0) { targetOverlay.innerHTML = `<p style="opacity: 0.6; text-align: center; padding-top: ${emptyMessagePadding}; color: black;">Keine Gegner-Wurfdaten.</p>`; return; }
        shotsToRender.forEach(shot => {
            const dot = document.createElement('div'); const isGoal = shot.action_type === 'OppGoal'; dot.className = `shot-dot ${isGoal ? 'opp-goal' : 'opp-miss'}`;
            if (shot.x_coordinate > 50) { 
                if (isHalfField) { const newX = (shot.x_coordinate - 50) * 2; dot.style.left = `${newX}%`; } else { dot.style.left = `${shot.x_coordinate}%`; }
                dot.style.top = `${shot.y_coordinate}%`; targetOverlay.appendChild(dot);
            }
        });
    }

    // ==================================================
    // NEU (PHASE 9): JS-Funktionen f√ºr Scouting-Berichte
    // ==================================================
    
    // 1. L√§dt die Spiele des EIGENEN Teams, um sie im Editor zu verkn√ºpfen
    async function loadMyTeamGames() {
        if (!myActiveTeamId) return;
        
        // Verhindert unn√∂tiges Neuladen, wenn die Spiele schon da sind
        if (myTeamGames.length > 0) {
            populateGameSelect(myTeamGames);
            return;
        } 
        
        try {
            const response = await fetch(`/games/list/${myActiveTeamId}`);
            if (response.status === 401) { logout(); return; }
            if (!response.ok) throw new Error('Eigene Spiele konnten nicht geladen werden.');
            
            myTeamGames = await response.json();
            populateGameSelect(myTeamGames);
            
        } catch (error) {
            console.error("Fehler beim Laden der eigenen Spiele:", error);
            reportGameSelect.innerHTML = '<option value="">Fehler beim Laden der Spiele</option>';
        }
    }
    
    // 2. Bef√ºllt das Dropdown im Editor-Modal
    function populateGameSelect(games) {
        reportGameSelect.innerHTML = '<option value="">Kein spezifisches Spiel</option>';
        games.forEach(game => {
            const option = document.createElement('option');
            option.value = game.id;
            option.textContent = `${game.date} vs. ${game.opponent}`;
            reportGameSelect.appendChild(option);
        });
    }

    // 3. L√§dt die privaten Berichte f√ºr den ausgew√§hlten Gegner
    async function loadScoutingReports(myTeamId, opponentName) {
        scoutingReportsList.innerHTML = '<p style="opacity: 0.6; margin-top: 15px;">Lade Berichte...</p>';
        try {
            const response = await fetch(`/scouting/list/${myTeamId}?opponent_name=${encodeURIComponent(opponentName)}`);
            if (response.status === 401) { logout(); return; }
            if (!response.ok) throw new Error('Berichte konnten nicht geladen werden.');
            
            myScoutingReports = await response.json(); // Berichte im Cache speichern
            
            scoutingReportsList.innerHTML = '';
            if (myScoutingReports.length === 0) {
                scoutingReportsList.innerHTML = '<p style="opacity: 0.6; margin-top: 15px;">Keine Berichte f√ºr diesen Gegner vorhanden.</p>';
                return;
            }
            
            myScoutingReports.forEach(report => {
                const item = document.createElement('div');
                item.className = 'report-item';
                
                const reportDate = new Date(report.created_at).toLocaleDateString('de-DE', {
                    day: '2-digit', month: '2-digit', year: 'numeric'
                });
                
                let gameInfo = `Erstellt: ${reportDate}`;
                if (report.game_date) {
                    gameInfo += ` | Verkn√ºpftes Spiel: ${report.game_date}`;
                }

                item.innerHTML = `
                    <div class="report-item-info">
                        <strong>${report.title}</strong>
                        <span>${gameInfo}</span>
                    </div>
                    <div class="report-item-actions">
                        <button class="btn btn-info" onclick="openReportEditor(${report.id})">Bearbeiten</button>
                        <button class="btn btn-danger" onclick="deleteReport(${report.id})">L√∂schen</button>
                    </div>
                `;
                scoutingReportsList.appendChild(item);
            });
            
        } catch (error) {
            console.error("Fehler beim Laden der Scouting-Berichte:", error);
            scoutingReportsList.innerHTML = '<p class="error">Fehler beim Laden der Berichte.</p>';
        }
    }

    // 4. √ñffnet das Editor-Modal (f√ºr neu oder bearbeiten)
    function openReportEditor(reportId) {
        reportEditorMessage.textContent = '';
        reportEditorMessage.className = 'message';
        
        // Spiele-Dropdown f√ºllen (nutzt Cache, wenn vorhanden)
        loadMyTeamGames();
        
        if (reportId === null) {
            // --- NEUER BERICHT ---
            reportEditorTitle.textContent = "Neuen Scouting-Bericht erstellen";
            reportEditorReportId.value = '';
            reportTitleInput.value = '';
            reportOpponentInput.value = currentScoutingOpponentName; // Aus globaler Variable
            reportGameSelect.value = '';
            reportContentInput.value = '';
        } else {
            // --- BERICHT BEARBEITEN ---
            reportEditorTitle.textContent = "Scouting-Bericht bearbeiten";
            const report = myScoutingReports.find(r => r.id === reportId);
            if (!report) {
                showToast("Fehler: Bericht nicht im Cache gefunden.", "error");
                return;
            }
            reportEditorReportId.value = report.id;
            reportTitleInput.value = report.title;
            reportOpponentInput.value = report.opponent_name;
            reportGameSelect.value = report.game_id || '';
            reportContentInput.value = report.content || '';
        }
        
        reportEditorModal.style.display = 'block';
    }

    // 5. Schlie√üt das Editor-Modal
    function closeReportEditor() {
        reportEditorModal.style.display = 'none';
    }
    
    // 6. Speichert einen neuen oder aktualisiert einen bestehenden Bericht
    async function saveReport() {
        if (!checkVerification()) return;
        
        const reportId = reportEditorReportId.value;
        const isUpdate = reportId !== '';
        
        const payload = {
            title: reportTitleInput.value,
            content: reportContentInput.value,
            opponent_name: reportOpponentInput.value,
            game_id: reportGameSelect.value ? parseInt(reportGameSelect.value) : null,
            team_id: parseInt(myActiveTeamId) // Nur f√ºr "create" n√∂tig, aber schadet nicht
        };
        
        if (!payload.title || !payload.opponent_name) {
            reportEditorMessage.textContent = '‚ùå Titel und Gegner-Name sind Pflichtfelder.';
            reportEditorMessage.className = 'message error';
            return;
        }
        
        reportEditorMessage.textContent = 'Speichere Bericht...';
        reportEditorMessage.className = 'message';
        
        const url = isUpdate ? `/scouting/update/${reportId}` : '/scouting/add';
        const method = isUpdate ? 'PUT' : 'POST';
        
        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (response.status === 401) { logout(); return; }
            
            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.detail || 'Fehler beim Speichern');
            }
            
            reportEditorMessage.textContent = '‚úÖ Bericht erfolgreich gespeichert.';
            reportEditorMessage.className = 'message success';
            
            // Lade die Berichtsliste im Haupt-Modal neu
            loadScoutingReports(myActiveTeamId, currentScoutingOpponentName);
            
            setTimeout(closeReportEditor, 1000);
            
        } catch (error) {
            console.error("Fehler beim Speichern des Berichts:", error);
            reportEditorMessage.textContent = `‚ùå ${error.message}`;
            reportEditorMessage.className = 'message error';
        }
    }
    
    // 7. L√∂scht einen Bericht
    async function deleteReport(reportId) {
        if (!checkVerification()) return;
        
        if (!confirm("Sind Sie sicher, dass Sie diesen Bericht endg√ºltig l√∂schen m√∂chten?")) {
            return;
        }
        
        try {
            const response = await fetch(`/scouting/delete/${reportId}`, {
                method: 'DELETE'
            });
            
            if (response.status === 401) { logout(); return; }
            if (!response.ok) throw new Error('Bericht konnte nicht gel√∂scht werden.');
            
            showToast("Bericht gel√∂scht.", "success");
            // Lade die Berichtsliste neu
            loadScoutingReports(myActiveTeamId, currentScoutingOpponentName);
            
        } catch (error) {
            console.error("Fehler beim L√∂schen des Berichts:", error);
            showToast(error.message, "error");
        }
    }
    // ==================================================
    // ENDE NEUE JS-FUNKTIONEN
    // ==================================================


    // --- Initialisierung ---
    function initLeagueScouting() {
        console.log("initLeagueScouting() wird aufgerufen.");
        myActiveTeamId = localStorage.getItem('selected_team_id');
        loadPublicLeagues();
        
        // (Event-Listener f√ºr das Schlie√üen des Editor-Modals)
        reportEditorModal.addEventListener('click', function(event) {
            if (event.target === reportEditorModal) {
                closeReportEditor();
            }
        });
    }
    
    publicShotChartPlayerSelect.addEventListener('change', (e) => {
        renderShotChart(e.target.value, publicShotChartOverlay, publicSeasonShotData);
    });
    publicErrorChartPlayerSelect.addEventListener('change', (e) => {
        renderErrorChart(e.target.value, publicErrorChartOverlay, publicSeasonErrorData);
    });
    
    initLeagueScouting();
</script>