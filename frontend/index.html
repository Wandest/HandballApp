<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>{{ title }}</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: linear-gradient(120deg, #1e3c72, #2a5298);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .container {
      background: rgba(255, 255, 255, 0.1);
      padding: 30px; 
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
      width: 350px; 
      text-align: center;
      box-sizing: border-box;
    }
    h1 {
        font-size: 1.8em; 
        margin-bottom: 20px; 
    }
    input[type="text"], 
    input[type="email"], 
    input[type="password"] {
      width: 90%; 
      padding: 10px; 
      margin: 8px 0; 
      border: none;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      font-size: 1em;
      box-sizing: border-box;
    }
    .form-group {
        position: relative;
    }
    .form-group .icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.2em;
    }
    .btn {
      width: 90%;
      padding: 12px;
      margin-top: 20px;
      border: none;
      border-radius: 5px;
      background-color: #ffcc00;
      color: #1e3c72;
      font-weight: bold;
      font-size: 1.1em;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .btn:hover:not(:disabled) {
      background-color: #ffd633;
    }
    .btn:disabled {
        background-color: #666;
        color: #bbb;
        cursor: not-allowed;
    }
    .message {
        margin-top: 15px;
        padding: 10px;
        border-radius: 5px;
        font-size: 0.9em;
    }
    .error {
        background: rgba(255, 102, 102, 0.2);
        color: #FF6666;
        border: 1px solid #FF6666;
    }
    .success {
        background: rgba(56, 232, 56, 0.2);
        color: #38E838;
        border: 1px solid #38E838;
    }
    a {
        color: #ffcc00;
        text-decoration: none;
        margin-top: 15px;
        display: block;
        font-size: 0.9em;
    }
    .mode-switch {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
    }
    .mode-switch button {
        background: none;
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 8px 15px;
        cursor: pointer;
        transition: background-color 0.2s, border-color 0.2s;
        font-weight: bold;
    }
    .mode-switch #mode-trainer {
        border-radius: 5px 0 0 5px;
    }
    .mode-switch #mode-player {
        border-radius: 0 5px 5px 0;
    }
    .mode-switch button.active {
        background-color: #ffcc00;
        color: #1e3c72;
        border-color: #ffcc00;
    }
    
    .alternative-link {
        color: #ffcc00;
        text-decoration: underline;
        cursor: pointer;
        margin-left: 5px;
    }

    /* NEU: Passwort Validierung Liste */
    .password-validation-list {
        text-align: left;
        padding: 10px 20px;
        margin-top: -5px;
        font-size: 0.9em;
    }
    .password-validation-list p {
        margin: 4px 0;
    }
    .status-icon {
        display: inline-block;
        width: 20px;
        text-align: center;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1 id="check-header">Trainer-Login</h1>
    <p id="check-info">(Trainer: Benutzername oder E-Mail / Spieler: Nur E-Mail)</p>
    
    <div id="username-check-view">
        <div class="mode-switch">
            <button id="mode-trainer" class="active" onclick="switchLoginMode('trainer')">Trainer</button>
            <button id="mode-player" onclick="switchLoginMode('player')">Spieler</button>
        </div>
        <form id="username-check-form">
            <input type="text" id="username-input" placeholder="Benutzername oder E-Mail" required>
            <button type="submit" id="check-button" class="btn">Weiter</button>
        </form>
        <div id="message-check" class="message"></div>
        <a href="/public/public-stats">Öffentliche Team-Analysen ansehen</a>
    </div>

    <div id="login-view" style="display: none;">
        <h2 id="login-header"></h2>
        <form id="login-form">
            <input type="password" id="password-login" placeholder="Passwort" required>
            <button type="submit" class="btn">Login</button>
        </form>
        <div id="message-login" class="message"></div>
        <a href="#" onclick="showUsernameCheckView(); return false;">&larr; Zurück</a>
    </div>

    <div id="register-view" style="display: none;">
        <h2 id="register-header">Registrieren</h2>
        <form id="register-form">
            
            <div class="form-group">
                <input type="text" id="username-reg" placeholder="Benutzername" required onkeyup="checkRegistrationUsernameAvailability()">
                <span id="username-icon" class="icon"></span>
            </div>
            <div id="username-reg-status" style="font-size: 0.8em; margin-bottom: 5px;"></div>
            
            <div class="form-group">
                <input type="email" id="email-reg" placeholder="E-Mail" required onkeyup="checkEmailAvailability()">
                <span id="email-icon" class="icon"></span>
            </div>

            <div class="form-group">
                <input type="password" id="password-reg" placeholder="Passwort" required onkeyup="validatePassword()">
                <span class="icon"></span> 
            </div>
            <div id="password-requirements" class="password-validation-list">
            </div> 

            <div class="form-group">
                <input type="password" id="confirm-password-reg" placeholder="Passwort bestätigen" required onkeyup="validatePassword()">
                <span id="match-icon" class="icon"></span>
            </div>
            
            <div style="text-align: left; margin: 15px 0 10px 0;">
                <input type="checkbox" id="terms-checkbox" onchange="updateRegisterButtonState()">
                <label for="terms-checkbox" style="display: inline; font-size: 0.9em; cursor: pointer;">Ich akzeptiere die <a href="#" style="display: inline; font-size: 1em;">AGB</a>.</label>
            </div>

            <button type="submit" id="register-button" class="btn" disabled>Jetzt registrieren</button>
        </form>
        <div id="message-reg" class="message"></div>
        <a href="#" onclick="showUsernameCheckView(); return false;">&larr; Zurück</a>
    </div>
    
  </div>

  <script>
    // --- View Management & Global State ---
    const checkView = document.getElementById('username-check-view');
    const loginView = document.getElementById('login-view');
    const registerView = document.getElementById('register-view');
    
    const usernameInput = document.getElementById('username-input');
    const usernameRegInput = document.getElementById('username-reg');
    const usernameIcon = document.getElementById('username-icon');
    const emailRegInput = document.getElementById('email-reg');
    const emailIcon = document.getElementById('email-icon');
    const matchIcon = document.getElementById('match-icon');
    const usernameRegStatusDiv = document.getElementById('username-reg-status');
    
    // HIER KORRIGIERT: Muss 'password-requirements' verwenden
    const passwordRequirementsDiv = document.getElementById('password-requirements'); 
    
    const termsCheckbox = document.getElementById('terms-checkbox'); 
    const messageCheckDiv = document.getElementById('message-check');
    const messageLoginDiv = document.getElementById('message-login');
    const messageRegDiv = document.getElementById('message-reg');
    const checkHeader = document.getElementById('check-header');
    const checkInfo = document.getElementById('check-info');

    let currentIdentifier = ''; 
    let isUsernameAvailable = false;
    let isEmailAvailable = false;
    let arePasswordsValid = false; // Steuert den Registrierungsbutton
    let loginMode = 'trainer'; 
    
    // --- 0. Hilfsfunktion: Button-Status aktualisieren ---
    function updateRegisterButtonState() {
        const button = document.getElementById('register-button');
        
        if (button) {
             button.disabled = !(arePasswordsValid && isUsernameAvailable && isEmailAvailable && termsCheckbox.checked);
        }
    }
    window.updateRegisterButtonState = updateRegisterButtonState;


    // --- View-Steuerung ---
    function showView(viewId, isPlayer = false) {
        checkView.style.display = 'none';
        loginView.style.display = 'none';
        registerView.style.display = 'none';
        document.getElementById(viewId).style.display = 'block';
        
        if (viewId === 'login-view') {
            const headerText = isPlayer ? 'Spieler-Login' : 'Trainer-Login';
            document.getElementById('login-header').textContent = headerText;
        }
        
        messageCheckDiv.textContent = '';
        messageLoginDiv.textContent = '';
        messageRegDiv.textContent = '';
    }

    function showUsernameCheckView() {
        showView('username-check-view');
        document.getElementById('register-form').reset();
        
        // Stellt sicher, dass der aktuelle Modus visuell aktiv ist
        document.getElementById('mode-trainer').classList.remove('active');
        document.getElementById('mode-player').classList.remove('active');
        document.getElementById(`mode-${loginMode}`).classList.add('active');
    }
    window.showUsernameCheckView = showUsernameCheckView;

    function showLoginView(isPlayer = false) {
        showView('login-view', isPlayer);
        
        const passwordLoginInput = document.getElementById('password-login');
        if (passwordLoginInput) {
             if (isPlayer) {
                 passwordLoginInput.placeholder = 'Passwort für ' + currentIdentifier;
             } else {
                 passwordLoginInput.placeholder = 'Passwort';
             }
             passwordLoginInput.focus();
        }
    }

    function showRegisterView() {
        const checkedIdentifier = usernameInput.value.trim();
        usernameRegInput.value = checkedIdentifier; 
        currentIdentifier = checkedIdentifier;

        showView('register-view');
        document.getElementById('register-header').textContent = `Registrieren für ${currentIdentifier}`;
        
        checkRegistrationUsernameAvailability(true);
        checkEmailAvailability(true);
        validatePassword(); // WICHTIG: Startet die Passwort-Validierung und zeigt die Regeln an
    }
    
    // --- Login Modus Wechsel ---
    function switchLoginMode(mode) {
        loginMode = mode;
        document.getElementById('mode-trainer').classList.remove('active');
        document.getElementById('mode-player').classList.remove('active');
        document.getElementById(`mode-${mode}`).classList.add('active');
        
        // UI anpassen
        if (mode === 'trainer') {
            checkHeader.textContent = 'Trainer-Login';
            checkInfo.innerHTML = '(Trainer: Benutzername oder E-Mail / Spieler: Nur E-Mail)';
            usernameInput.placeholder = 'Benutzername oder E-Mail';
            document.getElementById('check-button').textContent = 'Weiter';
        } else {
            checkHeader.textContent = 'Spieler-Login';
            checkInfo.innerHTML = '(Nur E-Mail-Adresse erlaubt)';
            usernameInput.placeholder = 'E-Mail-Adresse';
            document.getElementById('check-button').textContent = 'Login';
        }
        
        showUsernameCheckView(); // Reset zur Identifikationsprüfung
    }
    window.switchLoginMode = switchLoginMode; 

    // Initialisiere mit Trainer-Modus beim Laden der Seite
    document.addEventListener('DOMContentLoaded', () => {
        // checkLoginStatus() wird ganz unten aufgerufen
    });


    // --- 1. USERNAME CHECK FORM (Hybrider Check) ---
    document.getElementById('username-check-form').addEventListener('submit', async function(event) {
        event.preventDefault();

        currentIdentifier = usernameInput.value.trim();
        
        const usernameRegex = /^[a-zA-Z0-9]+$/;
        const isEmail = currentIdentifier.includes('@');
        
        // Modus-Validierung
        if (loginMode === 'player' && !isEmail) {
             messageCheckDiv.textContent = '❌ Im Spieler-Modus muss eine E-Mail-Adresse verwendet werden.';
             messageCheckDiv.className = 'message error';
             return;
        }
        if (loginMode === 'trainer' && !isEmail && !usernameRegex.test(currentIdentifier)) {
             messageCheckDiv.textContent = '❌ Der Benutzername darf nur Buchstaben und Zahlen enthalten.';
             messageCheckDiv.className = 'message error';
             return; 
        }
        
        messageCheckDiv.textContent = 'Prüfe Identifikation...';
        messageCheckDiv.className = 'message';

        try {
            const response = await fetch('/auth/check-username', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: currentIdentifier }),
            });

            const data = await response.json();
            
            if (data.exists) {
                // FALL 1: Benutzer gefunden (Trainer ODER Spieler)
                messageCheckDiv.textContent = '';
                
                const isPlayer = data.user_type === 'player'; 
                showLoginView(isPlayer); 
                
            } else {
                // FALL 2: Nichts gefunden
                messageCheckDiv.textContent = '';
                
                if (loginMode === 'player') {
                     messageCheckDiv.textContent = '❌ Spieler-Account nicht gefunden. Bitte warten Sie auf eine Einladung durch Ihren Trainer.';
                     messageCheckDiv.className = 'message error';
                } else {
                     usernameRegInput.value = currentIdentifier;
                     showRegisterView();
                }
            }

        } catch (error) {
            messageCheckDiv.textContent = '❌ Serverfehler beim Prüfen der Identifikation.';
            messageCheckDiv.className = 'message error';
            console.error('Error:', error);
        }
    });
    
    // --- 2. REGISTRIERUNG: E-MAIL VERFÜGBARKEIT SPRÜFUNG ---
    async function checkEmailAvailability() {
        const email = emailRegInput.value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        if (email.length < 5 || !emailRegex.test(email)) {
             isEmailAvailable = false;
             emailIcon.innerHTML = email.length > 0 ? '<span style="color: #FF6666;">❌</span>' : '';
             updateRegisterButtonState();
             return;
        }

        emailIcon.innerHTML = '<span style="color: lightgray;">...</span>';

        try {
            // NOTE: Diese Route war der 404 Fehler und wurde im Backend wiederhergestellt.
            const response = await fetch('/auth/check-email-availability', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email }),
            });
            const data = await response.json();

            if (data.available) {
                isEmailAvailable = true;
                emailIcon.innerHTML = '<span style="color: #38E838;">&#10003;</span>';
            } else {
                isEmailAvailable = false;
                emailIcon.innerHTML = '<span style="color: #FF6666;">❌</span>';
            }
        } catch (error) {
            isEmailAvailable = false;
            emailIcon.innerHTML = '<span style="color: #FF6666;">!</span>';
        }
        updateRegisterButtonState();
    }
    window.checkEmailAvailability = checkEmailAvailability;


    // --- 3. REGISTRIERUNG: USERNAME VERFÜGBARKEITSPRÜFUNG ---
    async function checkRegistrationUsernameAvailability(initialLoad = false) {
        const username = usernameRegInput.value;

        const usernameRegex = /^[a-zA-Z0-9]+$/;
        if (!usernameRegex.test(username)) {
            isUsernameAvailable = false;
            usernameIcon.innerHTML = '<span style="color: #FF6666;">!</span>';
            usernameRegStatusDiv.innerHTML = '<span style="color: #FF6666;">❌ Nur Buchstaben und Zahlen erlaubt!</span>';
            updateRegisterButtonState();
            return;
        }

        if (!initialLoad && username === currentIdentifier) {
            isUsernameAvailable = true;
            usernameIcon.innerHTML = '<span style="color: #38E838;">&#10003;</span>';
            usernameRegStatusDiv.innerHTML = '';
            updateRegisterButtonState();
            return;
        }
        
        usernameIcon.innerHTML = '<span style="color: lightgray;">...</span>';
        usernameRegStatusDiv.innerHTML = '<span style="color: lightgray;">Prüfe...</span>';
        currentIdentifier = username;

        try {
            // NOTE: Diese Route war der 404 Fehler und wurde im Backend wiederhergestellt.
            const response = await fetch('/auth/check-availability', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username }),
            });
            const data = await response.json();

            if (data.available) {
                isUsernameAvailable = true;
                usernameIcon.innerHTML = '<span style="color: #38E838;">&#10003;</span>';
                usernameRegStatusDiv.innerHTML = '';
            } else {
                isUsernameAvailable = false;
                usernameIcon.innerHTML = '<span style="color: #FF6666;">❌</span>';
                let altHtml = '<span style="color: #FF6666;">❌ Schon vergeben. Vorschläge:</span> ';
                
                data.alternatives.forEach(alt => {
                    altHtml += `<span class="alternative-link" onclick="setUsername('${alt}')">${alt}</span>`;
                });
                usernameRegStatusDiv.innerHTML = altHtml;
            }
        } catch (error) {
            isUsernameAvailable = false;
            usernameIcon.innerHTML = '<span style="color: #FF6666;">!</span>';
            usernameRegStatusDiv.innerHTML = '<span style="color: #FF6666;">Fehler bei der Prüfung.</span>';
            console.error('Error:', error);
        }
        updateRegisterButtonState();
    }
    window.checkRegistrationUsernameAvailability = checkRegistrationUsernameAvailability;
    
    function setUsername(newUsername) {
        usernameRegInput.value = newUsername;
        checkRegistrationUsernameAvailability();
    }
    window.setUsername = setUsername;


    // --- 4. PASSWORD VALIDATION (Behebt die fehlenden Restrictions) ---
    const requirements = [
        { id: 'req-length', regex: /.{8,}/, msg: 'Mindestens 8 Zeichen' },
        { id: 'req-upper', regex: /[A-Z]/, msg: 'Mindestens 1 Großbuchstabe' },
        { id: 'req-lower', regex: /[a-z]/, msg: 'Mindestens 1 Kleinbuchstabe' },
        { id: 'req-digit', regex: /\d/, msg: 'Mindestens 1 Ziffer' },
        { id: 'req-special', regex: /[@$!%*?&]/, msg: 'Mindestens 1 Sonderzeichen (@$!%*?&)' }
    ];

    const confirmPasswordField = document.getElementById('confirm-password-reg');
    const passwordField = document.getElementById('password-reg');
    
    function validatePassword() {
        if (!passwordField || !confirmPasswordField) return; 

        const password = passwordField.value;
        let allValid = true;
        let htmlContent = ''; 

        requirements.forEach(req => {
            const isValid = req.regex.test(password);
            // Korrekte Anzeige: Haken für gültig, Kasten für ungültig/leer
            const statusIcon = isValid ? '&#10003;' : '☐'; 
            const statusColor = isValid ? '#38E838' : 'lightgray';
            
            htmlContent += `<p style="color: ${statusColor};"><span class="status-icon">${statusIcon}</span> ${req.msg}</p>`;

            if (!isValid) { allValid = false; }
        });
        
        passwordRequirementsDiv.innerHTML = htmlContent;


        const passwordsMatch = password === confirmPasswordField.value && password.length > 0;
        
        // Gesamtgültigkeit ist die Summe aus allen Anforderungen UND Passwort-Match
        arePasswordsValid = allValid && passwordsMatch; 

        // Match Icon Logik
        if (password.length > 0 && confirmPasswordField.value.length > 0) {
            matchIcon.innerHTML = passwordsMatch ? '<span style="color: #38E838;">&#10003;</span>' : '<span style="color: #FF6666;">❌</span>';
        } else {
            matchIcon.innerHTML = '';
        }

        updateRegisterButtonState(); 
    }
    window.validatePassword = validatePassword;

    // --- 5. REGISTRATION SUBMISSION (Führt automatischen Login durch) ---
    document.getElementById('register-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        
        const registerButton = document.getElementById('register-button');
        if (registerButton.disabled) {
            messageRegDiv.textContent = '❌ Bitte stellen Sie sicher, dass alle Anforderungen erfüllt sind.';
            messageRegDiv.className = 'message error';
            return;
        }

        if (!isUsernameAvailable || !isEmailAvailable || !arePasswordsValid || !termsCheckbox.checked) {
            messageRegDiv.textContent = '❌ Validierungsfehler. Prüfen Sie alle Felder und akzeptieren Sie die AGB.';
            messageRegDiv.className = 'message error';
            return;
        }
        
        const username = usernameRegInput.value.trim();
        const email = emailRegInput.value;
        const password = passwordField.value;

        messageRegDiv.textContent = 'Registriere...';
        messageRegDiv.className = 'message';
        
        try {
            const response = await fetch('/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    username: username, 
                    email: email, 
                    password: password 
                }),
            });

            if (response.ok) {
                messageRegDiv.textContent = '✅ Registrierung erfolgreich. Logge automatisch ein...';
                
                await loginAndRedirect(username, password, messageRegDiv, true);
                
            } else {
                const data = await response.json(); 
                let detail = data.detail || 'Unbekannter Fehler';

                // Erweiterte Fehlerbehandlung für Passwort-Validierungsfehler vom Backend
                if (data.detail && typeof data.detail === 'string') {
                    if (data.detail.includes("value_error")) {
                         try {
                            // Versuche, die genaue Fehlermeldung aus dem FastAPI-Error zu extrahieren
                            detail = data.detail.split("value_error, msg='")[1].split("',")[0] || 'Validierungsfehler auf dem Server';
                         } catch (e) {
                            detail = "Passwortanforderungen nicht erfüllt.";
                         }
                    }
                } else if (Array.isArray(data.detail) && data.detail[0].msg) {
                    detail = data.detail[0].msg;
                }
                
                messageRegDiv.textContent = `❌ Fehler: ${detail}`;
                messageRegDiv.className = 'message error';
            }

        } catch (error) {
            messageRegDiv.textContent = '❌ Serverfehler bei der Registrierung (Netzwerk oder JSON-Parsing).';
            messageRegDiv.className = 'message error';
            console.error('Error:', error);
        }
    });

    // --- 6. HILFSFUNKTION: Login und Weiterleitung ---
    async function loginAndRedirect(identifier, password, messageDiv, isAutoLogin = false) {
        try {
            const response = await fetch('/auth/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: identifier, password: password }),
            });

            if (response.ok) {
                const data = await response.json();
                
                localStorage.setItem('logged_in_user_type', data.user_type);
                localStorage.setItem('logged_in_username', data.username);
                localStorage.setItem('is_verified', data.is_verified);
                
                messageDiv.innerHTML = `✅ Login erfolgreich! Leite weiter...`;
                messageDiv.className = 'message success';
                
                window.location.href = data.redirect_url; 
                
            } else {
                let detail = 'Unbekannter Fehler';
                try {
                    const data = await response.json();
                    detail = data.detail || `Fehler-Status: ${response.status}`;
                } catch (e) {
                    detail = `Server-Fehler: ${response.status} ${response.statusText}`;
                }

                if (isAutoLogin) {
                    // Automatischer Login-Versuch nach Registrierung fehlgeschlagen
                    messageDiv.innerHTML = `⚠️ Registrierung war erfolgreich, aber Auto-Login fehlgeschlagen: ${detail}. Bitte manuell einloggen.`;
                    messageDiv.className = 'message error';
                    showLoginView(false); 
                    document.getElementById('password-login').value = password;
                } else {
                    // Manueller Login-Versuch ist fehlgeschlagen
                    messageDiv.innerHTML = `❌ ${detail}`; 
                    messageDiv.className = 'message error';
                }
            }

        } catch (error) {
            messageDiv.textContent = '❌ Netzwerkfehler oder Server nicht erreichbar.';
            messageDiv.className = 'message error';
            console.error('Error:', error);
        }
    }


    // --- 7. LOGIN LOGIK ---
    document.getElementById('login-form').addEventListener('submit', async function(event) {
        event.preventDefault();

        const password = document.getElementById('password-login').value;
        
        messageLoginDiv.textContent = 'Logge ein...';
        messageLoginDiv.className = 'message';
        
        await loginAndRedirect(currentIdentifier, password, messageLoginDiv);
    });


    // --- 8. STATUS CHECK BEIM LADEN (Finaler Initialisierungspunkt) ---
    async function checkLoginStatus() {
        switchLoginMode('trainer'); 
    }
    
    document.addEventListener('DOMContentLoaded', checkLoginStatus);

  </script>

</body>
</html>