<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>{{ title }}</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: linear-gradient(120deg, #1e3c72, #2a5298);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .container {
      background: rgba(255, 255, 255, 0.1);
      padding: 30px; 
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
      width: 350px; 
      text-align: center;
      box-sizing: border-box;
    }
    h1 {
        font-size: 1.8em; 
        margin-bottom: 20px; 
    }
    input[type="text"], 
    input[type="email"], 
    input[type="password"] {
      width: 90%; 
      padding: 10px; 
      margin: 8px 0; 
      border: none;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      box-sizing: border-box; 
      font-size: 1em; 
    }
    button {
      width: 100%;
      padding: 10px; 
      margin-top: 20px; 
      border: none;
      border-radius: 5px;
      font-size: 1.1em; 
      background: #ffcc00; 
      color: #333; 
      cursor: pointer;
      transition: 0.2s;
      font-weight: normal; 
    }
    button:hover {
      background: #ffdd44; 
    }
    button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        background: #9e9e9e; 
        color: #fff; 
    }
    .message {
      margin-top: 15px; 
      font-weight: bold;
      font-size: 1em; 
    }
    .success { color: #38E838; }
    .error { color: #FF6666; }
    
    .form-group {
        display: flex; 
        align-items: center;
        width: 90%; 
        margin: 8px auto; 
        box-sizing: border-box;
    }
    .form-group input {
        flex-grow: 1; 
        margin: 0; 
        margin-right: 5px; 
    }
    .form-group .icon {
        width: 30px;
        text-align: right;
        font-size: 1.2em; 
        font-weight: bold;
        flex-shrink: 0; 
    }

    .password-validation-list {
        width: 90%; 
        margin: 5px auto 15px auto; 
        text-align: left;
        font-size: 0.8em; 
        line-height: 1.4; 
        color: lightgray;
    }
    .password-validation-list p {
        margin: 0 0 3px 0; 
        display: flex;
        align-items: center;
    }
    .password-validation-list .status-icon {
        font-size: 1.1em;
        margin-right: 5px;
        width: 15px;
        text-align: center;
    }
    
    .username-info {
        font-size: 0.8em; 
        margin-top: -5px; 
        margin-bottom: 5px; 
        text-align: left;
        padding-left: 5%; 
        color: lightgray;
    }
    .alternative-link {
        color: #ffcc00;
        cursor: pointer;
        text-decoration: underline;
        margin-left: 5px;
    }

    .terms-checkbox-group {
        display: flex;
        align-items: flex-start;
        margin-top: 20px; 
        font-size: 0.9em; 
        line-height: 1.4; 
        text-align: left;
        color: lightgray;
        width: 90%; 
        margin-left: auto; 
        margin-right: auto;
    }
    .terms-checkbox-group input[type="checkbox"] {
        margin-top: 2px; 
        margin-right: 8px; 
        width: 16px; 
        height: 16px;
        flex-shrink: 0;
        cursor: pointer;
    }
    .terms-checkbox-group a {
        color: #ffcc00; 
        text-decoration: underline; 
        font-weight: normal;
    }
    .terms-checkbox-group a:hover {
        text-decoration: none; 
    }

    .link-below-button {
        color: #ffcc00;
        cursor: pointer;
        text-decoration: underline;
        margin-top: 20px;
        display: block;
        font-size: 0.9em;
    }
    .link-below-button:hover {
        text-decoration: none;
    }

  </style>
</head>
<body>

  <div class="container">
    
    <div id="username-check-view" style="display: block;">
        <h1>Trainer-Login</h1>
        <form id="username-check-form">
            <input type="text" id="username-input" placeholder="Benutzername oder E-Mail" required>
            <p class="username-info">(Benutzername: Nur Buchstaben und Zahlen)</p>
            <button type="submit" id="check-button">Weiter</button>
        </form>
        <div id="message-check" class="message"></div>
    </div>
    
    <div id="login-view" style="display: none;">
        <h1 id="login-header">Login für...</h1>
        <form id="login-form">
            <input type="password" id="password-login" placeholder="Passwort" required>
            <button type="submit" id="login-button">Login</button>
        </form>
        <div id="message-login" class="message"></div>
        <a href="#" onclick="showUsernameCheckView()" class="link-below-button">
            Identifikation ändern
        </a>
    </div>

    <div id="register-view" style="display: none;">
        <h1 id="register-header">Registrieren für...</h1>
        
        <div class="form-group">
            <input type="text" id="username-reg" placeholder="Benutzername" required onkeyup="checkRegistrationUsernameAvailability()">
            <span id="username-icon" class="icon"></span>
        </div>
        <div id="username-reg-status" class="username-info"></div>

        <form id="register-form">
            <div class="form-group">
                <input type="email" id="email-reg" placeholder="E-Mail" required onkeyup="checkEmailAvailability()">
                <span id="email-icon" class="icon"></span>
            </div>
            
            
            <div class="form-group">
                <input type="password" id="password-reg" placeholder="Passwort" required onkeyup="validatePassword()">
                <span class="icon"></span> </div>
            <div id="password-requirements" class="password-validation-list">
            </div>
            
            <div class="form-group">
                <input type="password" id="confirm-password-reg" placeholder="Passwort bestätigen" required onkeyup="validatePassword()">
                <span id="match-icon" class="icon"></span>
            </div>

            <div class="terms-checkbox-group">
                <input type="checkbox" id="terms-checkbox" onchange="updateRegisterButtonState()">
                <span>Ich habe die <a href="http://example.com/agb" target="_blank">AGB</a> und die <a href="http://example.com/datenschutz" target="_blank">Datenschutzerklärung</a> gelesen und stimme diesen zu.</span>
            </div>

            <button type="submit" id="register-button" disabled>Jetzt registrieren</button>
        </form>

        <div id="message-reg" class="message"></div>
        <a href="#" onclick="showUsernameCheckView()" class="link-below-button">
            Abbrechen und Identifikation ändern
        </a>
    </div>

  </div>

  <script>
    // --- View Management & Global State ---
    const checkView = document.getElementById('username-check-view');
    const loginView = document.getElementById('login-view');
    const registerView = document.getElementById('register-view');
    
    const usernameInput = document.getElementById('username-input');
    const usernameRegInput = document.getElementById('username-reg');
    const usernameIcon = document.getElementById('username-icon');
    const emailRegInput = document.getElementById('email-reg');
    const emailIcon = document.getElementById('email-icon');
    const matchIcon = document.getElementById('match-icon');
    const usernameRegStatusDiv = document.getElementById('username-reg-status');
    const passwordRequirementsDiv = document.getElementById('password-requirements');
    const termsCheckbox = document.getElementById('terms-checkbox'); 
    const messageCheckDiv = document.getElementById('message-check');
    const messageLoginDiv = document.getElementById('message-login');
    const messageRegDiv = document.getElementById('message-reg');

    let currentIdentifier = ''; 
    let currentPassword = '';
    let isUsernameAvailable = false;
    let isEmailAvailable = false;
    let arePasswordsValid = false; 
    
    function showView(viewId) {
        checkView.style.display = 'none';
        loginView.style.display = 'none';
        registerView.style.display = 'none';
        document.getElementById(viewId).style.display = 'block';
        
        messageCheckDiv.textContent = '';
        messageLoginDiv.textContent = '';
        messageRegDiv.textContent = '';
    }

    function showUsernameCheckView() {
        showView('username-check-view');
        document.getElementById('password-login').value = '';
        document.getElementById('register-form').reset();
    }
    
    function showLoginView() {
        showView('login-view');
        document.getElementById('login-header').textContent = `Login für ${currentIdentifier}`;
    }

    function showRegisterView() {
        const checkedUsername = document.getElementById('username-input').value;
        usernameRegInput.value = checkedUsername;
        currentIdentifier = checkedUsername; 

        showView('register-view');
        document.getElementById('register-header').textContent = `Registrieren für ${currentIdentifier}`;
        
        checkRegistrationUsernameAvailability(true);
        checkEmailAvailability(true);
        validatePassword();
    }
    
    showUsernameCheckView(); 

    // --- 0. Hilfsfunktion: Button-Status aktualisieren ---
    function updateRegisterButtonState() {
        const button = document.getElementById('register-button');
        
        if (button) {
             button.disabled = !(arePasswordsValid && isUsernameAvailable && isEmailAvailable && termsCheckbox.checked);
        }
    }


    // --- 1. USERNAME CHECK FORM (Hybrider Check) ---
    document.getElementById('username-check-form').addEventListener('submit', async function(event) {
        event.preventDefault();

        currentIdentifier = usernameInput.value;
        
        const usernameRegex = /^[a-zA-Z0-9]+$/;
        
        const isEmail = currentIdentifier.includes('@');
        if (!isEmail && !usernameRegex.test(currentIdentifier)) {
             messageCheckDiv.textContent = '❌ Der Benutzername darf nur Buchstaben und Zahlen enthalten.';
             messageCheckDiv.className = 'message error';
             return; 
        }
        
        messageCheckDiv.textContent = 'Prüfe Identifikation...';
        messageCheckDiv.className = 'message';

        try {
            const response = await fetch('/auth/check-username', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: currentIdentifier }),
            });

            const data = await response.json();

            if (data.exists) {
                messageCheckDiv.textContent = '';
                showLoginView();
            } else {
                messageCheckDiv.textContent = '';
                
                usernameRegInput.value = currentIdentifier;
                
                showRegisterView();
            }

        } catch (error) {
            messageCheckDiv.textContent = '❌ Serverfehler beim Prüfen der Identifikation.';
            messageCheckDiv.className = 'message error';
            console.error('Error:', error);
        }
    });
    
    // --- 2. REGISTRIERUNG: E-MAIL VERFÜGBARKEIT SPRÜFUNG ---
    async function checkEmailAvailability() {
        const email = emailRegInput.value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        if (email.length < 5 || !emailRegex.test(email)) {
             isEmailAvailable = false;
             emailIcon.innerHTML = email.length > 0 ? '<span style="color: #FF6666;">❌</span>' : '';
             updateRegisterButtonState();
             return;
        }

        emailIcon.innerHTML = '<span style="color: lightgray;">...</span>';

        try {
            const response = await fetch('/auth/check-email-availability', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email }),
            });
            const data = await response.json();

            if (data.available) {
                isEmailAvailable = true;
                emailIcon.innerHTML = '<span style="color: #38E838;">&#10003;</span>';
            } else {
                isEmailAvailable = false;
                emailIcon.innerHTML = '<span style="color: #FF6666;">❌</span>';
            }
        } catch (error) {
            isEmailAvailable = false;
            emailIcon.innerHTML = '<span style="color: #FF6666;">!</span>';
        }
        updateRegisterButtonState();
    }


    // --- 3. REGISTRIERUNG: USERNAME VERFÜGBARKEITSPRÜFUNG ---
    async function checkRegistrationUsernameAvailability(initialLoad = false) {
        const username = usernameRegInput.value;

        const usernameRegex = /^[a-zA-Z0-9]+$/;
        if (!usernameRegex.test(username)) {
            isUsernameAvailable = false;
            usernameIcon.innerHTML = '<span style="color: #FF6666;">!</span>';
            usernameRegStatusDiv.innerHTML = '<span style="color: #FF6666;">❌ Nur Buchstaben und Zahlen erlaubt!</span>';
            updateRegisterButtonState();
            return;
        }

        if (!initialLoad && username === currentIdentifier) {
            isUsernameAvailable = true;
            usernameIcon.innerHTML = '<span style="color: #38E838;">&#10003;</span>';
            usernameRegStatusDiv.innerHTML = '';
            updateRegisterButtonState();
            return;
        }
        
        usernameIcon.innerHTML = '<span style="color: lightgray;">...</span>';
        usernameRegStatusDiv.innerHTML = '<span style="color: lightgray;">Prüfe...</span>';
        currentIdentifier = username;

        try {
            const response = await fetch('/auth/check-availability', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username }),
            });
            const data = await response.json();

            if (data.available) {
                isUsernameAvailable = true;
                usernameIcon.innerHTML = '<span style="color: #38E838;">&#10003;</span>';
                usernameRegStatusDiv.innerHTML = '';
            } else {
                isUsernameAvailable = false;
                usernameIcon.innerHTML = '<span style="color: #FF6666;">❌</span>';
                let altHtml = '<span style="color: #FF6666;">❌ Schon vergeben. Vorschläge:</span> ';
                
                data.alternatives.forEach(alt => {
                    altHtml += `<span class="alternative-link" onclick="setUsername('${alt}')">${alt}</span>`;
                });
                usernameRegStatusDiv.innerHTML = altHtml;
            }
        } catch (error) {
            isUsernameAvailable = false;
            usernameIcon.innerHTML = '<span style="color: #FF6666;">!</span>';
            usernameRegStatusDiv.innerHTML = '<span style="color: #FF6666;">Fehler bei der Prüfung.</span>';
            console.error('Error:', error);
        }
        updateRegisterButtonState();
    }
    
    function setUsername(newUsername) {
        usernameRegInput.value = newUsername;
        checkRegistrationUsernameAvailability();
    }


    // --- 4. PASSWORD VALIDATION ---
    const requirements = [
        { id: 'req-length', regex: /.{8,}/, msg: 'Mindestens 8 Zeichen' },
        { id: 'req-upper', regex: /[A-Z]/, msg: 'Mindestens 1 Großbuchstabe' },
        { id: 'req-lower', regex: /[a-z]/, msg: 'Mindestens 1 Kleinbuchstabe' },
        { id: 'req-digit', regex: /\d/, msg: 'Mindestens 1 Ziffer' },
        { id: 'req-special', regex: /[@$!%*?&]/, msg: 'Mindestens 1 Sonderzeichen' }
    ];

    const confirmPasswordField = document.getElementById('confirm-password-reg');
    const passwordField = document.getElementById('password-reg');
    
    function validatePassword() {
        if (!passwordField || !confirmPasswordField) return; 

        const password = passwordField.value;
        let allValid = true;
        let htmlContent = ''; 

        requirements.forEach(req => {
            const isValid = req.regex.test(password);
            const statusIcon = isValid ? '&#10003;' : '☐';
            const statusColor = isValid ? '#38E838' : 'lightgray';
            
            htmlContent += `<p style="color: ${statusColor};"><span class="status-icon">${statusIcon}</span> ${req.msg}</p>`;

            if (!isValid) { allValid = false; }
        });
        
        passwordRequirementsDiv.innerHTML = htmlContent;


        const passwordsMatch = password === confirmPasswordField.value && password.length > 0;
        
        arePasswordsValid = allValid && passwordsMatch; 

        if (password.length > 0 && confirmPasswordField.value.length > 0) {
            matchIcon.innerHTML = passwordsMatch ? '<span style="color: #38E838;">&#10003;</span>' : '<span style="color: #FF6666;">❌</span>';
        } else {
            matchIcon.innerHTML = '';
        }

        updateRegisterButtonState(); 
    }
    
    if(registerView.style.display === 'block') {
        validatePassword();
    }

    // --- 5. REGISTRATION SUBMISSION (Führt automatischen Login durch) ---
    document.getElementById('register-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        
        const registerButton = document.getElementById('register-button');
        if (registerButton.disabled) {
            messageRegDiv.textContent = '❌ Bitte stellen Sie sicher, dass alle Anforderungen erfüllt sind.';
            messageRegDiv.className = 'message error';
            return;
        }

        if (!isUsernameAvailable || !isEmailAvailable || !arePasswordsValid || !termsCheckbox.checked) {
            messageRegDiv.textContent = '❌ Validierungsfehler. Prüfen Sie alle Felder und akzeptieren Sie die AGB.';
            messageRegDiv.className = 'message error';
            return;
        }
        
        const email = document.getElementById('email-reg').value;
        const password = document.getElementById('password-reg').value;

        messageRegDiv.textContent = 'Registriere...';
        messageRegDiv.className = 'message';
        
        try {
            const response = await fetch('/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    username: currentIdentifier, 
                    email: email, 
                    password: password 
                }),
            });

            if (response.ok) {
                // Registrierung war erfolgreich. Jetzt automatisch einloggen.
                messageRegDiv.textContent = '✅ Registrierung erfolgreich. Logge automatisch ein...';
                
                await loginAndRedirect(currentIdentifier, password, messageRegDiv);
                
            } else {
                const data = await response.json(); 
                let detail = data.detail || 'Unbekannter Fehler';

                if (data.detail && typeof data.detail === 'string') {
                    if (data.detail.includes("value_error")) {
                         try {
                            // Versuche, die spezifische Fehlermeldung aus der Pydantic-Validierung zu extrahieren
                            detail = data.detail.split("value_error, msg='")[1].split("',")[0] || 'Validierungsfehler auf dem Server';
                         } catch (e) {
                            detail = "Passwortanforderungen nicht erfüllt.";
                         }
                    }
                } else if (Array.isArray(data.detail) && data.detail[0].msg) {
                    detail = data.detail[0].msg;
                }
                
                messageRegDiv.textContent = `❌ Fehler: ${detail}`;
                messageRegDiv.className = 'message error';
            }

        } catch (error) {
            messageRegDiv.textContent = '❌ Serverfehler bei der Registrierung (Netzwerk oder JSON-Parsing).';
            messageRegDiv.className = 'message error';
            console.error('Error:', error);
        }
    });

    // --- HILFSFUNKTION: Login und Weiterleitung (KORRIGIERT für Cookies) ---
    async function loginAndRedirect(identifier, password, messageDiv) {
        try {
            const response = await fetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ identifier: identifier, password: password }),
            });

            if (response.ok) {
                // Das Cookie wird vom Server gesetzt (HttpOnly).
                // Wir müssen hier nichts mehr im localStorage speichern.
                
                messageDiv.innerHTML = `✅ Login erfolgreich. Weiterleitung...`;
                messageDiv.className = 'message success';
                
                // KORREKTUR: Direkt zum /dashboard, nicht /app/dashboard
                window.location.href = "/dashboard"; 
                
            } else {
                let detail = 'Unbekannter Fehler';
                try {
                    const data = await response.json();
                    detail = data.detail || `Fehler-Status: ${response.status}`;
                } catch (e) {
                    detail = `Server-Fehler: ${response.status} ${response.statusText}`;
                }

                if (messageDiv.id === 'message-reg') {
                    // Auto-Login nach Registrierung ist fehlgeschlagen
                    messageDiv.innerHTML = `⚠️ Registrierung war erfolgreich, aber Auto-Login fehlgeschlagen: ${detail}. Bitte manuell einloggen.`;
                    messageDiv.className = 'message error';
                    showLoginView();
                    document.getElementById('password-login').value = password;
                } else {
                    // Manueller Login-Versuch ist fehlgeschlagen
                    messageDiv.innerHTML = `❌ ${detail}`; // z.B. "Falsche Anmeldedaten"
                    messageDiv.className = 'message error';
                }
            }

        } catch (error) {
            messageDiv.textContent = '❌ Netzwerkfehler oder Server nicht erreichbar.';
            messageDiv.className = 'message error';
            console.error('Error:', error);
        }
    }


    // --- 6. LOGIN LOGIK ---
    document.getElementById('login-form').addEventListener('submit', async function(event) {
        event.preventDefault();

        const password = document.getElementById('password-login').value;
        
        messageLoginDiv.textContent = 'Logge ein...';
        messageLoginDiv.className = 'message';
        
        await loginAndRedirect(currentIdentifier, password, messageLoginDiv);
    });


    // --- HILFSFUNKTIONEN ---
    function setUsername(newUsername) {
        usernameRegInput.value = newUsername;
        checkRegistrationUsernameAvailability();
    }
  </script>

</body>
</html>

