<!DOCTYPE html>
<html>
<head>
    <title>Lade Protokoll...</title>
    <style>
        body {
            background: linear-gradient(120deg, #1e3c72, #2a5298);
            color: white;
            text-align: center;
            padding-top: 100px;
            font-family: system-ui, sans-serif;
        }
    </style>
</head>
<body>
    <h2>Lade Spielprotokoll...</h2>
    <p>Bitte warten Sie. Der Token wird geprüft.</p>
    
    <script>
        // Game ID wird beim Klick auf "Protokoll starten" im Dashboard gesetzt
        const gameId = localStorage.getItem('protocol_game_id');
        const token = localStorage.getItem('access_token');

        if (!token || !gameId) {
            alert('Fehler: Spiel oder Login-Daten fehlen. Rückkehr zum Dashboard.');
            window.location.href = "/app/dashboard"; 
        } else {
            // Führt einen geschützten Fetch-Aufruf zur Protokollseite durch
            fetch(`/protocol/${gameId}`, {
                headers: {
                    'Authorization': `Bearer ${token}` // Fügt den Token in den Header ein
                }
            })
            .then(response => {
                if (response.ok) {
                    // Wenn der Aufruf erfolgreich ist (Code 200), lädt er den HTML-Inhalt
                    return response.text();
                } else {
                    // Bei 401/403 oder anderem Fehler
                    localStorage.removeItem('access_token');
                    alert('Sitzung abgelaufen oder ungültig. Bitte erneut einloggen.');
                    window.location.href = "/"; 
                }
            })
            .then(html => {
                // Ersetzt den gesamten HTML-Inhalt der Seite durch den Protokoll-Inhalt
                document.open();
                document.write(html);
                document.close();
            })
            .catch(error => {
                console.error('Ladefehler:', error);
                alert('Protokoll konnte nicht geladen werden. Bitte erneut versuchen.');
                window.location.href = "/app/dashboard";
            });
        }
    </script>
</body>
</html>
